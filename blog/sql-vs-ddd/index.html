<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>How DDD is screwing up your SQL</title><meta name="description" content="How DDD is screwing up your SQL"><link href="https://vb-consulting.github.io/blog/sql-vs-ddd/" rel="canonical"><meta name="keywords" content="ddd, sql, model, modeling, data, data model, relational model, domain, domain model"><meta name="author" content="floki"><meta prefix="og: http://ogp.me/ns#" property="og:title" content="How DDD is screwing up your SQL"><meta prefix="og: http://ogp.me/ns#" property="og:description" content="How DDD is screwing up your SQL"><meta prefix="og: http://ogp.me/ns#" property="og:image" content="https://vb-consulting.github.io/macka.jpg"><meta prefix="og: http://ogp.me/ns#" property="og:type" content="article"><meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="VB-Consulting"><meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://vb-consulting.github.io/blog/sql-vs-ddd/"><meta name="twitter:image" content="https://vb-consulting.github.io/macka.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:description" content="How DDD is screwing up your SQL"><link rel="stylesheet" href="/_elderjs/assets/svelte-d5812efd.css" media="all"><style></style><link href="/style.css?1714816207066" rel="stylesheet"><script>!function(){var e="theme",t=localStorage.getItem(e);t||(t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",localStorage.setItem(e,t)),document.getElementsByTagName("html")[0].dataset.bsTheme=t}();</script></head><body class="d-flex flex-column h-100"><header id="header"><nav class="navbar navbar-expand-md navbar-dark fixed-top py-0 py-md-0 svelte-30jr7w"><div class="container-fluid flex-nowrap svelte-30jr7w"><div class="d-flex svelte-30jr7w"><button id="nav-btn" type="button" class="d-flex btn btn-sm logo animate-rotate svelte-30jr7w"><i class="material-icons-outlined">menu</i></button> <a class="nav-link my-auto ms-2 fw-semibold home svelte-30jr7w" href="/"><i class="bi-chevron-double-left"></i> VB Home</a></div><div class="d-flex right svelte-30jr7w"><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Become a Patreon" href="https://www.patreon.com/vbconsulting" target="_blank"><div class="patreon"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Buy Me a Coffee" href="https://www.buymeacoffee.com/vbilopavu" target="_blank"><div class="bmc"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto me-2 svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="vb-consulting on GitHub" href="https://github.com/vb-consulting/"><i class="bi-github"></i></a> <a class="github-button svelte-30jr7w" href="https://github.com/vb-consulting/" data-bs-toggle="tooltip" data-bs-html="true" title="Star vb-consulting on GitHub" data-color-scheme="no-preference: light_high_contrast; light: light_high_contrast; dark: light_high_contrast;" data-icon="octicon-star" data-show-count="true" aria-label="Star vb-consulting on GitHub"></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><button id="theme-btn" type="button" aria-pressed="true" aria-label="theme" class="svelte-30jr7w"><span class="check hidden svelte-30jr7w"><span class="icon svelte-30jr7w"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><path fill="currentColor" d="M12 21q-3.775 0-6.388-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.625-.075.975.45t-.025 1.1q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.525-.35 1.075-.037t.475.987q-.35 3.45-2.937 5.725T12 21Zm0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19Zm-.25-6.75Z"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M0 0h24v24H0z"></path><path fill="currentColor" d="M12 19a1 1 0 0 1 .993.883L13 20v1a1 1 0 0 1-1.993.117L11 21v-1a1 1 0 0 1 1-1zm6.313-2.09l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7a1 1 0 0 1 1.218-1.567l.102.07zm-11.306.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM4 11a1 1 0 0 1 .117 1.993L4 13H3a1 1 0 0 1-.117-1.993L3 11h1zm17 0a1 1 0 0 1 .117 1.993L21 13h-1a1 1 0 0 1-.117-1.993L20 11h1zM6.213 4.81l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7A1 1 0 0 1 6.11 4.74l.102.07zm12.894.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM12 2a1 1 0 0 1 .993.883L13 3v1a1 1 0 0 1-1.993.117L11 4V3a1 1 0 0 1 1-1zm0 5a5 5 0 1 1-4.995 5.217L7 12l.005-.217A5 5 0 0 1 12 7z"></path></g></svg></span></span></button></div></div></nav></header><main class="svelte-9zwk14"><div class="sidebar sidebar-hide svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-item svelte-9zwk14" data-id="" title="VB-Consulting"><a class="nav-link svelte-9zwk14 text-uppercase" href="/">VB-Consulting</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="NpgsqlRest"><a class="nav-link svelte-9zwk14 text-uppercase" href="/npgsqlrest/">NpgsqlRest</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="Norm.Net"><a class="nav-link svelte-9zwk14 text-uppercase" href="/norm.net/">Norm.Net</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="RazorSvelte"><a class="nav-link svelte-9zwk14 text-uppercase" href="/razorsvelte/">RazorSvelte</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PgRoutiner"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pgroutiner/">PgRoutiner</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="XUnit.Npgsql"><a class="nav-link svelte-9zwk14 text-uppercase" href="/xunit.npgsql/">XUnit.Npgsql</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PostrgeSQL Schema Tools"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pg_schema_tools/">PostrgeSQL Schema Tools</a></li><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">blogs</span><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="See all blogs..."><a class="nav-link btn btn-sm w-fit px-3 mx-auto svelte-9zwk14 lr-arrow text-uppercase" href="/blogs/"><i class="bi bi-arrow-right-circle svelte-9zwk14"></i> <span class="btn-link">ALL BLOGS</span></a></li><li class="nav-item svelte-9zwk14" data-id="" title="Transaction Script DDD vs SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/transaction-script/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Transaction Script DDD vs SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Common Sense Software Design Approach for RDBMS-backed Type of Software"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/common-sense-design/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Common Sense Software Design</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-v2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest v2 Update üêòüî•</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-update1.6.2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest Update 1.6.2</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL Array Example"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-array/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Arrays üêò</a></li><li class="nav-item svelte-9zwk14 active" data-id="" title="How DDD is screwing up your SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/sql-vs-ddd/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>How DDD is screwing up your SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL Paging Benchmarks"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-paging/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Paging Benchmarks</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest NuGet Library</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL crazy experiment with the record type."><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-record-type/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Execute Custom Function For Each Record</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL script that implements temporal tables without extension."><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-temporal-tables/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Custom Temporal Tables in PostgreSQL</a></li></ul></div></div><div class="content svelte-9zwk14"><div class="banner svelte-1bxfgrx" style="background-image: url(/macka.jpg); background-position: center; background-blend-mode: luminosity;"></div><div class="container-sm main-content blog svelte-1bxfgrx bannered"><div class="blog-head svelte-1bxfgrx"><a href="https://github.com/vb-consulting/blog/blob/master/LICENSE" class="text-shadow svelte-1bxfgrx" style="color: white">CC0-1.0 license</a></div><div class="categories svelte-1bxfgrx"><a href="/blogs/general" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># general</span> </a><a href="/blogs/software-development" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># software development</span> </a><a href="/blogs/sql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># sql</span> </a><a href="/blogs/ddd" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># ddd</span></a></div><h1 class="text-shadow" id="how-ddd-is-screwing-up-your-sql">How DDD is screwing up your SQL</h1><div class="post-meta text-shadow"><div></div><div class="post-details"><div class="post-pic" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog." style="background-image: url(/floki2.jpg)"></div><div class="post-details-right"><div class="post-share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Fsql-vs-ddd%2F" class="me-1 bi-linkedin" data-bs-toggle="tooltip" data-bs-html="true" title="Share on LinkedIn"><i class=""></i></a> <a href="http://twitter.com/share?text=How%20DDD%20is%20screwing%20up%20your%20SQL%0AHow%20DDD%20is%20screwing%20up%20your%20SQL%0A&url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Fsql-vs-ddd%2F&hashtags=software%20development%2Csql%2Cddd" class="me-1 bi-twitter-x" data-bs-toggle="tooltip" data-bs-html="true" title="Share on X"><i class=""></i></a> <a href="#" class="copy-url bi-clipboard" data-bs-toggle="tooltip" data-bs-html="true" title="Copy URL"><i class=""></i></a></div><div class="post-author">floki</div><div class="post-date">Mar 20, 2024</div></div></div></div><p>This morning, I came across an interesting article about DDD and SQL on the internet named <a href="https://blog.nimblepros.com/blogs/ddd-vs-sql/">How SQL is screwing up your DDD</a>. Normally I would post this article on my LinkedIn page with my own thoughts, but the subject matter is way too interesting, so, I'll just make my own blogpost.</p><p>The main premise of the article is an exercise, a code kata, in data modeling. Quote:</p><blockquote><p>The goal is to model a collection of value object items, where the collection maintains a ‚Äúdefault‚Äù item. It forces you to consider things like</p></blockquote><blockquote><p>How do you handle selecting which item is the default? How do you avoid the possibility of the collection ending up with no default item? How do you handle the case where the default item is removed from the collection? How do you avoid the possibility of the collection having no items at all?</p></blockquote><p>A hypothetical example given is the <code>Customer</code> entity, which possesses a collection of <code>Address</code>.</p><p>It appears that the ideal domain model in a domain-driven world for this problem would be something like this:</p><div class="code csharp"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Address</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Id</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">string</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Street</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">string</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">City</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">CustomerId</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Customer</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Customer</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Customer</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Id</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">readonly</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">> </span><span style="color: #9CDCFE">_addresses</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">new</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">>();</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">IEnumerable</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">> </span><span style="color: #9CDCFE">Addresses</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=></span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">_addresses</span><span style="color: #E6E6E6">.</span><span style="color: #DCDCAA">AsEnumerable</span><span style="color: #E6E6E6">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">DefaultAddress</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">Id</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">string</span><span style="color: #000000"> </span><span style="color: #001080">Street</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">string</span><span style="color: #000000"> </span><span style="color: #001080">City</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">CustomerId</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">Customer</span><span style="color: #000000"> </span><span style="color: #001080">Customer</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">Customer</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">Id</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">readonly</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">> </span><span style="color: #001080">_addresses</span><span style="color: #000000"> = </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">>();</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">IEnumerable</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">> </span><span style="color: #001080">Addresses</span><span style="color: #000000"> => </span><span style="color: #001080">_addresses</span><span style="color: #000000">.</span><span style="color: #795E26">AsEnumerable</span><span style="color: #000000">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span><span style="color: #000000"> </span><span style="color: #001080">DefaultAddress</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #000000">}</span></span></code></pre></div><p>However, the article then proceeds to discuss persistence (to the database) and, because of that fact this solution is somehow "problematic", and just because of the persistence and databases, a completely different model is then needed:</p><div class="code csharp"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6"> : </span><span style="color: #4EC9B0">ValueObject</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">string</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Street</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">string</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">City</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">    // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">CustomerAddress</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Id</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Details</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">CustomerId</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Customer</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Customer</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Customer</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Id</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">readonly</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">CustomerAddress</span><span style="color: #E6E6E6">> </span><span style="color: #9CDCFE">_addresses</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">new</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">CustomerAddress</span><span style="color: #E6E6E6">>();</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">IEnumerable</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">CustomerAddress</span><span style="color: #E6E6E6">> </span><span style="color: #9CDCFE">Addresses</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=></span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">_addresses</span><span style="color: #E6E6E6">.</span><span style="color: #DCDCAA">AsEnumerable</span><span style="color: #E6E6E6">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">  // This is owned type, not a navigation.</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">DefaultAddress</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; } </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Address</span><span style="color: #E6E6E6">.</span><span style="color: #9CDCFE">Empty</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span><span style="color: #000000"> : </span><span style="color: #267F99">ValueObject</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">string</span><span style="color: #000000"> </span><span style="color: #001080">Street</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">string</span><span style="color: #000000"> </span><span style="color: #001080">City</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">    // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">CustomerAddress</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">Id</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span><span style="color: #000000"> </span><span style="color: #001080">Details</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">CustomerId</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">Customer</span><span style="color: #000000"> </span><span style="color: #001080">Customer</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">Customer</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">Id</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">readonly</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">CustomerAddress</span><span style="color: #000000">> </span><span style="color: #001080">_addresses</span><span style="color: #000000"> = </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">CustomerAddress</span><span style="color: #000000">>();</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">IEnumerable</span><span style="color: #000000">&lt;</span><span style="color: #267F99">CustomerAddress</span><span style="color: #000000">> </span><span style="color: #001080">Addresses</span><span style="color: #000000"> => </span><span style="color: #001080">_addresses</span><span style="color: #000000">.</span><span style="color: #795E26">AsEnumerable</span><span style="color: #000000">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">  // This is owned type, not a navigation.</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span><span style="color: #000000"> </span><span style="color: #001080">DefaultAddress</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; } = </span><span style="color: #001080">Address</span><span style="color: #000000">.</span><span style="color: #001080">Empty</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #000000">}</span></span></code></pre></div><p>Quote:</p><blockquote><p>The solution is to create a wrapping entity class around the value object item that would link the items of the collection, to the collection. Why do we need that extra layer? I‚Äôll tell you why: Relational databases.</p></blockquote><p>That extra layer is, actually, a classic <a href="https://learn.microsoft.com/en-us/ef/core/modeling/relationships/many-to-many">many-to-many relationship</a>, which is a way of saying that any number of customers can have any number of addresses and vice-versa. As we can see Entity Framework ORM supports that type of modeling with that extra layer, but newer versions even support omitting that "extra layer" without navigation, by simply defining something like this:</p><div class="code csharp"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Address</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #6A9955">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Customer</span><span style="color: #E6E6E6">> </span><span style="color: #9CDCFE">Customers</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; } </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [];</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Customer</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #6A9955">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">> </span><span style="color: #9CDCFE">Addresses</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; } </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [];</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">protected</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">override</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">void</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">OnModelCreating</span><span style="color: #E6E6E6">(</span><span style="color: #4EC9B0">ModelBuilder</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">modelBuilder</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #9CDCFE">modelBuilder</span><span style="color: #E6E6E6">.</span><span style="color: #DCDCAA">Entity</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Customer</span><span style="color: #E6E6E6">>()</span></span>
<span class="line"><span style="color: #E6E6E6">        .</span><span style="color: #DCDCAA">HasMany</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">e</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=></span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">e</span><span style="color: #E6E6E6">.</span><span style="color: #9CDCFE">Addresses</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        .</span><span style="color: #DCDCAA">WithMany</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">e</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=></span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">e</span><span style="color: #E6E6E6">.</span><span style="color: #9CDCFE">Customers</span><span style="color: #E6E6E6">);</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #008000">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Customer</span><span style="color: #000000">> </span><span style="color: #001080">Customers</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; } = [];</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">Customer</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #008000">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">> </span><span style="color: #001080">Addresses</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; } = [];</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">protected</span><span style="color: #000000"> </span><span style="color: #0000FF">override</span><span style="color: #000000"> </span><span style="color: #0000FF">void</span><span style="color: #000000"> </span><span style="color: #795E26">OnModelCreating</span><span style="color: #000000">(</span><span style="color: #267F99">ModelBuilder</span><span style="color: #000000"> </span><span style="color: #001080">modelBuilder</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">modelBuilder</span><span style="color: #000000">.</span><span style="color: #795E26">Entity</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Customer</span><span style="color: #000000">>()</span></span>
<span class="line"><span style="color: #000000">        .</span><span style="color: #795E26">HasMany</span><span style="color: #000000">(</span><span style="color: #001080">e</span><span style="color: #000000"> => </span><span style="color: #001080">e</span><span style="color: #000000">.</span><span style="color: #001080">Addresses</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">        .</span><span style="color: #795E26">WithMany</span><span style="color: #000000">(</span><span style="color: #001080">e</span><span style="color: #000000"> => </span><span style="color: #001080">e</span><span style="color: #000000">.</span><span style="color: #001080">Customers</span><span style="color: #000000">);</span></span>
<span class="line"><span style="color: #000000">}</span></span></code></pre></div><p>That "extra layer" is sometimes referred to as the "junction table" or "navigation table", and is what many DDD proponents consider to be a part of the so-called "impedance mismatch", meaning, it is not part of the "domain model" in any shape or form, and it is part of the "persistence to database". The database thing, if you will, and as such shouldn't be present in a domain model and it's not part of domain modeling.</p><p>The article then continues to express disgust with that "extra layer":</p><blockquote><p>But a part of me can‚Äôt help being a little ‚Äúgrossed‚Äù out by this.</p></blockquote><p>Because "Within the DDD corpus, you are generally encouraged to <strong>think about the domain first</strong>..." and that "extra layer" thing is, obviously, a part of "persistence" and "the ideal DDD model, in code, is quite different than the ideal relational database model".</p><p>The article then finishes with the following questions:</p><blockquote><p>Are we forever doomed to bastardize our nice, simple, DDD models, just so we can persist them in relational databases?</p></blockquote><p>Are we?</p><p>Is that "extra layer" really necessary? Does it really, mess up the domain purity?</p><p>Let's discuss.</p><h2 id="domain-model">Domain Model</h2><p>Let's assume this is the ideal domain model as the article suggests (no "extra layers"):</p><div class="code csharp"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Address</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Id</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">string</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Street</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">string</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">City</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">CustomerId</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Customer</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Customer</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Customer</span></span>
<span class="line"><span style="color: #E6E6E6">{</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Id</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">readonly</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">> </span><span style="color: #9CDCFE">_addresses</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">new</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">>();</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">IEnumerable</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">> </span><span style="color: #9CDCFE">Addresses</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=></span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">_addresses</span><span style="color: #E6E6E6">.</span><span style="color: #DCDCAA">AsEnumerable</span><span style="color: #E6E6E6">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">DefaultAddress</span><span style="color: #E6E6E6"> { </span><span style="color: #569CD6">get</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">Id</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">string</span><span style="color: #000000"> </span><span style="color: #001080">Street</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">string</span><span style="color: #000000"> </span><span style="color: #001080">City</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">CustomerId</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">Customer</span><span style="color: #000000"> </span><span style="color: #001080">Customer</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">Customer</span></span>
<span class="line"><span style="color: #000000">{</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">Id</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">readonly</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">> </span><span style="color: #001080">_addresses</span><span style="color: #000000"> = </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">>();</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">IEnumerable</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">> </span><span style="color: #001080">Addresses</span><span style="color: #000000"> => </span><span style="color: #001080">_addresses</span><span style="color: #000000">.</span><span style="color: #795E26">AsEnumerable</span><span style="color: #000000">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span><span style="color: #000000"> </span><span style="color: #001080">DefaultAddress</span><span style="color: #000000"> { </span><span style="color: #0000FF">get</span><span style="color: #000000">; </span><span style="color: #0000FF">set</span><span style="color: #000000">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">  // Other properties and methods omitted for brevity</span></span>
<span class="line"><span style="color: #000000">}</span></span></code></pre></div><p>One of the requirements states:</p><blockquote><p><strong>How do you handle the case where the default item is removed from the collection?</strong></p></blockquote><p>The core assumption here is in this model, it should <strong>be impossible to remove the address</strong> from the customer address collection - if that address is referenced as the default address in that customer.</p><p>Why do we want to do that?</p><p>Well, obviously, that would consist of an <strong>illogical state of the model</strong>, and thus our model would be <strong>invalid</strong> (it supports illogical states). So, want to prevent that.</p><p>Fine, but the next question: what is really our collection of addresses here:</p><div class="code csharp"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">private</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">readonly</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">> </span><span style="color: #9CDCFE">_addresses</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">new</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">>();</span></span>
<span class="line"><span style="color: #569CD6">public</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">IEnumerable</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">Address</span><span style="color: #D4D4D4">></span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">Addresses</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=></span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">_addresses</span><span style="color: #E6E6E6">.</span><span style="color: #DCDCAA">AsEnumerable</span><span style="color: #E6E6E6">();</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">readonly</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">> </span><span style="color: #001080">_addresses</span><span style="color: #000000"> = </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">>();</span></span>
<span class="line"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #001080">IEnumerable</span><span style="color: #000000">&lt;</span><span style="color: #001080">Address</span><span style="color: #000000">> </span><span style="color: #001080">Addresses</span><span style="color: #000000"> => </span><span style="color: #001080">_addresses</span><span style="color: #000000">.</span><span style="color: #795E26">AsEnumerable</span><span style="color: #000000">();</span></span></code></pre></div><p>It's a generic list, obviously. What is the generic list? It's a <strong>basic memory structure.</strong></p><p>This list, however, is exposed as enumerable which supports only iterations, but if we know its actual implementation is a list - we can still cast it as a list and remove any item we want.</p><p>Let's remove the default address:</p><div class="code csharp"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">defaultAddr</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">customer</span><span style="color: #E6E6E6">.</span><span style="color: #9CDCFE">Addresses</span><span style="color: #E6E6E6">.</span><span style="color: #DCDCAA">Single</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=></span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">customer</span><span style="color: #E6E6E6">.</span><span style="color: #9CDCFE">DefaultAddress</span><span style="color: #E6E6E6">.</span><span style="color: #9CDCFE">Id</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">.</span><span style="color: #9CDCFE">Id</span><span style="color: #E6E6E6">);</span></span>
<span class="line"><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">customer</span><span style="color: #E6E6E6">.</span><span style="color: #9CDCFE">Addresses</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">List</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Address</span><span style="color: #E6E6E6">>).</span><span style="color: #DCDCAA">Remove</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">defaultAddr</span><span style="color: #E6E6E6">);</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">var</span><span style="color: #000000"> </span><span style="color: #001080">defaultAddr</span><span style="color: #000000"> = </span><span style="color: #001080">customer</span><span style="color: #000000">.</span><span style="color: #001080">Addresses</span><span style="color: #000000">.</span><span style="color: #795E26">Single</span><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000"> => </span><span style="color: #001080">customer</span><span style="color: #000000">.</span><span style="color: #001080">DefaultAddress</span><span style="color: #000000">.</span><span style="color: #001080">Id</span><span style="color: #000000"> == </span><span style="color: #001080">a</span><span style="color: #000000">.</span><span style="color: #001080">Id</span><span style="color: #000000">);</span></span>
<span class="line"><span style="color: #000000">(</span><span style="color: #001080">customer</span><span style="color: #000000">.</span><span style="color: #001080">Addresses</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #267F99">List</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">>).</span><span style="color: #795E26">Remove</span><span style="color: #000000">(</span><span style="color: #001080">defaultAddr</span><span style="color: #000000">);</span></span></code></pre></div><p>In this case, nothing happens. We safely removed the address with the same ID as the default address, and the default address doesn't exist in the collection. But, the default address is still there because they are different memory object instances.</p><p>So, our domain model, which is basically just a <strong>memory data model</strong> - doesn't give us any guarantees against illogical states.</p><p>Let's take a closer look the the relational model now.</p><h2 id="relational-model">Relational Model</h2><p>This is the relational model for the example above. Once the data model is understood it takes less than a few minutes to write it up.</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">begin</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">addresses</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    address_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">generated</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">always</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">identity</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    street </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    city </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">customers</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    customer_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">generated</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">always</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">identity</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    address_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> addresses</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">customer_addresses</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    customer_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> customers,</span></span>
<span class="line"><span style="color: #E6E6E6">    address_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> addresses,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6"> (customer_id, address_id)</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> customers </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">constraint</span><span style="color: #E6E6E6"> fk_customer_addresses</span></span>
<span class="line"><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (customer_id, address_id) </span></span>
<span class="line"><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> customer_addresses;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">begin</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">addresses</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    address_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">generated</span><span style="color: #000000"> </span><span style="color: #0000FF">always</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">identity</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    street </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    city </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">customers</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    customer_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">generated</span><span style="color: #000000"> </span><span style="color: #0000FF">always</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">identity</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    address_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">references</span><span style="color: #000000"> addresses</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">customer_addresses</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    customer_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">references</span><span style="color: #000000"> customers,</span></span>
<span class="line"><span style="color: #000000">    address_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">references</span><span style="color: #000000"> addresses,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">primary key</span><span style="color: #000000"> (customer_id, address_id)</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> customers </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">constraint</span><span style="color: #000000"> fk_customer_addresses</span></span>
<span class="line"><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (customer_id, address_id) </span></span>
<span class="line"><span style="color: #0000FF">references</span><span style="color: #000000"> customer_addresses;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span></code></pre></div><p>What we see here is this:</p><ul><li>Table with addresses.</li><li>Table with customers. References address as the default address.</li><li>Reference table between customers and addresses.</li><li>Many customers can have many addresses.</li><li>A customer must have unique addresses (primary key).</li><li>The default customer address must be one of the customer addresses (composite foreign key).</li></ul><p>What we don't see here is this:</p><ul><li>Files.</li><li>Directories.</li><li>Persistence.</li></ul><p>The previous domain model was explicitly a memory model. It used explicitly <strong>memory device structures and concepts</strong> such as <strong>lists</strong> and <strong>objects</strong> . They don't have anything to do with the domain either.</p><p>And, finally, this relational model gives us guarantees that this data model will not have illogical states under any circumstances:</p><ul><li>The default address must exist and must be one of the customer addresses.</li><li>Any attempt to remove an address from a customer which is the default address will be stopped in the tracks. It's impossible.</li><li>The illogical states are not permitted and data integrity is preserved. Forever. Deal with it.</li></ul><p>So this relational model actually our real domain model?</p><p>By the definition of <a href="https://en.wikipedia.org/wiki/Domain_model">Wikipedia</a> - in software engineering, a domain model is a <strong>conceptual model</strong> of the domain that <strong>incorporates both behavior and data</strong>.</p><p>This is no doubt a conceptual model, but it doesn't have any behavior. Not yet anyway, we will just have to add some.</p><p>Now first, the conceptual model, and this is undoubtedly a conceptual model - is by its nature a general-purpose model. It's just a <strong>concept of reality adopted for the computer representation</strong>. To add some behavior we will need some use cases - how we are going to use this model for example. This, of course, can be anything, from the reporting to displaying it on the user interface and filling up the forms for example.</p><p>But, for the purpose of this article, I will assume that the use case is to transform (project) into the ideal domain model <a href="#domain-model">described above</a> and in the referenced article. And that's a big assumption, use cases aren't anything like that. In any case:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #6A9955">--</span></span>
<span class="line"><span style="color: #6A9955">-- Returns a set of customers. Usage:</span></span>
<span class="line"><span style="color: #6A9955">-- select get_customers(1) - returns customer id=1</span></span>
<span class="line"><span style="color: #6A9955">-- select get_customers(null) - returns all customers</span></span>
<span class="line"><span style="color: #6A9955">--</span></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">get_customers</span><span style="color: #E6E6E6">(_customer_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> setof record</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> $$</span></span>
<span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    customer_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    address_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> default_address_id,</span></span>
<span class="line"><span style="color: #E6E6E6">    street </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> default_street,</span></span>
<span class="line"><span style="color: #E6E6E6">    city </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> default_city</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    customers</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">join</span><span style="color: #E6E6E6"> addresses </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> (address_id)</span></span>
<span class="line"><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    _customer_id </span><span style="color: #569CD6">is</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> customer_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _customer_id</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">--</span></span>
<span class="line"><span style="color: #6A9955">-- Returns a set of adresses for the customer. Usage:</span></span>
<span class="line"><span style="color: #6A9955">-- select get_customer_addresses(1) - returns adresses customer id=10</span></span>
<span class="line"><span style="color: #6A9955">--</span></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">get_customer_addresses</span><span style="color: #E6E6E6">(_customer_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> setof record</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> $$</span></span>
<span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    addresses.address_id,</span></span>
<span class="line"><span style="color: #E6E6E6">    street,</span></span>
<span class="line"><span style="color: #E6E6E6">    city,</span></span>
<span class="line"><span style="color: #E6E6E6">    customers.customer_id </span><span style="color: #569CD6">is not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> is_default</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    addresses</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">join</span><span style="color: #E6E6E6"> customer_addresses </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> (address_id)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">left join</span><span style="color: #E6E6E6"> customers </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> (address_id, customer_id)</span></span>
<span class="line"><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    customer_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _customer_id</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">--</span></span>
<span class="line"><span style="color: #6A9955">-- Returns json with all customers, all adresses and the customwer default address. Usage:</span></span>
<span class="line"><span style="color: #6A9955">-- select get_all_customers_json()</span></span>
<span class="line"><span style="color: #6A9955">--</span></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">get_all_customers_json</span><span style="color: #E6E6E6">()</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">json</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> $$</span></span>
<span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">coalesce</span><span style="color: #E6E6E6">(json_agg(sub), </span><span style="color: #CE9178">'[]'</span><span style="color: #E6E6E6">::</span><span style="color: #569CD6">json</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        c.customer_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class="line"><span style="color: #E6E6E6">        c.name,</span></span>
<span class="line"><span style="color: #E6E6E6">        json_build_object(</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #CE9178">'id'</span><span style="color: #E6E6E6">, def.address_id,</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #CE9178">'street'</span><span style="color: #E6E6E6">, def.street,</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #CE9178">'city'</span><span style="color: #E6E6E6">, def.city</span></span>
<span class="line"><span style="color: #E6E6E6">        ) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> default_address,</span></span>
<span class="line"><span style="color: #E6E6E6">        json_agg(addr.</span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6">) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> addresses</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        example.customers c</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">join</span><span style="color: #E6E6E6"> example.addresses def </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> (address_id)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">left join</span><span style="color: #E6E6E6"> example.customer_addresses ca </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> (customer_id)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">left join</span><span style="color: #E6E6E6"> example.addresses addr </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> ca.address_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> addr.address_id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">group by</span></span>
<span class="line"><span style="color: #E6E6E6">        c.customer_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        c.name,</span></span>
<span class="line"><span style="color: #E6E6E6">        def.address_id</span></span>
<span class="line"><span style="color: #E6E6E6">) sub</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #008000">--</span></span>
<span class="line"><span style="color: #008000">-- Returns a set of customers. Usage:</span></span>
<span class="line"><span style="color: #008000">-- select get_customers(1) - returns customer id=1</span></span>
<span class="line"><span style="color: #008000">-- select get_customers(null) - returns all customers</span></span>
<span class="line"><span style="color: #008000">--</span></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">get_customers</span><span style="color: #000000">(_customer_id </span><span style="color: #0000FF">int</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> setof record</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> $$</span></span>
<span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    customer_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    address_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> default_address_id,</span></span>
<span class="line"><span style="color: #000000">    street </span><span style="color: #0000FF">as</span><span style="color: #000000"> default_street,</span></span>
<span class="line"><span style="color: #000000">    city </span><span style="color: #0000FF">as</span><span style="color: #000000"> default_city</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    customers</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">join</span><span style="color: #000000"> addresses </span><span style="color: #0000FF">using</span><span style="color: #000000"> (address_id)</span></span>
<span class="line"><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    _customer_id </span><span style="color: #0000FF">is</span><span style="color: #000000"> </span><span style="color: #0000FF">null</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> customer_id = _customer_id</span></span>
<span class="line"><span style="color: #000000">$$;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">--</span></span>
<span class="line"><span style="color: #008000">-- Returns a set of adresses for the customer. Usage:</span></span>
<span class="line"><span style="color: #008000">-- select get_customer_addresses(1) - returns adresses customer id=10</span></span>
<span class="line"><span style="color: #008000">--</span></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">get_customer_addresses</span><span style="color: #000000">(_customer_id </span><span style="color: #0000FF">int</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> setof record</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> $$</span></span>
<span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    addresses.address_id,</span></span>
<span class="line"><span style="color: #000000">    street,</span></span>
<span class="line"><span style="color: #000000">    city,</span></span>
<span class="line"><span style="color: #000000">    customers.customer_id </span><span style="color: #0000FF">is not null</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> is_default</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    addresses</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">join</span><span style="color: #000000"> customer_addresses </span><span style="color: #0000FF">using</span><span style="color: #000000"> (address_id)</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">left join</span><span style="color: #000000"> customers </span><span style="color: #0000FF">using</span><span style="color: #000000"> (address_id, customer_id)</span></span>
<span class="line"><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    customer_id = _customer_id</span></span>
<span class="line"><span style="color: #000000">$$;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">--</span></span>
<span class="line"><span style="color: #008000">-- Returns json with all customers, all adresses and the customwer default address. Usage:</span></span>
<span class="line"><span style="color: #008000">-- select get_all_customers_json()</span></span>
<span class="line"><span style="color: #008000">--</span></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">get_all_customers_json</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">json</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> $$</span></span>
<span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #795E26">coalesce</span><span style="color: #000000">(json_agg(sub), </span><span style="color: #A31515">'[]'</span><span style="color: #000000">::</span><span style="color: #0000FF">json</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        c.customer_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class="line"><span style="color: #000000">        c.name,</span></span>
<span class="line"><span style="color: #000000">        json_build_object(</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #A31515">'id'</span><span style="color: #000000">, def.address_id,</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #A31515">'street'</span><span style="color: #000000">, def.street,</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #A31515">'city'</span><span style="color: #000000">, def.city</span></span>
<span class="line"><span style="color: #000000">        ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> default_address,</span></span>
<span class="line"><span style="color: #000000">        json_agg(addr.*) </span><span style="color: #0000FF">as</span><span style="color: #000000"> addresses</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        example.customers c</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">join</span><span style="color: #000000"> example.addresses def </span><span style="color: #0000FF">using</span><span style="color: #000000"> (address_id)</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">left join</span><span style="color: #000000"> example.customer_addresses ca </span><span style="color: #0000FF">using</span><span style="color: #000000"> (customer_id)</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">left join</span><span style="color: #000000"> example.addresses addr </span><span style="color: #0000FF">on</span><span style="color: #000000"> ca.address_id = addr.address_id</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">group by</span></span>
<span class="line"><span style="color: #000000">        c.customer_id,</span></span>
<span class="line"><span style="color: #000000">        c.name,</span></span>
<span class="line"><span style="color: #000000">        def.address_id</span></span>
<span class="line"><span style="color: #000000">) sub</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>Alright, that's a lot of behavior. Note that the last function <code>get_all_customers_json</code> returns the JSON with exactly the same ideal domain model <a href="#domain-model">described above</a> and in the referenced article.</p><p>So, now, if we have:</p><ul><li>Enforced data model integrity, the meaning we can't have illogical states.</li><li>The desired behavior is implemented and tested.</li></ul><p>I have some questions now:</p><ul><li>Is our relational model, actually, our real domain model?</li><li>I know that is not Object-oriented. But, does it have to be?</li><li>Is the object orientation among our requirements? Has it ever been?</li><li>Do users care about the object orientation?</li></ul><p>Object-oriented is a good technique, but is one that is limited to computer memory only. SQL isn't. In fact, SQL is a higher data language that abstracts devices such as persistence devices and even computer memory. No such thing as files, devices, directories, memory, heap or stack. None of that. All that is left is your model and your logic. And a few indexes too, but nothing is perfect.</p><p>My main question is, do we need a use case functionality that actually maps to another model in memory?</p><h2 id="conclusion">Conclusion</h2><p>What we call the relational model, DDD people usually refer as to the database model. But in fact, it is a <strong>conceptual model of reality as the logical model</strong> - adapted for <strong>database representation.</strong></p><p>What DDD people call the domain model, is, in my opinion, the same thing but with one important difference: a <strong>conceptual model of reality as the logical model</strong> - adapted for the <strong>memory representation.</strong></p><p>Modern software design tries to model both - create both models and then map the first to the other in an effort to solve all problems with the object-oriented approach. That is the root of all problems. Either don't use RDBMS or use RDBMS and stop trying to solve problems with the Object-Oriented approach.</p><p>On the other hand, most of modern web applications are, what call - the <strong>data-intense applications.</strong></p><p>They don't actually solve any complicated problems per se. Well I guess, some of them do, but most of them deal with a lot of data in a relatively simple manner: show data on the grid, page through the grid, paint the dashboard, show some charts, fill up some forms, show data in different ways, etc.</p><p>Inserting another model between the relational model (which is needed to enforce some rules and integrity, as we have seen in this example) makes software development much harder than it realistically should be.</p><p>It took just a few minutes to create that relational model described above, and then an additional 5 to 10 minutes to add some behavior in the form of projections from the relational model (SQL functions) to get the results I want, or rather, that application needs. And I am an average SQL developer (who likes to blog apparently).</p><p>Just learn modern SQL. That is all.</p><div class="w-fit mx-auto mt-5 mb-3 border-top"><div class="alert text-center fs-smaller text-muted">To receive notifications about new posts and updates, consider subscribing to my LinkdIn page:<br><a class="btn btn-sm" href="https://www.linkedin.com/in/vb-software/"><i class="bi-linkedin"></i> <span class="text-primary">vb-software linkedin</span></a><br><br>You will receive notifications about new posts on your LinkedIn feed.</div></div><div class="pt-5 border-top"><div id="comments-section" class="h5">Comments</div><script defer src="https://cdn.commento.io/js/commento.js" data-no-fonts="true" data-css-override="https://vb-consulting.github.io/style.css"></script><div id="commento"></div></div><footer class="mt-3 py-5"><div class="w-fit mx-auto mb-3 border-top border-bottom"><div class="alert text-center fs-smaller text-muted"><div class="alert text-center fs-smaller text-muted mb-1">If you like my content, use my software, or otherwise benefit from my work, consider supporting me by buying me a coffee. The software runs on coffee after all.</div><a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="Click Here to Buy Me a Coffee Or Scan the Code" href="https://www.buymeacoffee.com/vbilopavu" style="display: inline-grid;">Buy me a Coffee <img class="m-auto svelte-byttq0" alt="Scan Here To Buy Me a Cofee" src="/bmc_qr.png"></a></div></div><div class="d-flex justify-content-center"><a class="btn rl-arrow me-1" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="vb-consulting on GitHub" href="https://github.com/vb-consulting/" style="display: inline-grid;">vb-consulting on GitHub <i class="bi bi-github"></i></a> <a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="I Post Software Development Content Daily" href="https://www.linkedin.com/in/vb-software/" style="display: inline-grid;">Follow me on LinkedIn <i class="bi bi-linkedin"></i></a></div><div class="text-center"><div class="mt-5 mb-5 background-floki svelte-byttq0" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog."></div></div></footer><div class="mb-5"></div></div></div><div class="rightside svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">on this page</span><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="how-ddd-is-screwing-up-your-sql" title="How DDD is screwing up your SQL"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#how-ddd-is-screwing-up-your-sql">How DDD is screwing up your SQL</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="domain-model" title="Domain Model"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#domain-model">Domain Model</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="relational-model" title="Relational Model"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#relational-model">Relational Model</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="conclusion" title="Conclusion"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#conclusion">Conclusion</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="comments-section" title="Comments"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#comments-section">Comments</a></li></ul></div></div></main><script>!function(){var i=document.querySelector("nav.navbar"),f=document.getElementsByTagName("main")[0],L=f.getElementsByClassName("sidebar")[0],w=f.getElementsByClassName("content")[0],o=document.querySelectorAll("div.code"),k=i.querySelector(".home");function E(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n])}function T(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n]);E(e,t),e.classList.add(t)}function t(e,t){var n=e.currentTarget;if(!n.classList.contains("bi-check")){for(var i="",o=0;o<n.classList.length;o++)if(n.classList[o].startsWith("bi-")){i=n.classList[o];break}n.classList.remove(i),n.classList.add("spinner-border-sm"),n.classList.add("spinner-border");e=bootstrap.Tooltip.getInstance(n);e&&(e.setContent({".tooltip-inner":"Copying..."}),e.show()),t(n,function(){var e;n.classList.remove(i),n.classList.remove("spinner-border-sm"),n.classList.remove("spinner-border"),n.classList.add("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&(e.setContent({".tooltip-inner":"Copied!"}),e.show()),setTimeout(function(){var e;n.classList.add(i),n.classList.remove("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&e.setContent({".tooltip-inner":n.dataset.bsTitle})},2e3)})}}"/"==document.location.pathname&&T(k,"d-none");var e=document.querySelector(".post-share > .copy-url"),n=(e&&e.addEventListener("click",function(e){t(e,function(e,t){navigator.clipboard.writeText(document.location.origin+document.location.pathname),t()})}),document.getElementsByTagName("html")[0]),a=i.querySelector("#theme-btn"),s="theme";function l(e){var t=a.getElementsByTagName("svg");"dark"===e?(t[0].style.display="",t[1].style.display="none",a.getElementsByClassName("check")[0].classList.add("checked")):(t[0].style.display="none",t[1].style.display="",a.getElementsByClassName("check")[0].classList.remove("checked"));for(var n=0;n<o.length;n++){var i=o[n];"dark"===e?(i.children[1].style.display="inherit",i.children[2].style.display="none"):"light"===e&&(i.children[1].style.display="none",i.children[2].style.display="inherit")}window._theme&&window._theme(e)}function r(e){t(e,function(e,t){navigator.clipboard.writeText(e.parentElement.nextSibling.innerText),t()})}function c(e){t(e,function(e,t){var n=localStorage.getItem(s);e="dark"===n?e.parentElement.parentElement.children[1]:e.parentElement.parentElement.children[2],setTimeout(function(){html2canvas(e).then(e=>{e.toBlob(e=>navigator.clipboard.write([new ClipboardItem({"image/png":e})])),t()})},0)})}a.addEventListener("click",()=>{var e="dark"===localStorage.getItem(s)?"light":"dark";localStorage.setItem(s,e),l(n.dataset.bsTheme=e)}),l(localStorage.getItem(s)),a.children[0].classList.remove("hidden");for(var d=0;d<o.length;d++){o[d].getElementsByClassName("copy-code")[0].addEventListener("click",r);var m=o[d].getElementsByClassName("photo-code");m.length&&m[0].addEventListener("click",c)}for(var S=function(){var a,o,s;if(f.children[2]&&"none"!=f.children[2].style.display)return a=f.querySelector(".main-content").querySelectorAll("[id]"),o=void 0,this.initNavs=function(e){s=e.querySelectorAll("li.bookmark-nav");for(var t=0;t<a.length;t++){for(var n=a[t].id,i=null,o=0;o<s.length;o++)if(s[o].dataset.id==n){i=s[o];break}a[t].nav=i}setTimeout(function(){for(var e=0;e<a.length;e++){var t=a[e];if(l(t).visible&&t.nav)return void t.nav.classList.add("active")}},1e3),r()},f.children[1].addEventListener("scroll",r),this;function l(e){var e=e.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight),n=0<e.top&&!(e.bottom<0||0<=e.top-t)||e.top<0&&e.bottom>t,i=!1;return{visible:n,above:i=n?i:e.bottom<t}}function r(){if(s&&s.length){for(var e=0;e<s.length;e++)s[e].classList.remove("active");for(var t=void 0,e=0;e<a.length;e++){const i=a[e];var n=l(i);if(!n.visible&&n.above&&(t=i.nav),n.visible&&i.nav&&!i.nav.classList.contains("active"))return i.nav.classList.add("active"),o&&clearTimeout(o),void(o=setTimeout(function(){i.nav.scrollIntoView({behavior:"smooth"}),o=void 0},250))}t&&!t.classList.contains("active")&&(t.classList.add("active"),o&&clearTimeout(o),o=setTimeout(function(){t.scrollIntoView({behavior:"smooth"}),o=void 0},250))}}}(),h=function(){var l,r=i.querySelector("#nav-btn"),c=480,d="200px",m="0.25fr",h=730,v=535,u=f.children[0].children[0].children[0],g=f.children[2]&&f.children[2].children[0].children[0],t="sidebar-pinned",p=null==localStorage.getItem(t)||"true"==localStorage.getItem(t),y=!1,b=!1;function n(){window._onresize&&window._onresize();var e=window.outerWidth||window.innerWidth,t=e<c,n=t?y?"100%":"0":p?""+d:"0",i=`grid-template-columns: ${n} 1fr`,o=t&&y?"width: 100%":"0"!=n?"":"display: none",a=t&&y?"display: none":"",s=t?y?"sidebar-show":"sidebar-hide":p?"sidebar-show":"sidebar-hide",n="0"==n;f.children[2]&&(m&&h&&v&&(n&&e<v||!n&&e<h?b||(u.innerHTML=l+g.innerHTML,S.initNavs(u),b=!0):b&&(u.innerHTML=l,S.initNavs(g),b=!1)),!m||t||b?(i+=";",f.children[2].style.display="none"):(i+=` ${m};`,f.children[2].style.display="")),T(r,!t&&p||t&&y?"rotate":"rotate-back","rotate","rotate-back"),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),f.style=L?i:"display: grid;",L&&T(L,s,"sidebar-show","sidebar-hide"),L&&(L.firstChild.style=o),w.style=a,t&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),t&&y&&T(k,"d-none")}function e(){var e=window.outerWidth<c;e?y=!y:p=!p,localStorage.setItem(t,p.toString()),n(),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),e&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),e&&y&&T(k,"d-none")}return m&&h&&v&&g&&(l=u.innerHTML,S.initNavs(g)),r.addEventListener("click",e),(window.onresize=n)(),this.closeSidebar=function(){window.outerWidth<c&&y&&e()},this}(),v=document.getElementsByClassName("auto-close"),u=0;u<v.length;u++)v[u].addEventListener("click",function(e){h.closeSidebar()});location.hash&&(e=document.getElementById(location.hash.replace("#","")))&&e.scrollIntoView()}();</script><script src="/bootstrap.bundle.min.js"></script><script>!function(){for(var e=document.querySelectorAll('[data-bs-toggle="tooltip"]'),t=0;t<e.length;t++)new bootstrap.Tooltip(e[t]);var n=document.getElementsByClassName("accordion-item");if(n.length){for(t=0;t<n.length;t++){var o=n[t];o.querySelectorAll("[href='"+document.location.pathname+"']").length&&o.firstChild.click()}var l=document.querySelector("nav.navbar").querySelector(".home"),a=document.getElementsByClassName("accordion");"/"==document.location.pathname&&l.classList.add("d-none");for(t=0;t<n.length;t++){var s=a[t];s&&s.firstChild&&"VB-Consulting"==s.firstChild.title&&(null!=s.firstChild.querySelector(".collapse")&&l.classList.contains("d-none")&&"/"!=document.location.pathname&&l.classList.remove("d-none"),s.addEventListener("show.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none"),l.classList.add("d-none")}),s.addEventListener("hide.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none")}))}}}();</script><script src="/html2canvas.min.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script></body><script async data-id="101435862" src="//static.getclicky.com/js"></script></html>