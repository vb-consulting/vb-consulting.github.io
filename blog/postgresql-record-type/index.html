<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Execute Custom Function For Each Record</title><meta name="description" content="PostgreSQL crazy experiment with the record type."><link href="https://vb-consulting.github.io/blog/postgresql-record-type/" rel="canonical"><meta name="keywords" content="postgresql, sql, plpgsql, function, functions, record"><meta name="author" content="floki"><meta prefix="og: http://ogp.me/ns#" property="og:title" content="Execute Custom Function For Each Record"><meta prefix="og: http://ogp.me/ns#" property="og:description" content="PostgreSQL crazy experiment with the record type."><meta prefix="og: http://ogp.me/ns#" property="og:image" content="https://vb-consulting.github.io/borovi.jpg"><meta prefix="og: http://ogp.me/ns#" property="og:type" content="article"><meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="VB-Consulting"><meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://vb-consulting.github.io/blog/postgresql-record-type/"><meta name="twitter:image" content="https://vb-consulting.github.io/borovi.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:description" content="PostgreSQL crazy experiment with the record type."><link rel="stylesheet" href="/_elderjs/assets/svelte-89fc75de.css" media="all"><style></style><link href="/style.css?1702493656313" rel="stylesheet"><script>!function(){var e="theme",t=localStorage.getItem(e);t||(t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",localStorage.setItem(e,t)),document.getElementsByTagName("html")[0].dataset.bsTheme=t}();</script></head><body class="d-flex flex-column h-100"><header id="header"><nav class="navbar navbar-expand-md navbar-dark fixed-top py-0 py-md-0 svelte-13wa5zp"><div class="container-fluid flex-nowrap svelte-13wa5zp"><div class="d-flex svelte-13wa5zp"><button id="nav-btn" type="button" class="d-flex btn btn-sm logo animate-rotate svelte-13wa5zp"><i class="material-icons-outlined">menu</i></button></div><div class="d-flex right svelte-13wa5zp"><a class="nav-link my-auto me-2 svelte-13wa5zp" href="https://github.com/vb-consulting/blog/"><i class="bi-github"></i></a> <a class="github-button svelte-13wa5zp" href="https://github.com/vb-consulting/blog/" data-color-scheme="no-preference: light_high_contrast; light: light_high_contrast; dark: light_high_contrast;" data-icon="octicon-star" data-show-count="true" aria-label="Star vb-consulting/blog/ on GitHub"></a><div class="vr text-white my-auto svelte-13wa5zp"></div><button id="theme-btn" type="button" aria-pressed="true" aria-label="theme" class="svelte-13wa5zp"><span class="check hidden svelte-13wa5zp"><span class="icon svelte-13wa5zp"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-13wa5zp"><path fill="currentColor" d="M12 21q-3.775 0-6.388-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.625-.075.975.45t-.025 1.1q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.525-.35 1.075-.037t.475.987q-.35 3.45-2.937 5.725T12 21Zm0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19Zm-.25-6.75Z"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-13wa5zp"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M0 0h24v24H0z"></path><path fill="currentColor" d="M12 19a1 1 0 0 1 .993.883L13 20v1a1 1 0 0 1-1.993.117L11 21v-1a1 1 0 0 1 1-1zm6.313-2.09l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7a1 1 0 0 1 1.218-1.567l.102.07zm-11.306.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM4 11a1 1 0 0 1 .117 1.993L4 13H3a1 1 0 0 1-.117-1.993L3 11h1zm17 0a1 1 0 0 1 .117 1.993L21 13h-1a1 1 0 0 1-.117-1.993L20 11h1zM6.213 4.81l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7A1 1 0 0 1 6.11 4.74l.102.07zm12.894.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM12 2a1 1 0 0 1 .993.883L13 3v1a1 1 0 0 1-1.993.117L11 4V3a1 1 0 0 1 1-1zm0 5a5 5 0 1 1-4.995 5.217L7 12l.005-.217A5 5 0 0 1 12 7z"></path></g></svg></span></span></button></div></div></nav></header><main class="svelte-2kl70j"><div class="sidebar sidebar-hide svelte-2kl70j"><div class="svelte-2kl70j"><ul class="navbar-nav sidenav svelte-2kl70j"><li class="nav-item svelte-2kl70j" data-id="" title="VB-Consulting"><a class="nav-link svelte-2kl70j text-uppercase" href="/">VB-Consulting</a></li><li class="nav-divider svelte-2kl70j"><hr class="svelte-2kl70j"></li><li class="nav-item toc2 svelte-2kl70j" data-id="" title="Norm.Net"><a class="nav-link svelte-2kl70j text-uppercase" href="/norm.net/">Norm.Net</a></li><li class="nav-item toc2 svelte-2kl70j" data-id="" title="RazorSvelte"><a class="nav-link svelte-2kl70j text-uppercase" href="/razorsvelte/">RazorSvelte</a></li><li class="nav-item toc2 svelte-2kl70j" data-id="" title="PgRoutiner"><a class="nav-link svelte-2kl70j text-uppercase" href="/pgroutiner/">PgRoutiner</a></li><li class="nav-item toc2 svelte-2kl70j" data-id="" title="XUnit.Npgsql"><a class="nav-link svelte-2kl70j text-uppercase" href="/xunit.npgsql/">XUnit.Npgsql</a></li><li class="nav-item toc2 svelte-2kl70j" data-id="" title="PostrgeSQL Schema Tools"><a class="nav-link svelte-2kl70j text-uppercase" href="/pg_schema_tools/">PostrgeSQL Schema Tools</a></li><li class="nav-txt-divider text-muted svelte-2kl70j"><hr class="svelte-2kl70j"><span class="svelte-2kl70j">blogs</span><hr class="svelte-2kl70j"></li><li class="nav-item svelte-2kl70j" data-id="" title="What is Micro ORM?"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/micro-orm/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> What is Micro ORM?</a></li><li class="nav-item svelte-2kl70j" data-id="" title="What have the STORED PROCEDURES ever done for us?"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/what-have-stored-procedures-ever-done/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> What have the STORED PROCEDURES ever done for us?</a></li><li class="nav-item svelte-2kl70j" data-id="" title="Which Way .NET Developer?"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/where-to/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> Which Way .NET Developer?</a></li><li class="nav-item svelte-2kl70j" data-id="" title="Custom Temporal Tables in PostgreSQL"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/postgresql-temporal-tables/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> Custom Temporal Tables in PostgreSQL</a></li><li class="nav-item svelte-2kl70j" data-id="" title="Haters Build Software"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/haters-build-software/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> Haters Build Software</a></li><li class="nav-item svelte-2kl70j" data-id="" title="Recursion with PostgreSQL Part 1 - A Different Type of Recursion"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/recursion-postgresql/part1-different-type-of-recursion/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> Recursion with PostgreSQL Part 1 - A Different Type of Recursion</a></li><li class="nav-item svelte-2kl70j" data-id="" title="Recursion with PostgreSQL Part 2 - Performances"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/recursion-postgresql/part2-performances/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> Recursion with PostgreSQL Part 2 - Performances</a></li><li class="nav-item svelte-2kl70j" data-id="" title="Recursion with PostgreSQL Part 3 - Cycle Detection"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/recursion-postgresql/part3-cycle-detection/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> Recursion with PostgreSQL Part 3 - Cycle Detection</a></li><li class="nav-item svelte-2kl70j" data-id="" title="Recursion with PostgreSQL Part 4 - Finding the Right Path"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/recursion-postgresql/part4-right-path/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> Recursion with PostgreSQL Part 4 - Finding the Right Path</a></li><li class="nav-item svelte-2kl70j active" data-id="" title="Execute Custom Function For Each Record"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase" href="/blog/postgresql-record-type/"><i class="bi bi-chat-left-text svelte-2kl70j"></i> Execute Custom Function For Each Record</a></li><li class="nav-item toc2 svelte-2kl70j" data-id="" title="ALL BLOGS"><a class="nav-link btn btn-link btn-sm svelte-2kl70j lr-arrow text-uppercase" href="/blogs/"><i class="bi bi-arrow-right-circle svelte-2kl70j"></i> ALL BLOGS</a></li></ul></div></div><div class="content svelte-2kl70j"><div class="banner svelte-1o0s4c4" style="background-image: url(/borovi.jpg); background-position: bottom; background-blend-mode: luminosity;"></div><div class="container-sm main-content blog svelte-1o0s4c4 bannered"><div class="blog-head svelte-1o0s4c4"><div class="d-inline-flex"><a href="/blogs/postgresql" class="btn btn-sm svelte-1o0s4c4"><span class="cat btn-link"># postgresql</span> </a><a href="/blogs/plpgsql" class="btn btn-sm svelte-1o0s4c4"><span class="cat btn-link"># plpgsql</span> </a><a href="/blogs/sql" class="btn btn-sm svelte-1o0s4c4"><span class="cat btn-link"># sql</span></a></div><a href="https://github.com/vb-consulting/blog/blob/master/LICENSE" style="color: var(--bs-secondary-color) !important;" class="svelte-1o0s4c4">CC0-1.0 license</a></div><h1 class="text-shadow" id="execute-custom-function-for-each-record">Execute Custom Function For Each Record</h1><div class="post-meta text-shadow"><div class="post-share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Fpostgresql-record-type%2F" class="me-1 bi-linkedin" data-bs-toggle="tooltip" data-bs-html="true" title="Share on LinkedIn"><i class=""></i></a> <a href="http://twitter.com/share?text=Execute%20Custom%20Function%20For%20Each%20Record%0APostgreSQL%20crazy%20experiment%20with%20the%20record%20type.%0A&url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Fpostgresql-record-type%2F&hashtags=postgresql%2Cplpgsql%2Csql" class="me-1 bi-twitter-x" data-bs-toggle="tooltip" data-bs-html="true" title="Share on X"><i class=""></i></a> <a href="#" class="copy-url bi-clipboard" data-bs-toggle="tooltip" data-bs-html="true" title="Copy URL"><i class=""></i></a></div><div class="post-details"><div class="post-pic" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog." style="background-image: url(/floki.jpeg)"></div><div class="post-details-right"><div class="post-author">floki</div><div class="post-date">Nov 6, 2023</div></div></div></div><ul><li><p>Start with a query that returns a series of numbers: <code>select q.i from generate_series(1, 10) q(i)</code></p></li><li><p>The goal is to execute a custom function for each record in this select (this is just an example; query could be anything).</p></li><li><p>That something will always return a previous value for the field <code>i</code> in the <code>q(i)</code> test table.</p></li><li><p>That is essentially a custom implementation of the <a href="https://www.postgresql.org/docs/current/functions-window.html">LAG window function</a>, but this serves as a proof of concept to demonstrate that we can do a custom function call for each value in any SELECT.</p></li><li><p>We will do this in a function that <code>test_rec()</code> that returns table (i, j), where <code>i</code> is a value from <code>generate_series</code> and <code>j</code> is the result from a custom function executed for each result that represents a previous (lag) value.</p></li><li><p>First, we need a wrap-up that generate-series in a subquery because <code>generate_series</code> returns a number, not a table record, and we need a table record:</p></li></ul><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki" style="background-color: #222222"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">*</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> q.i</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> generate_series(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">10</span><span style="color: #E6E6E6">) q(i)</span></span>
<span class="line"><span style="color: #E6E6E6">) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> sub;</span></span></code></pre><pre class="shiki" style="background-color: #FFFFFF"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> *</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> q.i</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> generate_series(</span><span style="color: #098658">1</span><span style="color: #000000">, </span><span style="color: #098658">10</span><span style="color: #000000">) q(i)</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> sub;</span></span></code></pre></div><ul><li>Next, inside our <code>test_rec()</code>, we will create a new function that will do this custom processing. This function will receive entire record and return the result of the previous (lag) calculation.</li></ul><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki" style="background-color: #222222"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> pg_temp._parse(_rec record)</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">as</span></span>
<span class="line"><span style="color: #E6E6E6">  $$</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">declare</span><span style="color: #E6E6E6"> _ret </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">begin</span></span>
<span class="line"><span style="color: #E6E6E6">      </span><span style="color: #6A9955">-- do the calculation here</span></span>
<span class="line"><span style="color: #E6E6E6">      </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> _ret;</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">  $$;</span></span></code></pre><pre class="shiki" style="background-color: #FFFFFF"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> pg_temp._parse(_rec record)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">as</span></span>
<span class="line"><span style="color: #000000">  $$</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">declare</span><span style="color: #000000"> _ret </span><span style="color: #0000FF">int</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">begin</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #008000">-- do the calculation here</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">return</span><span style="color: #000000"> _ret;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">  $$;</span></span></code></pre></div><ul><li>This function is created on the <code>pg_temp</code> schema. That means it is visible only to the current connection (session), and it will be dropped when the connection (session) ends. Alternatively, this function could be global at any schema.</li><li>Additionally, this function must be <code>plpgsql</code> function because plain <code>sql</code> function can't work with the <code>record</code> type, and we have a parameter which is generic (any) table record <code>_rec record</code>.</li><li>Note: record types are great for implementing generic logic that can work with many different records and tables.</li><li>To be able to perform this type of calculation with the previous value (lag), we need to remember the previous value.</li><li>Functions, unfortunately, can't capture variables, and only way to implement this is to use <a href="https://www.postgresql.org/docs/current/runtime-config-custom.html">custom settings for PostgreSQL</a>.</li><li>This allows us to have variables and values that are visible only to the current connection (session).</li><li>In the first step, we need to reset the initial value:</li></ul><div class="one-liner"><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki" style="background-color: #222222"><code class="code-highlight"><span class="line"><span style="color: #569CD6">reset</span><span style="color: #E6E6E6"> test_rec.prev;</span></span></code></pre><pre class="shiki" style="background-color: #FFFFFF"><code class="code-highlight"><span class="line"><span style="color: #0000FF">reset</span><span style="color: #000000"> test_rec.prev;</span></span></code></pre></div></div><ul><li>Note that the name is scoped to this function <code>test_rec.prev</code>. Unscoped names are usually reserved for the system.</li><li>Reset will set this value to empty value.</li><li>In the first step of the record process function, we capture the return value from this variable:</li></ul><div class="one-liner"><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki" style="background-color: #222222"><code class="code-highlight"><span class="line"><span style="color: #E6E6E6">_ret </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">nullif</span><span style="color: #E6E6E6">(current_setting(</span><span style="color: #CE9178">'test_rec.prev'</span><span style="color: #E6E6E6">, true), </span><span style="color: #CE9178">''</span><span style="color: #E6E6E6">)::</span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki" style="background-color: #FFFFFF"><code class="code-highlight"><span class="line"><span style="color: #000000">_ret = </span><span style="color: #795E26">nullif</span><span style="color: #000000">(current_setting(</span><span style="color: #A31515">'test_rec.prev'</span><span style="color: #000000">, true), </span><span style="color: #A31515">''</span><span style="color: #000000">)::</span><span style="color: #0000FF">int</span><span style="color: #000000">;</span></span></code></pre></div></div><ul><li>Two things here: 1) settings are always text type and we need to cast them to int with <code>::int</code> 2) we to check <code>nullif</code> to set to null empty strings.</li><li>Next, we can set the previous value and return the result:</li></ul><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki" style="background-color: #222222"><code class="code-highlight"><span class="line"><span style="color: #E6E6E6">perform set_config(</span><span style="color: #CE9178">'test_rec.prev'</span><span style="color: #E6E6E6">, _rec.i::</span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">, true);</span></span>
<span class="line"><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> _ret;</span></span></code></pre><pre class="shiki" style="background-color: #FFFFFF"><code class="code-highlight"><span class="line"><span style="color: #000000">perform set_config(</span><span style="color: #A31515">'test_rec.prev'</span><span style="color: #000000">, _rec.i::</span><span style="color: #0000FF">text</span><span style="color: #000000">, true);</span></span>
<span class="line"><span style="color: #0000FF">return</span><span style="color: #000000"> _ret;</span></span></code></pre></div><ul><li>And now, we can modify the result query to pass the record to this function:</li></ul><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki" style="background-color: #222222"><code class="code-highlight"><span class="line"><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query</span></span>
<span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> sub.i, pg_temp._parse(sub) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> j </span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> q.i</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> generate_series(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">10</span><span style="color: #E6E6E6">) q(i)</span></span>
<span class="line"><span style="color: #E6E6E6">) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> sub;</span></span></code></pre><pre class="shiki" style="background-color: #FFFFFF"><code class="code-highlight"><span class="line"><span style="color: #0000FF">return</span><span style="color: #000000"> query</span></span>
<span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> sub.i, pg_temp._parse(sub) </span><span style="color: #0000FF">as</span><span style="color: #000000"> j </span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> q.i</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> generate_series(</span><span style="color: #098658">1</span><span style="color: #000000">, </span><span style="color: #098658">10</span><span style="color: #000000">) q(i)</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> sub;</span></span></code></pre></div><ul><li>To wrap it all up, this is how it looks like in the end:</li></ul><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki" style="background-color: #222222"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> test_rec()</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    i </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    j </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #569CD6">as</span></span>
<span class="line"><span style="color: #E6E6E6">$func$</span></span>
<span class="line"><span style="color: #569CD6">begin</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">reset</span><span style="color: #E6E6E6"> test_rec.prev;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">pg_temp</span><span style="color: #E6E6E6">._parse(_rec record)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">as</span></span>
<span class="line"><span style="color: #E6E6E6">    $$</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">declare</span><span style="color: #E6E6E6"> _ret </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">begin</span></span>
<span class="line"><span style="color: #E6E6E6">        _ret </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">nullif</span><span style="color: #E6E6E6">(current_setting(</span><span style="color: #CE9178">'test_rec.prev'</span><span style="color: #E6E6E6">, true), </span><span style="color: #CE9178">''</span><span style="color: #E6E6E6">)::</span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">        perform set_config(</span><span style="color: #CE9178">'test_rec.prev'</span><span style="color: #E6E6E6">, _rec.i::</span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">, true);</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> _ret;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    $$;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> sub.i, pg_temp._parse(sub) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> j </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> q.i</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> generate_series(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">10</span><span style="color: #E6E6E6">) q(i)</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> sub;</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">$func$;</span></span></code></pre><pre class="shiki" style="background-color: #FFFFFF"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> </span><span style="color: #795E26">replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> test_rec()</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    i </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    j </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #0000FF">as</span></span>
<span class="line"><span style="color: #000000">$func$</span></span>
<span class="line"><span style="color: #0000FF">begin</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">reset</span><span style="color: #000000"> test_rec.prev;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">pg_temp</span><span style="color: #000000">._parse(_rec record)</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">as</span></span>
<span class="line"><span style="color: #000000">    $$</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">declare</span><span style="color: #000000"> _ret </span><span style="color: #0000FF">int</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">begin</span></span>
<span class="line"><span style="color: #000000">        _ret = </span><span style="color: #795E26">nullif</span><span style="color: #000000">(current_setting(</span><span style="color: #A31515">'test_rec.prev'</span><span style="color: #000000">, true), </span><span style="color: #A31515">''</span><span style="color: #000000">)::</span><span style="color: #0000FF">int</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">        perform set_config(</span><span style="color: #A31515">'test_rec.prev'</span><span style="color: #000000">, _rec.i::</span><span style="color: #0000FF">text</span><span style="color: #000000">, true);</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> _ret;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    $$;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> query</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> sub.i, pg_temp._parse(sub) </span><span style="color: #0000FF">as</span><span style="color: #000000"> j </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> q.i</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">from</span><span style="color: #000000"> generate_series(</span><span style="color: #098658">1</span><span style="color: #000000">, </span><span style="color: #098658">10</span><span style="color: #000000">) q(i)</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> sub;</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">$func$;</span></span></code></pre></div><ul><li>This demonstrates couple of interesting concepts:</li></ul><ol><li>Usage of <code>record</code> type in <code>plpgsql</code> and how it can be used to process records with custom logic.</li><li>Usage of temporary functions scoped to the session (connection).</li><li>Usage of configuration values scoped to the session (connection).</li></ol><ul><li><p>The last two concepts assume that there will be no parallel calls on the same connection which is the bad practice anyway (if it is even possible).</p></li><li><p>And now, we can call this:</p></li></ul><div class="one-liner"><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki" style="background-color: #222222"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> test_rec()</span></span></code></pre><pre class="shiki" style="background-color: #FFFFFF"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> * </span><span style="color: #0000FF">from</span><span style="color: #000000"> test_rec()</span></span></code></pre></div></div><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th align="center"><strong><code>i</code></strong></th><th align="center"><strong><code>j</code></strong></th></tr></thead><tbody class="table-group-divider"><tr><td align="center">1</td><td align="center"><code>NULL</code></td></tr><tr><td align="center">2</td><td align="center">1</td></tr><tr><td align="center">3</td><td align="center">2</td></tr><tr><td align="center">4</td><td align="center">3</td></tr><tr><td align="center">5</td><td align="center">4</td></tr><tr><td align="center">6</td><td align="center">5</td></tr><tr><td align="center">7</td><td align="center">6</td></tr><tr><td align="center">8</td><td align="center">7</td></tr><tr><td align="center">9</td><td align="center">8</td></tr><tr><td align="center">10</td><td align="center">9</td></tr></tbody></table><div class="pt-2 border-top"><div id="comments-section" class="h3">Comments</div><script defer src="https://cdn.commento.io/js/commento.js" data-no-fonts="true" data-css-override="https://vb-consulting.github.io/style.css"></script><div id="commento"></div></div><div class="mb-5"></div></div><div></div></div><div class="rightside svelte-2kl70j"><div class="svelte-2kl70j"><ul class="navbar-nav sidenav svelte-2kl70j"><li class="nav-txt-divider text-muted svelte-2kl70j"><hr class="svelte-2kl70j"><span class="svelte-2kl70j">on this page</span><hr class="svelte-2kl70j"></li><li class="nav-item toc1 right svelte-2kl70j bookmark-nav" data-id="execute-custom-function-for-each-record" title="Execute Custom Function For Each Record"><a class="nav-link auto-close svelte-2kl70j bookmark-link" href="#execute-custom-function-for-each-record">Execute Custom Function For Each Record</a></li><li class="nav-divider svelte-2kl70j"><hr class="svelte-2kl70j"></li><li class="nav-item toc1 right svelte-2kl70j bookmark-nav" data-id="comments-section" title="Comments"><a class="nav-link auto-close svelte-2kl70j bookmark-link" href="#comments-section">Comments</a></li></ul></div></div></main><script>!function(){var i=document.querySelector("nav.navbar"),f=document.getElementsByTagName("main")[0],L=f.getElementsByClassName("sidebar")[0],w=f.getElementsByClassName("content")[0],a=document.querySelectorAll("div.code");function k(e,t){for(var n=2;n<arguments.length;n++)e.classList.remove(arguments[n]);e.classList.add(t)}function t(e,t){var n=e.currentTarget;if(!n.classList.contains("bi-check")){for(var i="",a=0;a<n.classList.length;a++)if(n.classList[a].startsWith("bi-")){i=n.classList[a];break}n.classList.remove(i),n.classList.add("spinner-border-sm"),n.classList.add("spinner-border");e=bootstrap.Tooltip.getInstance(n);e&&(e.setContent({".tooltip-inner":"Copying..."}),e.show()),t(n,function(){var e;n.classList.remove(i),n.classList.remove("spinner-border-sm"),n.classList.remove("spinner-border"),n.classList.add("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&(e.setContent({".tooltip-inner":"Copied!"}),e.show()),setTimeout(function(){var e;n.classList.add(i),n.classList.remove("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&e.setContent({".tooltip-inner":n.dataset.bsTitle})},2e3)})}}var e=document.querySelector(".post-share > .copy-url"),n=(e&&e.addEventListener("click",function(e){t(e,function(e,t){navigator.clipboard.writeText(document.location.origin+document.location.pathname),t()})}),document.getElementsByTagName("html")[0]),s=i.querySelector("#theme-btn"),o="theme";function r(e){var t=s.getElementsByTagName("svg");"dark"===e?(t[0].style.display="",t[1].style.display="none",s.getElementsByClassName("check")[0].classList.add("checked")):(t[0].style.display="none",t[1].style.display="",s.getElementsByClassName("check")[0].classList.remove("checked"));for(var n=0;n<a.length;n++){var i=a[n];"dark"===e?(i.children[1].style.display="inherit",i.children[2].style.display="none"):"light"===e&&(i.children[1].style.display="none",i.children[2].style.display="inherit")}window._theme&&window._theme(e)}function l(e){t(e,function(e,t){navigator.clipboard.writeText(e.parentElement.nextSibling.innerText),t()})}function c(e){t(e,function(e,t){var n=localStorage.getItem(o);e="dark"===n?e.parentElement.parentElement.children[1]:e.parentElement.parentElement.children[2],setTimeout(function(){html2canvas(e).then(e=>{e.toBlob(e=>navigator.clipboard.write([new ClipboardItem({"image/png":e})])),t()})},0)})}s.addEventListener("click",()=>{var e="dark"===localStorage.getItem(o)?"light":"dark";localStorage.setItem(o,e),r(n.dataset.bsTheme=e)}),r(localStorage.getItem(o)),s.children[0].classList.remove("hidden");for(var d=0;d<a.length;d++)a[d].getElementsByClassName("copy-code")[0].addEventListener("click",l),a[d].getElementsByClassName("photo-code")[0].addEventListener("click",c);for(var E=function(){var s,a,o;if(f.children[2]&&"none"!=f.children[2].style.display)return s=f.querySelector(".main-content").querySelectorAll("[id]"),a=void 0,this.initNavs=function(e){o=e.querySelectorAll("li.bookmark-nav");for(var t=0;t<s.length;t++){for(var n=s[t].id,i=null,a=0;a<o.length;a++)if(o[a].dataset.id==n){i=o[a];break}s[t].nav=i}setTimeout(function(){for(var e=0;e<s.length;e++){var t=s[e];if(r(t).visible&&t.nav)return void t.nav.classList.add("active")}},1e3),l()},f.children[1].addEventListener("scroll",l),this;function r(e){var e=e.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight),n=0<e.top&&!(e.bottom<0||0<=e.top-t)||e.top<0&&e.bottom>t,i=!1;return{visible:n,above:i=n?i:e.bottom<t}}function l(){if(o&&o.length){for(var e=0;e<o.length;e++)o[e].classList.remove("active");for(var t=void 0,e=0;e<s.length;e++){const i=s[e];var n=r(i);if(!n.visible&&n.above&&(t=i.nav),n.visible&&i.nav&&!i.nav.classList.contains("active"))return i.nav.classList.add("active"),a&&clearTimeout(a),void(a=setTimeout(function(){i.nav.scrollIntoView({behavior:"smooth"}),a=void 0},250))}t&&!t.classList.contains("active")&&(t.classList.add("active"),a&&clearTimeout(a),a=setTimeout(function(){t.scrollIntoView({behavior:"smooth"}),a=void 0},250))}}}(),h=function(){var r,l=i.querySelector("#nav-btn"),c=480,d="200px",h="0.25fr",m=730,v=535,u=f.children[0].children[0].children[0],g=f.children[2]&&f.children[2].children[0].children[0],e="sidebar-pinned",p=null==localStorage.getItem(e)||"true"==localStorage.getItem(e),b=!1,y=!1;function t(){window._onresize&&window._onresize();var e=window.outerWidth||window.innerWidth,t=e<c,n=t?b?"100%":"0":p?""+d:"0",i=`grid-template-columns: ${n} 1fr`,a=t&&b?"width: 100%":"0"!=n?"":"display: none",s=t&&b?"display: none":"",o=t?b?"sidebar-show":"sidebar-hide":p?"sidebar-show":"sidebar-hide",n="0"==n;f.children[2]&&(h&&m&&v&&(n&&e<v||!n&&e<m?y||(u.innerHTML=r+g.innerHTML,E.initNavs(u),y=!0):y&&(u.innerHTML=r,E.initNavs(g),y=!1)),!h||t||y?(i+=";",f.children[2].style.display="none"):(i+=` ${h};`,f.children[2].style.display="")),k(l,!t&&p||t&&b?"rotate":"rotate-back","rotate","rotate-back"),p?l.classList.add("text-shadow"):l.classList.remove("text-shadow"),f.style=L?i:"display: grid;",L&&k(L,o,"sidebar-show","sidebar-hide"),L&&(L.firstChild.style=a),w.style=s}function n(){window.outerWidth<c?b=!b:p=!p,localStorage.setItem(e,p.toString()),t(),p?l.classList.add("text-shadow"):l.classList.remove("text-shadow")}return h&&m&&v&&g&&(r=u.innerHTML,E.initNavs(g)),l.addEventListener("click",n),(window.onresize=t)(),this.closeSidebar=function(){window.outerWidth<c&&b&&n()},this}(),m=document.getElementsByClassName("auto-close"),v=0;v<m.length;v++)m[v].addEventListener("click",function(e){h.closeSidebar()});location.hash&&(e=document.getElementById(location.hash.replace("#","")))&&e.scrollIntoView()}();</script><script src="/bootstrap.bundle.min.js"></script><script>!function(){for(var t=document.querySelectorAll('[data-bs-toggle="tooltip"]'),e=0;e<t.length;e++)new bootstrap.Tooltip(t[e]);var o=document.getElementsByClassName("accordion-item");if(o.length)for(e=0;e<o.length;e++){var l=o[e];l.querySelectorAll("[href='"+document.location.pathname+"']").length&&l.firstChild.click()}}();</script><script src="/html2canvas.min.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script></body><script async data-id="101435862" src="//static.getclicky.com/js"></script></html>