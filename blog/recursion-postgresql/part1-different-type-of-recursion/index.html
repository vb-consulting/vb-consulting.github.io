<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Recursion with PostgreSQL Part 1 - A Different Type of Recursion</title><meta name="description" content="Exploring a different approach to recursion with PostgreSQL by using recursive plpgsql function instead of recursive CTE query."><link href="https://vb-consulting.github.io/blog/recursion-postgresql/part1-different-type-of-recursion/" rel="canonical"><meta name="keywords" content="postgresql, sql, plpgsql, recursion, tree, cte, function"><meta name="author" content="floki"><meta prefix="og: http://ogp.me/ns#" property="og:title" content="Recursion with PostgreSQL Part 1 - A Different Type of Recursion"><meta prefix="og: http://ogp.me/ns#" property="og:description" content="Exploring a different approach to recursion with PostgreSQL by using recursive plpgsql function instead of recursive CTE query."><meta prefix="og: http://ogp.me/ns#" property="og:image" content="https://vb-consulting.github.io/neretva.jpg"><meta prefix="og: http://ogp.me/ns#" property="og:type" content="article"><meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="VB-Consulting"><meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://vb-consulting.github.io/blog/recursion-postgresql/part1-different-type-of-recursion/"><meta name="twitter:image" content="https://vb-consulting.github.io/neretva.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:description" content="Exploring a different approach to recursion with PostgreSQL by using recursive plpgsql function instead of recursive CTE query."><link rel="stylesheet" href="/_elderjs/assets/svelte-e0e6468f.css" media="all"><style></style><link href="/style.css?1719994175201" rel="stylesheet"><script>!function(){var e="theme",t=localStorage.getItem(e);t||(t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",localStorage.setItem(e,t)),document.getElementsByTagName("html")[0].dataset.bsTheme=t}();</script></head><body class="d-flex flex-column h-100"><header id="header"><nav class="navbar navbar-expand-md navbar-dark fixed-top py-0 py-md-0 svelte-30jr7w"><div class="container-fluid flex-nowrap svelte-30jr7w"><div class="d-flex svelte-30jr7w"><button id="nav-btn" type="button" class="d-flex btn btn-sm logo animate-rotate svelte-30jr7w"><i class="material-icons-outlined">menu</i></button> <a class="nav-link my-auto ms-2 fw-semibold home svelte-30jr7w" href="/"><i class="bi-chevron-double-left"></i> VB Home</a></div><div class="d-flex right svelte-30jr7w"><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Become a Patreon" href="https://www.patreon.com/vbconsulting" target="_blank"><div class="patreon"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Buy Me a Coffee" href="https://www.buymeacoffee.com/vbilopavu" target="_blank"><div class="bmc"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto me-2 svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="vb-consulting on GitHub" href="https://github.com/vb-consulting/"><i class="bi-github"></i></a> <a class="github-button svelte-30jr7w" href="https://github.com/vb-consulting/" data-bs-toggle="tooltip" data-bs-html="true" title="Star vb-consulting on GitHub" data-color-scheme="no-preference: light_high_contrast; light: light_high_contrast; dark: light_high_contrast;" data-icon="octicon-star" data-show-count="true" aria-label="Star vb-consulting on GitHub"></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><button id="theme-btn" type="button" aria-pressed="true" aria-label="theme" class="svelte-30jr7w"><span class="check hidden svelte-30jr7w"><span class="icon svelte-30jr7w"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><path fill="currentColor" d="M12 21q-3.775 0-6.388-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.625-.075.975.45t-.025 1.1q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.525-.35 1.075-.037t.475.987q-.35 3.45-2.937 5.725T12 21Zm0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19Zm-.25-6.75Z"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M0 0h24v24H0z"></path><path fill="currentColor" d="M12 19a1 1 0 0 1 .993.883L13 20v1a1 1 0 0 1-1.993.117L11 21v-1a1 1 0 0 1 1-1zm6.313-2.09l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7a1 1 0 0 1 1.218-1.567l.102.07zm-11.306.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM4 11a1 1 0 0 1 .117 1.993L4 13H3a1 1 0 0 1-.117-1.993L3 11h1zm17 0a1 1 0 0 1 .117 1.993L21 13h-1a1 1 0 0 1-.117-1.993L20 11h1zM6.213 4.81l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7A1 1 0 0 1 6.11 4.74l.102.07zm12.894.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM12 2a1 1 0 0 1 .993.883L13 3v1a1 1 0 0 1-1.993.117L11 4V3a1 1 0 0 1 1-1zm0 5a5 5 0 1 1-4.995 5.217L7 12l.005-.217A5 5 0 0 1 12 7z"></path></g></svg></span></span></button></div></div></nav></header><main class="svelte-9zwk14"><div class="sidebar sidebar-hide svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-item svelte-9zwk14" data-id="" title="VB-Consulting"><a class="nav-link svelte-9zwk14 text-uppercase" href="/">VB-Consulting</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="NpgsqlRest"><a class="nav-link svelte-9zwk14 text-uppercase" href="/npgsqlrest/">NpgsqlRest</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="Norm.Net"><a class="nav-link svelte-9zwk14 text-uppercase" href="/norm.net/">Norm.Net</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="RazorSvelte"><a class="nav-link svelte-9zwk14 text-uppercase" href="/razorsvelte/">RazorSvelte</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PgRoutiner"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pgroutiner/">PgRoutiner</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="XUnit.Npgsql"><a class="nav-link svelte-9zwk14 text-uppercase" href="/xunit.npgsql/">XUnit.Npgsql</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="pgmigrations"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pgmigrations/">pgmigrations</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PostrgeSQL Schema Tools"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pg_schema_tools/">PostrgeSQL Schema Tools</a></li><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">blogs</span><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="See all blogs..."><a class="nav-link btn btn-sm w-fit px-3 mx-auto svelte-9zwk14 lr-arrow text-uppercase" href="/blogs/"><i class="bi bi-arrow-right-circle svelte-9zwk14"></i> <span class="btn-link">ALL BLOGS</span></a></li><li class="nav-item svelte-9zwk14" data-id="" title="Unit Testing and TDD With PostgreSQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/unit-testing-postgresql/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Unit Testing and TDD With PostgreSQL is Easy</a></li><li class="nav-item svelte-9zwk14" data-id="" title="From Transaction Scripts and Domain Model to SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/domain-model-transaction-script/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>From Transaction Scripts and Domain Model to SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Transaction Script DDD vs SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/transaction-script/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Transaction Script DDD vs SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Common Sense Software Design Approach for RDBMS-backed Type of Software"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/common-sense-design/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Common Sense Software Design</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-v2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest v2 Update üêòüî•</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-update1.6.2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest Update 1.6.2</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL Array Example"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-array/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Arrays üêò</a></li><li class="nav-item svelte-9zwk14" data-id="" title="How DDD is screwing up your SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/sql-vs-ddd/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>How DDD is screwing up your SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL Paging Benchmarks"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-paging/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Paging Benchmarks</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest NuGet Library</a></li></ul></div></div><div class="content svelte-9zwk14"><div class="banner svelte-1bxfgrx" style="background-image: url(/neretva.jpg); background-position: bottom; background-blend-mode: luminosity;"></div><div class="container-sm main-content blog svelte-1bxfgrx bannered"><div class="blog-head svelte-1bxfgrx"><a href="https://github.com/vb-consulting/blog/blob/master/LICENSE" class="text-shadow svelte-1bxfgrx" style="color: white">CC0-1.0 license</a></div><div class="categories svelte-1bxfgrx"><a href="/blogs/postgresql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># postgresql</span> </a><a href="/blogs/plpgsql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># plpgsql</span> </a><a href="/blogs/sql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># sql</span></a></div><h1 class="text-shadow" id="recursion-with-postgresql-part-1---a-different-type-of-recursion">Recursion with PostgreSQL Part 1 - A Different Type of Recursion</h1><div class="post-meta text-shadow"><div></div><div class="post-details"><div class="post-pic" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog." style="background-image: url(/floki2.jpg)"></div><div class="post-details-right"><div class="post-share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Frecursion-postgresql%2Fpart1-different-type-of-recursion%2F" class="me-1 bi-linkedin" data-bs-toggle="tooltip" data-bs-html="true" title="Share on LinkedIn"><i class=""></i></a> <a href="http://twitter.com/share?text=Recursion%20with%20PostgreSQL%20Part%201%20-%20A%20Different%20Type%20of%20Recursion%0AExploring%20a%20different%20approach%20to%20recursion%20with%20PostgreSQL%20by%20using%20recursive%20plpgsql%20function%20instead%20of%20recursive%20CTE%20query.%0A&url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Frecursion-postgresql%2Fpart1-different-type-of-recursion%2F&hashtags=postgresql%2Cplpgsql%2Csql" class="me-1 bi-twitter-x" data-bs-toggle="tooltip" data-bs-html="true" title="Share on X"><i class=""></i></a> <a href="#" class="copy-url bi-clipboard" data-bs-toggle="tooltip" data-bs-html="true" title="Copy URL"><i class=""></i></a></div><div class="post-author">floki</div><div class="post-date">Sep 18, 2023</div></div></div></div><p>PostgreSQL offers a powerful procedural programming model out of the box (in addition to the standard SQL).</p><p>You can combine that with the standard SQL approach to overcome almost any issue and solve any programming task. Sometimes, the good old procedural approach may be a more straightforward way out of the complex data problems than standard SQL.</p><p>This article will try to demonstrate that approach to a complex problem example.</p><h2 id="the-problem">The Problem</h2><p>Let's say we want to write a function that will return <strong>all related tables</strong> for a table name in a parameter.</p><p>We will start with a made-up schema:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">division_status</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    division_status_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6">, </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">department_status</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    department_status_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6">, </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">divisions</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    division_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6">, </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">, </span></span>
<span class="line"><span style="color: #E6E6E6">    owner_user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_division_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    division_status_id </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">departments</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    department_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6">, </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">, </span></span>
<span class="line"><span style="color: #E6E6E6">    owner_user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_department_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    division_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    department_status_id </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">users</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6">, </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">, </span></span>
<span class="line"><span style="color: #E6E6E6">    owner_user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">, </span></span>
<span class="line"><span style="color: #E6E6E6">    department_id </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> users </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (department_id) </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> departments (department_id);</span></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> users </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (owner_user_id) </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> users (user_id);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> departments </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (owner_user_id) </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> users (user_id);</span></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> departments </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (parent_department_id) </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> departments (department_id);</span></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> departments </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (division_id) </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> divisions (division_id);</span></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> departments </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (department_status_id) </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> department_status (department_status_id);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> divisions </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (owner_user_id) </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> users (user_id);</span></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> divisions </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (parent_division_id) </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> divisions (division_id);</span></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> divisions </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">foreign key</span><span style="color: #E6E6E6"> (division_status_id) </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> division_status (division_status_id);</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">division_status</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    division_status_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">department_status</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    department_status_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">divisions</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    division_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    owner_user_id </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_division_id </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    division_status_id </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">departments</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    department_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    owner_user_id </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_department_id </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    division_id </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    department_status_id </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">users</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    user_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    owner_user_id </span><span style="color: #0000FF">int</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    department_id </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> users </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (department_id) </span><span style="color: #0000FF">references</span><span style="color: #000000"> departments (department_id);</span></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> users </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (owner_user_id) </span><span style="color: #0000FF">references</span><span style="color: #000000"> users (user_id);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> departments </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (owner_user_id) </span><span style="color: #0000FF">references</span><span style="color: #000000"> users (user_id);</span></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> departments </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (parent_department_id) </span><span style="color: #0000FF">references</span><span style="color: #000000"> departments (department_id);</span></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> departments </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (division_id) </span><span style="color: #0000FF">references</span><span style="color: #000000"> divisions (division_id);</span></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> departments </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (department_status_id) </span><span style="color: #0000FF">references</span><span style="color: #000000"> department_status (department_status_id);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> divisions </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (owner_user_id) </span><span style="color: #0000FF">references</span><span style="color: #000000"> users (user_id);</span></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> divisions </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (parent_division_id) </span><span style="color: #0000FF">references</span><span style="color: #000000"> divisions (division_id);</span></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> divisions </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">foreign key</span><span style="color: #000000"> (division_status_id) </span><span style="color: #0000FF">references</span><span style="color: #000000"> division_status (division_status_id);</span></span></code></pre></div><p>As we can see, we have the following tables:</p><ul><li><code>users</code> - references itself (<code>users</code>) and table <code>departments</code></li><li><code>departments</code> references itself, table <code>users</code>, table <code>divisions</code>, and table <code>department_status</code>.</li><li><code>divisions</code> references itself, table <code>users</code> and table <code>division_status</code>.</li></ul><p>So, what we want to achieve is to have a function that will return all related tables directly and indirectly, together with the level of relation.</p><p>For example, we want to be able to call a function <code>select_foreign_tables</code> for table <code>users</code> as a parameter, like this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> select_foreign_tables(</span><span style="color: #CE9178">'public'</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">'users'</span><span style="color: #E6E6E6">);</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> * </span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> select_foreign_tables(</span><span style="color: #A31515">'public'</span><span style="color: #000000">, </span><span style="color: #A31515">'users'</span><span style="color: #000000">);</span></span></code></pre></div><p>This should return the following result:</p><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th>table_schema</th><th>table_name</th><th>fk_table_schema</th><th>fk_table_name</th><th>level</th></tr></thead><tbody class="table-group-divider"><tr><td>public</td><td>users</td><td>public</td><td>departments</td><td>1</td></tr><tr><td>public</td><td>users</td><td>public</td><td>users</td><td>1</td></tr><tr><td>public</td><td>departments</td><td>public</td><td>divisions</td><td>2</td></tr><tr><td>public</td><td>departments</td><td>public</td><td>department_status</td><td>2</td></tr><tr><td>public</td><td>departments</td><td>public</td><td>users</td><td>2</td></tr><tr><td>public</td><td>departments</td><td>public</td><td>departments</td><td>2</td></tr><tr><td>public</td><td>divisions</td><td>public</td><td>divisions</td><td>3</td></tr><tr><td>public</td><td>divisions</td><td>public</td><td>users</td><td>3</td></tr><tr><td>public</td><td>divisions</td><td>public</td><td>division_status</td><td>3</td></tr></tbody></table><p>As we can see, each row should also have a level assigned. For example, if table <code>users</code> directly references table <code>departments</code>, that's level 1. But, <code>department_status</code> is level 2 because <code>users</code> references <code>departments</code> and departments references <code>department_status</code>, and so on...</p><p>Simple, right? It is just another data-related task. Now, how would we do that?</p><p>Let's start with a basic query.</p><h2 id="basic-query">Basic Query</h2><p>A basic query is the PostgreSQL system query that will query system tables to fetch information about direct references. It's a rather complicated query, and I won't get into it, but for the sake of simplicity, let's create a view out of it:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">view</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">fk_tables</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span></span>
<span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    con.schema </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    cl2.relname </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    ns.nspname </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    cl.relname </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> fk_table_name</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    (</span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        unnest(con1.conkey) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> parent, </span></span>
<span class="line"><span style="color: #E6E6E6">        unnest(con1.confkey) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> child, </span></span>
<span class="line"><span style="color: #E6E6E6">        con1.confrelid, </span></span>
<span class="line"><span style="color: #E6E6E6">        con1.conrelid,</span></span>
<span class="line"><span style="color: #E6E6E6">        con1.contype,</span></span>
<span class="line"><span style="color: #E6E6E6">        ns.nspname </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">schema</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        pg_class cl</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> pg_namespace ns </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> cl.relnamespace </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> ns.oid</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> pg_constraint con1 </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> con1.conrelid </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> cl.oid</span></span>
<span class="line"><span style="color: #E6E6E6">    ) con</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> pg_attribute att </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> att.attrelid </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> con.confrelid </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> att.attnum </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> con.child</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> pg_class cl </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> cl.oid </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> con.confrelid</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> pg_attribute att2 </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> att2.attrelid </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> con.conrelid </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> att2.attnum </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> con.parent</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> pg_class cl2 </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> cl2.oid </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> att2.attrelid</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> pg_namespace ns </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> cl.relnamespace </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> ns.oid;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">comment on view fk_tables is </span><span style="color: #CE9178">'Retuls list of all tables and join related tables for each table.'</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">view</span><span style="color: #000000"> </span><span style="color: #795E26">fk_tables</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span></span>
<span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    con.schema </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_schema,</span></span>
<span class="line"><span style="color: #000000">    cl2.relname </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_name,</span></span>
<span class="line"><span style="color: #000000">    ns.nspname </span><span style="color: #0000FF">as</span><span style="color: #000000"> fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">    cl.relname </span><span style="color: #0000FF">as</span><span style="color: #000000"> fk_table_name</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        unnest(con1.conkey) </span><span style="color: #0000FF">as</span><span style="color: #000000"> parent, </span></span>
<span class="line"><span style="color: #000000">        unnest(con1.confkey) </span><span style="color: #0000FF">as</span><span style="color: #000000"> child, </span></span>
<span class="line"><span style="color: #000000">        con1.confrelid, </span></span>
<span class="line"><span style="color: #000000">        con1.conrelid,</span></span>
<span class="line"><span style="color: #000000">        con1.contype,</span></span>
<span class="line"><span style="color: #000000">        ns.nspname </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">schema</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        pg_class cl</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> pg_namespace ns </span><span style="color: #0000FF">on</span><span style="color: #000000"> cl.relnamespace = ns.oid</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> pg_constraint con1 </span><span style="color: #0000FF">on</span><span style="color: #000000"> con1.conrelid = cl.oid</span></span>
<span class="line"><span style="color: #000000">    ) con</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> pg_attribute att </span><span style="color: #0000FF">on</span><span style="color: #000000"> att.attrelid = con.confrelid </span><span style="color: #0000FF">and</span><span style="color: #000000"> att.attnum = con.child</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> pg_class cl </span><span style="color: #0000FF">on</span><span style="color: #000000"> cl.oid = con.confrelid</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> pg_attribute att2 </span><span style="color: #0000FF">on</span><span style="color: #000000"> att2.attrelid = con.conrelid </span><span style="color: #0000FF">and</span><span style="color: #000000"> att2.attnum = con.parent</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> pg_class cl2 </span><span style="color: #0000FF">on</span><span style="color: #000000"> cl2.oid = att2.attrelid</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> pg_namespace ns </span><span style="color: #0000FF">on</span><span style="color: #000000"> cl.relnamespace = ns.oid;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">comment on view fk_tables is </span><span style="color: #A31515">'Retuls list of all tables and join related tables for each table.'</span><span style="color: #000000">;</span></span></code></pre></div><p>Fine, it's ugly and dirty; don't even look at it.</p><p>Use it as a view, for example:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> fk_tables </span></span>
<span class="line"><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'public'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'users'</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> * </span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> fk_tables </span></span>
<span class="line"><span style="color: #0000FF">where</span><span style="color: #000000"> table_schema = </span><span style="color: #A31515">'public'</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> table_name = </span><span style="color: #A31515">'users'</span><span style="color: #000000">;</span></span></code></pre></div><p>This will return first-level references for the table <code>users</code>:</p><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th>table_schema</th><th>table_name</th><th>fk_table_schema</th><th>fk_table_name</th></tr></thead><tbody class="table-group-divider"><tr><td>public</td><td>users</td><td>public</td><td>departments</td></tr><tr><td>public</td><td>users</td><td>public</td><td>users</td></tr></tbody></table><p>Now, all we have to do is run the same query again for each of these FK tables in this results, and we're done.</p><p>That's why it's called recursion.</p><h2 id="solution-1">Solution 1</h2><p>Luckily for us, PostgreSQL has <a href="https://www.postgresql.org/docs/current/queries-with.html#QUERIES-WITH-RECURSIVE">recursive common-table queries</a> as a standard feature, and we can do the first solution with that.</p><p>For a recursion seed, we can use the filter on our <code>fk_tables</code> view.</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    t.table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.fk_table_name</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_tables t</span></span>
<span class="line"><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    t.table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'public'</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'users'</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    t.table_schema,</span></span>
<span class="line"><span style="color: #000000">    t.table_name,</span></span>
<span class="line"><span style="color: #000000">    t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">    t.fk_table_name</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    fk_tables t</span></span>
<span class="line"><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    t.table_schema = </span><span style="color: #A31515">'public'</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">and</span><span style="color: #000000"> t.table_name = </span><span style="color: #A31515">'users'</span></span></code></pre></div><p>In the recursive part, we can return the FK table as the base table and join the <code>fk_tables</code> view again to get the real FK tables like this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    rec.fk_table_schema </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    rec.fk_table_name </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.fk_table_name</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    _recursive_cte rec</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> fk_tables t </span><span style="color: #569CD6">on</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.fk_table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.table_schema </span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> rec.fk_table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.table_name</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    rec.fk_table_schema </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_schema,</span></span>
<span class="line"><span style="color: #000000">    rec.fk_table_name </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_name,</span></span>
<span class="line"><span style="color: #000000">    t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">    t.fk_table_name</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    _recursive_cte rec</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> fk_tables t </span><span style="color: #0000FF">on</span></span>
<span class="line"><span style="color: #000000">        rec.fk_table_schema = t.table_schema </span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">and</span><span style="color: #000000"> rec.fk_table_name = t.table_name</span></span></code></pre></div><p>All together, it should look like this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_name</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        fk_tables t</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'public'</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'users'</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union</span><span style="color: #E6E6E6"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.fk_table_schema </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.fk_table_name </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_name</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> fk_tables t </span><span style="color: #569CD6">on</span></span>
<span class="line"><span style="color: #E6E6E6">            rec.fk_table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.table_schema </span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> rec.fk_table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.table_name    </span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    table_schema,   </span></span>
<span class="line"><span style="color: #E6E6E6">    table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_name</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    _recursive_cte</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        t.table_schema,</span></span>
<span class="line"><span style="color: #000000">        t.table_name,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_name</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        fk_tables t</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        t.table_schema = </span><span style="color: #A31515">'public'</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">and</span><span style="color: #000000"> t.table_name = </span><span style="color: #A31515">'users'</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">union</span><span style="color: #000000"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        rec.fk_table_schema </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_schema,</span></span>
<span class="line"><span style="color: #000000">        rec.fk_table_name </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_name,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_name</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> fk_tables t </span><span style="color: #0000FF">on</span></span>
<span class="line"><span style="color: #000000">            rec.fk_table_schema = t.table_schema </span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">and</span><span style="color: #000000"> rec.fk_table_name = t.table_name    </span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    table_schema,   </span></span>
<span class="line"><span style="color: #000000">    table_name,</span></span>
<span class="line"><span style="color: #000000">    fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">    fk_table_name</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    _recursive_cte</span></span></code></pre></div><p>Confusing? We have yet to start with the confusing part.</p><p>Anyway, this query will return all FK tables for <code>users</code> at all levels:</p><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th>table_schema</th><th>table_name</th><th>fk_table_schema</th><th>fk_table_name</th></tr></thead><tbody class="table-group-divider"><tr><td>public</td><td>users</td><td>public</td><td>departments</td></tr><tr><td>public</td><td>users</td><td>public</td><td>users</td></tr><tr><td>public</td><td>departments</td><td>public</td><td>users</td></tr><tr><td>public</td><td>departments</td><td>public</td><td>departments</td></tr><tr><td>public</td><td>departments</td><td>public</td><td>divisions</td></tr><tr><td>public</td><td>departments</td><td>public</td><td>department_status</td></tr><tr><td>public</td><td>divisions</td><td>public</td><td>users</td></tr><tr><td>public</td><td>divisions</td><td>public</td><td>divisions</td></tr><tr><td>public</td><td>divisions</td><td>public</td><td>division_status</td></tr></tbody></table><p>However, we still need levels. We can count it manually, but we'd rather have instead the database engine do it.</p><p>First naive try it to add level 1 at recursion seed like this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    t.table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_tables t</span></span>
<span class="line"><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    t.table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'public'</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'users'</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    t.table_schema,</span></span>
<span class="line"><span style="color: #000000">    t.table_name,</span></span>
<span class="line"><span style="color: #000000">    t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">    t.fk_table_name,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    fk_tables t</span></span>
<span class="line"><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    t.table_schema = </span><span style="color: #A31515">'public'</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">and</span><span style="color: #000000"> t.table_name = </span><span style="color: #A31515">'users'</span></span></code></pre></div><p>And have it increased by one in each recursion step:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    rec.fk_table_schema </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    rec.fk_table_name </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    rec.level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    _recursive_cte rec</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> fk_tables t </span><span style="color: #569CD6">on</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.fk_table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.table_schema </span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> rec.fk_table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.table_name</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    rec.fk_table_schema </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_schema,</span></span>
<span class="line"><span style="color: #000000">    rec.fk_table_name </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_name,</span></span>
<span class="line"><span style="color: #000000">    t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">    t.fk_table_name,</span></span>
<span class="line"><span style="color: #000000">    rec.level + </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    _recursive_cte rec</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> fk_tables t </span><span style="color: #0000FF">on</span></span>
<span class="line"><span style="color: #000000">        rec.fk_table_schema = t.table_schema </span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">and</span><span style="color: #000000"> rec.fk_table_name = t.table_name</span></span></code></pre></div><p>This is very naive. We have a <code>union</code> of seed query and recursion query. The <code>union</code> operator filters out duplicate records by default. From the moment we've introduced a level number that is unique, duplicates won't be filtered out. And since <code>users</code> references <code>departments</code> and <code>departments</code> references <code>users</code> again, the query will end up in an infinite loop, which potentially could crash the server.</p><p>So this is reckless and even dangerous.</p><p>What we have here is a very well-known data problem - the gap and islands problem.</p><p>What we want to do is this:</p><ul><li>keep the sort order and</li><li>on each change in <code>table_schema</code> and <code>table_name</code> - increase the counter by one.</li></ul><p>To be able to do this, we first need to add two more calculated fields:</p><ul><li>Row number - we will use this just to keep the sort order.</li><li>Calculated field that is 1 when the table in a row changed from the previous row. Otherwise, it is 0.</li></ul><p>Here is what it looks like:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    table_schema,   </span></span>
<span class="line"><span style="color: #E6E6E6">    table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">row_number</span><span style="color: #E6E6E6">() </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6">(),</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">case</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">when</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">lag</span><span style="color: #E6E6E6">(table_schema) </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6">() </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> table_schema </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">lag</span><span style="color: #E6E6E6">(table_name) </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6">() </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> table_name </span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">then</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">else</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> island_flips</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    _recursive_cte</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    table_schema,   </span></span>
<span class="line"><span style="color: #000000">    table_name,</span></span>
<span class="line"><span style="color: #000000">    fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">    fk_table_name,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #795E26">row_number</span><span style="color: #000000">() </span><span style="color: #0000FF">over</span><span style="color: #000000">(),</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">when</span><span style="color: #000000"> </span><span style="color: #795E26">lag</span><span style="color: #000000">(table_schema) </span><span style="color: #0000FF">over</span><span style="color: #000000">() = table_schema </span><span style="color: #0000FF">and</span><span style="color: #000000"> </span><span style="color: #795E26">lag</span><span style="color: #000000">(table_name) </span><span style="color: #0000FF">over</span><span style="color: #000000">() = table_name </span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">then</span><span style="color: #000000"> </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> island_flips</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    _recursive_cte</span></span></code></pre></div><p>We can wrap this into another CTE and do the last calculation in the final query:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    table_schema,   </span></span>
<span class="line"><span style="color: #E6E6E6">    table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    island_flips,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">sum</span><span style="color: #E6E6E6">(island_flips) </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6"> (</span><span style="color: #569CD6">order by</span><span style="color: #E6E6E6"> row_number) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    _cte</span></span>
<span class="line"><span style="color: #569CD6">order by</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    row_number</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    table_schema,   </span></span>
<span class="line"><span style="color: #000000">    table_name,</span></span>
<span class="line"><span style="color: #000000">    fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">    fk_table_name,</span></span>
<span class="line"><span style="color: #000000">    island_flips,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #795E26">sum</span><span style="color: #000000">(island_flips) </span><span style="color: #0000FF">over</span><span style="color: #000000"> (</span><span style="color: #0000FF">order by</span><span style="color: #000000"> row_number) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    _cte</span></span>
<span class="line"><span style="color: #0000FF">order by</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    row_number</span></span></code></pre></div><p>Field <code>island_flips</code> will be one if the previous table is different; otherwise, it is 0. Now, if we do a cumulative sum over those values with <code>sum(island_flips) over (order by row_number) as level</code> - we will get the correct levels.</p><p>Here is the final version of the plain SQL function:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_foreign_tables</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    _table_name </span><span style="color: #569CD6">text</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_name</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        fk_tables t</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_schema</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_name</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union</span><span style="color: #E6E6E6"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.fk_table_schema </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.fk_table_name </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_name</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> fk_tables t </span><span style="color: #569CD6">on</span></span>
<span class="line"><span style="color: #E6E6E6">            rec.fk_table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.table_schema </span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> rec.fk_table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.table_name    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">), _cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        table_schema,   </span></span>
<span class="line"><span style="color: #E6E6E6">        table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">        fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">row_number</span><span style="color: #E6E6E6">() </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6">(),</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">case</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">when</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">lag</span><span style="color: #E6E6E6">(table_schema) </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6">() </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> table_schema </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">lag</span><span style="color: #E6E6E6">(table_name) </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6">() </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> table_name </span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">then</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">else</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> island_flips</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        _recursive_cte</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    table_schema,   </span></span>
<span class="line"><span style="color: #E6E6E6">    table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">sum</span><span style="color: #E6E6E6">(island_flips) </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6"> (</span><span style="color: #569CD6">order by</span><span style="color: #E6E6E6"> row_number) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    _cte</span></span>
<span class="line"><span style="color: #569CD6">order by</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    row_number</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_foreign_tables</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    _table_name </span><span style="color: #0000FF">text</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    fk_table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    fk_table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        t.table_schema,</span></span>
<span class="line"><span style="color: #000000">        t.table_name,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_name</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        fk_tables t</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        t.table_schema = _table_schema</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">and</span><span style="color: #000000"> t.table_name = _table_name</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">union</span><span style="color: #000000"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        rec.fk_table_schema </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_schema,</span></span>
<span class="line"><span style="color: #000000">        rec.fk_table_name </span><span style="color: #0000FF">as</span><span style="color: #000000"> table_name,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_name</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> fk_tables t </span><span style="color: #0000FF">on</span></span>
<span class="line"><span style="color: #000000">            rec.fk_table_schema = t.table_schema </span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">and</span><span style="color: #000000"> rec.fk_table_name = t.table_name    </span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">), _cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        table_schema,   </span></span>
<span class="line"><span style="color: #000000">        table_name,</span></span>
<span class="line"><span style="color: #000000">        fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">        fk_table_name,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #795E26">row_number</span><span style="color: #000000">() </span><span style="color: #0000FF">over</span><span style="color: #000000">(),</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">when</span><span style="color: #000000"> </span><span style="color: #795E26">lag</span><span style="color: #000000">(table_schema) </span><span style="color: #0000FF">over</span><span style="color: #000000">() = table_schema </span><span style="color: #0000FF">and</span><span style="color: #000000"> </span><span style="color: #795E26">lag</span><span style="color: #000000">(table_name) </span><span style="color: #0000FF">over</span><span style="color: #000000">() = table_name </span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">then</span><span style="color: #000000"> </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> island_flips</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        _recursive_cte</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    table_schema,   </span></span>
<span class="line"><span style="color: #000000">    table_name,</span></span>
<span class="line"><span style="color: #000000">    fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">    fk_table_name,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #795E26">sum</span><span style="color: #000000">(island_flips) </span><span style="color: #0000FF">over</span><span style="color: #000000"> (</span><span style="color: #0000FF">order by</span><span style="color: #000000"> row_number) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    _cte</span></span>
<span class="line"><span style="color: #0000FF">order by</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    row_number</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>Do you think this sounds complicated?</p><p>It sounds complicated because it is.</p><p>Let's try to solve this problem with a completely different approach.</p><h2 id="solution-2">Solution 2</h2><p>In this approach, we will use an old-school procedural programming approach - instead of using the recursive SQL query - we will use a normal function recursion as you would with any other language.</p><p>So, instead of creating a function of the <code>sql</code> type - this new function will be of the <code>plpgsql</code> type. This allows us to use procedural extensions like "if branching", "loops" and so on... Those are the concepts most developers are familiar with.</p><p>The idea is to create a temporary table that we will insert in recursive calls and return values from that temporary table on the last call.</p><p>The function skeleton will look like this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_foreign_tables2</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    _table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    _level </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">begin</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6"> _result (</span></span>
<span class="line"><span style="color: #E6E6E6">        table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        fk_table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        fk_table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result t </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_schema </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_name</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">-- </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">-- Insert  _result table in a loop with recursive calls here</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">--    </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        _result t;</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_foreign_tables2</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    _table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    _level </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    fk_table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    fk_table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">begin</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000"> _result (</span></span>
<span class="line"><span style="color: #000000">        table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        fk_table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        fk_table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result t </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.table_schema = _table_schema </span><span style="color: #0000FF">and</span><span style="color: #000000"> t.table_name = _table_name</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">-- </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">-- Insert  _result table in a loop with recursive calls here</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">--    </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        t.table_schema, </span></span>
<span class="line"><span style="color: #000000">        t.table_name,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">        t.fk_table_name,</span></span>
<span class="line"><span style="color: #000000">        t.level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        _result t;</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>What we first need to do is to create a temporary table:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6"> _result (</span></span>
<span class="line"><span style="color: #E6E6E6">    table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000"> _result (</span></span>
<span class="line"><span style="color: #000000">    table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    fk_table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    fk_table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span></code></pre></div><p>This table will be automatically dropped when transaction commits (or rollbacks). All PostgreSQL functions in procedural language are in transaction by default (notice <code>begin</code> and <code>end</code>).</p><p>When we call this function again in a recursion - it will still be the same transaction. The new transaction is merged into the existing transaction (PostgreSQL doesn't support nested transactions, as far as I know).</p><p>However, since it will be called recursively, that temp table may already exist. That's why we also need to check if it exists <code>create temp table if not exists</code>.</p><p>Next, we must check if we have gone through this step already. Meaning have we processed that table from parameters? If we have, exit immediately:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result t </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_schema </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_name</span></span>
<span class="line"><span style="color: #E6E6E6">) </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result t </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.table_schema = _table_schema </span><span style="color: #0000FF">and</span><span style="color: #000000"> t.table_name = _table_name</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span></code></pre></div><p>And now, we are ready to insert the data:</p><ul><li>Loop through the <code>fk_tables</code> view for table parameters and for each record:</li><li>Insert into the result.</li><li>Call recursively the same function again but use <code>fk_table_schema</code> and <code>fk_table_name</code> as parameters and increase one level.</li></ul><p>Here is what that loop looks like:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">for</span><span style="color: #E6E6E6"> _row </span><span style="color: #569CD6">in</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_name</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        fk_tables t</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_schema</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_name</span></span>
<span class="line"><span style="color: #E6E6E6">) </span><span style="color: #569CD6">loop</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> _result</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        _row.table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">        _row.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        _row.fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">        _row.fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        _level;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    perform sys.select_foreign_tables2(</span></span>
<span class="line"><span style="color: #E6E6E6">        _row.fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">        _row.fk_table_name, </span></span>
<span class="line"><span style="color: #E6E6E6">        _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">loop</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">for</span><span style="color: #000000"> _row </span><span style="color: #0000FF">in</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        t.table_schema,</span></span>
<span class="line"><span style="color: #000000">        t.table_name,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_name</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        fk_tables t</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        t.table_schema = _table_schema</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">and</span><span style="color: #000000"> t.table_name = _table_name</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">loop</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">insert into</span><span style="color: #000000"> _result</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        _row.table_schema, </span></span>
<span class="line"><span style="color: #000000">        _row.table_name,</span></span>
<span class="line"><span style="color: #000000">        _row.fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">        _row.fk_table_name,</span></span>
<span class="line"><span style="color: #000000">        _level;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    perform sys.select_foreign_tables2(</span></span>
<span class="line"><span style="color: #000000">        _row.fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">        _row.fk_table_name, </span></span>
<span class="line"><span style="color: #000000">        _level + </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">loop</span><span style="color: #000000">;</span></span></code></pre></div><p>And finally, the entire function:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_foreign_tables2</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    _table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    _level </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    fk_table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">declare</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    _row record;</span></span>
<span class="line"><span style="color: #569CD6">begin</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6"> _result (</span></span>
<span class="line"><span style="color: #E6E6E6">        table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        fk_table_schema </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        fk_table_name </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result t </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_schema </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_name</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">for</span><span style="color: #E6E6E6"> _row </span><span style="color: #569CD6">in</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">            t.table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">            t.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">            t.fk_table_schema,</span></span>
<span class="line"><span style="color: #E6E6E6">            t.fk_table_name</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">            fk_tables t</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">            t.table_schema </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_schema</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _table_name</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">loop</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> _result</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">            _row.table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">            _row.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">            _row.fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">            _row.fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">            _level;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        perform select_foreign_tables2(</span></span>
<span class="line"><span style="color: #E6E6E6">            _row.fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">            _row.fk_table_name, </span></span>
<span class="line"><span style="color: #E6E6E6">            _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">        );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">loop</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">        t.table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_schema, </span></span>
<span class="line"><span style="color: #E6E6E6">        t.fk_table_name,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        _result t;</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_foreign_tables2</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    _table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    _level </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    fk_table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    fk_table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">declare</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    _row record;</span></span>
<span class="line"><span style="color: #0000FF">begin</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000"> _result (</span></span>
<span class="line"><span style="color: #000000">        table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        fk_table_schema </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        fk_table_name </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result t </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.table_schema = _table_schema </span><span style="color: #0000FF">and</span><span style="color: #000000"> t.table_name = _table_name</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">for</span><span style="color: #000000"> _row </span><span style="color: #0000FF">in</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">            t.table_schema,</span></span>
<span class="line"><span style="color: #000000">            t.table_name,</span></span>
<span class="line"><span style="color: #000000">            t.fk_table_schema,</span></span>
<span class="line"><span style="color: #000000">            t.fk_table_name</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">            fk_tables t</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">            t.table_schema = _table_schema</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">and</span><span style="color: #000000"> t.table_name = _table_name</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">loop</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">insert into</span><span style="color: #000000"> _result</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">            _row.table_schema, </span></span>
<span class="line"><span style="color: #000000">            _row.table_name,</span></span>
<span class="line"><span style="color: #000000">            _row.fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">            _row.fk_table_name,</span></span>
<span class="line"><span style="color: #000000">            _level;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">        perform select_foreign_tables2(</span></span>
<span class="line"><span style="color: #000000">            _row.fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">            _row.fk_table_name, </span></span>
<span class="line"><span style="color: #000000">            _level + </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">        );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">loop</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        t.table_schema, </span></span>
<span class="line"><span style="color: #000000">        t.table_name,</span></span>
<span class="line"><span style="color: #000000">        t.fk_table_schema, </span></span>
<span class="line"><span style="color: #000000">        t.fk_table_name,</span></span>
<span class="line"><span style="color: #000000">        t.level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        _result t;</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2><p>Which of these two approaches is better, in your opinion?</p><p>Recursive CTE queries are powerful but confusing and limiting. This old-school procedural programming approach may be a much better fit for developers untrained with SQL, and that is, in my opinion, the majority. On the other hand, the procedural approach may be something most developers feel comfortable with.</p><p>Leave comments below.</p><div class="my-5 px-5 border-top links svelte-1bxfgrx"><div><div class="link-title text-start svelte-1bxfgrx text-muted">PREVIOUS</div></div><div><div class="link-title text-end svelte-1bxfgrx">NEXT</div><a class="btn text-end" href="/blog/recursion-postgresql/part2-performances">Part 2 - Performances</a></div></div><div class="w-fit mx-auto mt-5 mb-3 border-top"><div class="alert text-center fs-smaller text-muted">To receive notifications about new posts and updates, consider subscribing to my LinkdIn page:<br><a class="btn btn-sm" href="https://www.linkedin.com/in/vb-software/"><i class="bi-linkedin"></i> <span class="text-primary">vb-software linkedin</span></a><br><br>You will receive notifications about new posts on your LinkedIn feed.</div></div><div class="pt-5 border-top"><div id="comments-section" class="h5">Comments</div><script defer src="https://cdn.commento.io/js/commento.js" data-no-fonts="true" data-css-override="https://vb-consulting.github.io/style.css"></script><div id="commento"></div></div><footer class="mt-3 py-5"><div class="w-fit mx-auto mb-3 border-top border-bottom"><div class="alert text-center fs-smaller text-muted"><div class="alert text-center fs-smaller text-muted mb-1">If you like my content, use my software, or otherwise benefit from my work, consider supporting me by buying me a coffee. The software runs on coffee after all.</div><a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="Click Here to Buy Me a Coffee Or Scan the Code" href="https://www.buymeacoffee.com/vbilopavu" style="display: inline-grid;">Buy me a Coffee <img class="m-auto svelte-byttq0" alt="Scan Here To Buy Me a Cofee" src="/bmc_qr.png"></a></div></div><div class="d-flex justify-content-center"><a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="I Post Software Development Content Daily" href="https://www.linkedin.com/in/vb-software/" style="display: inline-grid;">Follow me on LinkedIn <i class="bi bi-linkedin"></i></a></div><div class="text-center"><div class="mt-5 mb-5 background-floki svelte-byttq0" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog."></div></div></footer><div class="mb-5"></div></div></div><div class="rightside svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">on this page</span><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="recursion-with-postgresql-part-1---a-different-type-of-recursion" title="Recursion with PostgreSQL Part 1 - A Different Type of Recursion"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#recursion-with-postgresql-part-1---a-different-type-of-recursion">Recursion with PostgreSQL Part 1 - A Different Type of Recursion</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="the-problem" title="The Problem"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#the-problem">The Problem</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="basic-query" title="Basic Query"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#basic-query">Basic Query</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="solution-1" title="Solution 1"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#solution-1">Solution 1</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="solution-2" title="Solution 2"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#solution-2">Solution 2</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="conclusion" title="Conclusion"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#conclusion">Conclusion</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="comments-section" title="Comments"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#comments-section">Comments</a></li><li><hr class="svelte-9zwk14"><div class="navbar-nav sidenav"><div class="text-muted fs-_7rem mx-2">NEXT</div><a class="btn btn-sm text-start sidebar-link" href="/blog/recursion-postgresql/part2-performances"><span class="svelte-9zwk14">Part 2 - Performances</span></a></div></li></ul></div></div></main><script>!function(){var i=document.querySelector("nav.navbar"),f=document.getElementsByTagName("main")[0],L=f.getElementsByClassName("sidebar")[0],w=f.getElementsByClassName("content")[0],o=document.querySelectorAll("div.code"),k=i.querySelector(".home");function E(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n])}function T(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n]);E(e,t),e.classList.add(t)}function t(e,t){var n=e.currentTarget;if(!n.classList.contains("bi-check")){for(var i="",o=0;o<n.classList.length;o++)if(n.classList[o].startsWith("bi-")){i=n.classList[o];break}n.classList.remove(i),n.classList.add("spinner-border-sm"),n.classList.add("spinner-border");e=bootstrap.Tooltip.getInstance(n);e&&(e.setContent({".tooltip-inner":"Copying..."}),e.show()),t(n,function(){var e;n.classList.remove(i),n.classList.remove("spinner-border-sm"),n.classList.remove("spinner-border"),n.classList.add("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&(e.setContent({".tooltip-inner":"Copied!"}),e.show()),setTimeout(function(){var e;n.classList.add(i),n.classList.remove("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&e.setContent({".tooltip-inner":n.dataset.bsTitle})},2e3)})}}"/"==document.location.pathname&&T(k,"d-none");var e=document.querySelector(".post-share > .copy-url"),n=(e&&e.addEventListener("click",function(e){t(e,function(e,t){navigator.clipboard.writeText(document.location.origin+document.location.pathname),t()})}),document.getElementsByTagName("html")[0]),a=i.querySelector("#theme-btn"),s="theme";function l(e){var t=a.getElementsByTagName("svg");"dark"===e?(t[0].style.display="",t[1].style.display="none",a.getElementsByClassName("check")[0].classList.add("checked")):(t[0].style.display="none",t[1].style.display="",a.getElementsByClassName("check")[0].classList.remove("checked"));for(var n=0;n<o.length;n++){var i=o[n];"dark"===e?(i.children[1].style.display="inherit",i.children[2].style.display="none"):"light"===e&&(i.children[1].style.display="none",i.children[2].style.display="inherit")}window._theme&&window._theme(e)}function r(e){t(e,function(e,t){navigator.clipboard.writeText(e.parentElement.nextSibling.innerText),t()})}function c(e){t(e,function(e,t){var n=localStorage.getItem(s);e="dark"===n?e.parentElement.parentElement.children[1]:e.parentElement.parentElement.children[2],setTimeout(function(){html2canvas(e).then(e=>{e.toBlob(e=>navigator.clipboard.write([new ClipboardItem({"image/png":e})])),t()})},0)})}a.addEventListener("click",()=>{var e="dark"===localStorage.getItem(s)?"light":"dark";localStorage.setItem(s,e),l(n.dataset.bsTheme=e)}),l(localStorage.getItem(s)),a.children[0].classList.remove("hidden");for(var d=0;d<o.length;d++){o[d].getElementsByClassName("copy-code")[0].addEventListener("click",r);var m=o[d].getElementsByClassName("photo-code");m.length&&m[0].addEventListener("click",c)}for(var S=function(){var a,o,s;if(f.children[2]&&"none"!=f.children[2].style.display)return a=f.querySelector(".main-content").querySelectorAll("[id]"),o=void 0,this.initNavs=function(e){s=e.querySelectorAll("li.bookmark-nav");for(var t=0;t<a.length;t++){for(var n=a[t].id,i=null,o=0;o<s.length;o++)if(s[o].dataset.id==n){i=s[o];break}a[t].nav=i}setTimeout(function(){for(var e=0;e<a.length;e++){var t=a[e];if(l(t).visible&&t.nav)return void t.nav.classList.add("active")}},1e3),r()},f.children[1].addEventListener("scroll",r),this;function l(e){var e=e.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight),n=0<e.top&&!(e.bottom<0||0<=e.top-t)||e.top<0&&e.bottom>t,i=!1;return{visible:n,above:i=n?i:e.bottom<t}}function r(){if(s&&s.length){for(var e=0;e<s.length;e++)s[e].classList.remove("active");for(var t=void 0,e=0;e<a.length;e++){const i=a[e];var n=l(i);if(!n.visible&&n.above&&(t=i.nav),n.visible&&i.nav&&!i.nav.classList.contains("active"))return i.nav.classList.add("active"),o&&clearTimeout(o),void(o=setTimeout(function(){i.nav.scrollIntoView({behavior:"smooth"}),o=void 0},250))}t&&!t.classList.contains("active")&&(t.classList.add("active"),o&&clearTimeout(o),o=setTimeout(function(){t.scrollIntoView({behavior:"smooth"}),o=void 0},250))}}}(),h=function(){var l,r=i.querySelector("#nav-btn"),c=480,d="200px",m="0.25fr",h=730,v=535,u=f.children[0].children[0].children[0],g=f.children[2]&&f.children[2].children[0].children[0],t="sidebar-pinned",p=null==localStorage.getItem(t)||"true"==localStorage.getItem(t),y=!1,b=!1;function n(){window._onresize&&window._onresize();var e=window.outerWidth||window.innerWidth,t=e<c,n=t?y?"100%":"0":p?""+d:"0",i=`grid-template-columns: ${n} 1fr`,o=t&&y?"width: 100%":"0"!=n?"":"display: none",a=t&&y?"display: none":"",s=t?y?"sidebar-show":"sidebar-hide":p?"sidebar-show":"sidebar-hide",n="0"==n;f.children[2]&&(m&&h&&v&&(n&&e<v||!n&&e<h?b||(u.innerHTML=l+g.innerHTML,S.initNavs(u),b=!0):b&&(u.innerHTML=l,S.initNavs(g),b=!1)),!m||t||b?(i+=";",f.children[2].style.display="none"):(i+=` ${m};`,f.children[2].style.display="")),T(r,!t&&p||t&&y?"rotate":"rotate-back","rotate","rotate-back"),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),f.style=L?i:"display: grid;",L&&T(L,s,"sidebar-show","sidebar-hide"),L&&(L.firstChild.style=o),w.style=a,t&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),t&&y&&T(k,"d-none")}function e(){var e=window.outerWidth<c;e?y=!y:p=!p,localStorage.setItem(t,p.toString()),n(),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),e&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),e&&y&&T(k,"d-none")}return m&&h&&v&&g&&(l=u.innerHTML,S.initNavs(g)),r.addEventListener("click",e),(window.onresize=n)(),this.closeSidebar=function(){window.outerWidth<c&&y&&e()},this}(),v=document.getElementsByClassName("auto-close"),u=0;u<v.length;u++)v[u].addEventListener("click",function(e){h.closeSidebar()});location.hash&&(e=document.getElementById(location.hash.replace("#","")))&&e.scrollIntoView()}();</script><script src="/bootstrap.bundle.min.js"></script><script>!function(){for(var e=document.querySelectorAll('[data-bs-toggle="tooltip"]'),t=0;t<e.length;t++)new bootstrap.Tooltip(e[t]);var n=document.getElementsByClassName("accordion-item");if(n.length){for(t=0;t<n.length;t++){var o=n[t];o.querySelectorAll("[href='"+document.location.pathname+"']").length&&o.firstChild.click()}var l=document.querySelector("nav.navbar").querySelector(".home"),a=document.getElementsByClassName("accordion");"/"==document.location.pathname&&l.classList.add("d-none");for(t=0;t<n.length;t++){var s=a[t];s&&s.firstChild&&"VB-Consulting"==s.firstChild.title&&(null!=s.firstChild.querySelector(".collapse")&&l.classList.contains("d-none")&&"/"!=document.location.pathname&&l.classList.remove("d-none"),s.addEventListener("show.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none"),l.classList.add("d-none")}),s.addEventListener("hide.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none")}))}}}();</script><script src="/html2canvas.min.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script></body><script async data-id="101435862" src="//static.getclicky.com/js"></script></html>