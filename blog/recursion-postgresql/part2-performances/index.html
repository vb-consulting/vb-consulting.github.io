<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Recursion with PostgreSQL Part 2 - Performances</title><meta name="description" content="Follow-Up 1 on PostgreSQL recursive function. Some performance optimizations."><link href="https://vb-consulting.github.io/blog/recursion-postgresql/part2-performances/" rel="canonical"><meta name="keywords" content="postgresql, sql, plpgsql, recursion, tree, cte, function"><meta name="author" content="floki"><meta prefix="og: http://ogp.me/ns#" property="og:title" content="Recursion with PostgreSQL Part 2 - Performances"><meta prefix="og: http://ogp.me/ns#" property="og:description" content="Follow-Up 1 on PostgreSQL recursive function. Some performance optimizations."><meta prefix="og: http://ogp.me/ns#" property="og:image" content="https://vb-consulting.github.io/neretva.jpg"><meta prefix="og: http://ogp.me/ns#" property="og:type" content="article"><meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="VB-Consulting"><meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://vb-consulting.github.io/blog/recursion-postgresql/part2-performances/"><meta name="twitter:image" content="https://vb-consulting.github.io/neretva.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:description" content="Follow-Up 1 on PostgreSQL recursive function. Some performance optimizations."><link rel="stylesheet" href="/_elderjs/assets/svelte-3fcf0cc9.css" media="all"><style></style><link href="/style.css?1719909617592" rel="stylesheet"><script>!function(){var e="theme",t=localStorage.getItem(e);t||(t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",localStorage.setItem(e,t)),document.getElementsByTagName("html")[0].dataset.bsTheme=t}();</script></head><body class="d-flex flex-column h-100"><header id="header"><nav class="navbar navbar-expand-md navbar-dark fixed-top py-0 py-md-0 svelte-30jr7w"><div class="container-fluid flex-nowrap svelte-30jr7w"><div class="d-flex svelte-30jr7w"><button id="nav-btn" type="button" class="d-flex btn btn-sm logo animate-rotate svelte-30jr7w"><i class="material-icons-outlined">menu</i></button> <a class="nav-link my-auto ms-2 fw-semibold home svelte-30jr7w" href="/"><i class="bi-chevron-double-left"></i> VB Home</a></div><div class="d-flex right svelte-30jr7w"><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Become a Patreon" href="https://www.patreon.com/vbconsulting" target="_blank"><div class="patreon"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Buy Me a Coffee" href="https://www.buymeacoffee.com/vbilopavu" target="_blank"><div class="bmc"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto me-2 svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="vb-consulting on GitHub" href="https://github.com/vb-consulting/"><i class="bi-github"></i></a> <a class="github-button svelte-30jr7w" href="https://github.com/vb-consulting/" data-bs-toggle="tooltip" data-bs-html="true" title="Star vb-consulting on GitHub" data-color-scheme="no-preference: light_high_contrast; light: light_high_contrast; dark: light_high_contrast;" data-icon="octicon-star" data-show-count="true" aria-label="Star vb-consulting on GitHub"></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><button id="theme-btn" type="button" aria-pressed="true" aria-label="theme" class="svelte-30jr7w"><span class="check hidden svelte-30jr7w"><span class="icon svelte-30jr7w"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><path fill="currentColor" d="M12 21q-3.775 0-6.388-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.625-.075.975.45t-.025 1.1q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.525-.35 1.075-.037t.475.987q-.35 3.45-2.937 5.725T12 21Zm0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19Zm-.25-6.75Z"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M0 0h24v24H0z"></path><path fill="currentColor" d="M12 19a1 1 0 0 1 .993.883L13 20v1a1 1 0 0 1-1.993.117L11 21v-1a1 1 0 0 1 1-1zm6.313-2.09l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7a1 1 0 0 1 1.218-1.567l.102.07zm-11.306.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM4 11a1 1 0 0 1 .117 1.993L4 13H3a1 1 0 0 1-.117-1.993L3 11h1zm17 0a1 1 0 0 1 .117 1.993L21 13h-1a1 1 0 0 1-.117-1.993L20 11h1zM6.213 4.81l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7A1 1 0 0 1 6.11 4.74l.102.07zm12.894.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM12 2a1 1 0 0 1 .993.883L13 3v1a1 1 0 0 1-1.993.117L11 4V3a1 1 0 0 1 1-1zm0 5a5 5 0 1 1-4.995 5.217L7 12l.005-.217A5 5 0 0 1 12 7z"></path></g></svg></span></span></button></div></div></nav></header><main class="svelte-9zwk14"><div class="sidebar sidebar-hide svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-item svelte-9zwk14" data-id="" title="VB-Consulting"><a class="nav-link svelte-9zwk14 text-uppercase" href="/">VB-Consulting</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="NpgsqlRest"><a class="nav-link svelte-9zwk14 text-uppercase" href="/npgsqlrest/">NpgsqlRest</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="Norm.Net"><a class="nav-link svelte-9zwk14 text-uppercase" href="/norm.net/">Norm.Net</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="RazorSvelte"><a class="nav-link svelte-9zwk14 text-uppercase" href="/razorsvelte/">RazorSvelte</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PgRoutiner"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pgroutiner/">PgRoutiner</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="XUnit.Npgsql"><a class="nav-link svelte-9zwk14 text-uppercase" href="/xunit.npgsql/">XUnit.Npgsql</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="pgmigrations"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pgmigrations/">pgmigrations</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PostrgeSQL Schema Tools"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pg_schema_tools/">PostrgeSQL Schema Tools</a></li><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">blogs</span><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="See all blogs..."><a class="nav-link btn btn-sm w-fit px-3 mx-auto svelte-9zwk14 lr-arrow text-uppercase" href="/blogs/"><i class="bi bi-arrow-right-circle svelte-9zwk14"></i> <span class="btn-link">ALL BLOGS</span></a></li><li class="nav-item svelte-9zwk14" data-id="" title="Unit Testing and TDD With PostgreSQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/unit-testing-postgresql/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Unit Testing and TDD With PostgreSQL is Easy</a></li><li class="nav-item svelte-9zwk14" data-id="" title="From Transaction Scripts and Domain Model to SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/domain-model-transaction-script/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>From Transaction Scripts and Domain Model to SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Transaction Script DDD vs SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/transaction-script/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Transaction Script DDD vs SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Common Sense Software Design Approach for RDBMS-backed Type of Software"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/common-sense-design/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Common Sense Software Design</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-v2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest v2 Update üêòüî•</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-update1.6.2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest Update 1.6.2</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL Array Example"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-array/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Arrays üêò</a></li><li class="nav-item svelte-9zwk14" data-id="" title="How DDD is screwing up your SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/sql-vs-ddd/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>How DDD is screwing up your SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL Paging Benchmarks"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-paging/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Paging Benchmarks</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest NuGet Library</a></li></ul></div></div><div class="content svelte-9zwk14"><div class="banner svelte-1bxfgrx" style="background-image: url(/neretva.jpg); background-position: bottom; background-blend-mode: luminosity;"></div><div class="container-sm main-content blog svelte-1bxfgrx bannered"><div class="blog-head svelte-1bxfgrx"><a href="https://github.com/vb-consulting/blog/blob/master/LICENSE" class="text-shadow svelte-1bxfgrx" style="color: white">CC0-1.0 license</a></div><div class="categories svelte-1bxfgrx"><a href="/blogs/postgresql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># postgresql</span> </a><a href="/blogs/plpgsql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># plpgsql</span> </a><a href="/blogs/sql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># sql</span></a></div><h1 class="text-shadow" id="recursion-with-postgresql-part-2---performances">Recursion with PostgreSQL Part 2 - Performances</h1><div class="post-meta text-shadow"><div></div><div class="post-details"><div class="post-pic" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog." style="background-image: url(/floki2.jpg)"></div><div class="post-details-right"><div class="post-share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Frecursion-postgresql%2Fpart2-performances%2F" class="me-1 bi-linkedin" data-bs-toggle="tooltip" data-bs-html="true" title="Share on LinkedIn"><i class=""></i></a> <a href="http://twitter.com/share?text=Recursion%20with%20PostgreSQL%20Part%202%20-%20Performances%0AFollow-Up%201%20on%20PostgreSQL%20recursive%20function.%20Some%20performance%20optimizations.%0A&url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Frecursion-postgresql%2Fpart2-performances%2F&hashtags=postgresql%2Cplpgsql%2Csql" class="me-1 bi-twitter-x" data-bs-toggle="tooltip" data-bs-html="true" title="Share on X"><i class=""></i></a> <a href="#" class="copy-url bi-clipboard" data-bs-toggle="tooltip" data-bs-html="true" title="Copy URL"><i class=""></i></a></div><div class="post-author">floki</div><div class="post-date">Sep 18, 2023</div></div></div></div><p>This is a follow-up article on my previous blog post <a href="https://github.com/vb-consulting/blog/discussions/1">A Different Type of SQL Recursion with PostgreSQL</a>.</p><p>Previously, I explored two different approaches to recursion with PostgreSQL.</p><p>Now, it's time to do some testing.</p><h2 id="testing">Testing</h2><p>Instead of a view on system tables that enables us to traverse table relationship tree, I've decided to create a simple test table:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">big_tree_test</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">      id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">      parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span></span>
<span class="line"><span style="color: #E6E6E6">  );</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">big_tree_test</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">      id </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">      parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span></span>
<span class="line"><span style="color: #000000">  );</span></span></code></pre></div><p>And then use a script to insert as many random values as I like:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #E6E6E6">do</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">declare</span><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    _max_rows </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1000</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    _max_group </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #569CD6">begin</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6"> big_tree_test;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">big_tree_test</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">        id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span></span>
<span class="line"><span style="color: #E6E6E6">    );</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">pg_temp</span><span style="color: #E6E6E6">.random_int(_min </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">, _max </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">) </span><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #CE9178">'select floor(random()* (_max - _min + 1) + _min)::int;'</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> big_tree_test</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">         </span><span style="color: #CE9178">'node_'</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">||</span><span style="color: #E6E6E6"> t1.id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class="line"><span style="color: #E6E6E6">         </span><span style="color: #CE9178">'node_'</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">||</span><span style="color: #E6E6E6"> t2.r </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> parent_id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> id, pg_temp.random_int(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">, _max_group) r</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">generate_series</span><span style="color: #E6E6E6">(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">, _max_rows) id</span></span>
<span class="line"><span style="color: #E6E6E6">        ) t1</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">cross join</span><span style="color: #E6E6E6"> lateral (</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">select distinct</span><span style="color: #E6E6E6"> pg_temp.random_int(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">, _max_rows) r</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">generate_series</span><span style="color: #E6E6E6">(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">, t1.r)</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> r </span><span style="color: #D4D4D4">&lt;></span><span style="color: #E6E6E6"> t1.id</span></span>
<span class="line"><span style="color: #E6E6E6">        ) t2;    </span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #000000">do</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">declare</span><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    _max_rows </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">1000</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    _max_group </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">25</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #0000FF">begin</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">drop</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000"> big_tree_test;</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">big_tree_test</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">        id </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span></span>
<span class="line"><span style="color: #000000">    );</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">pg_temp</span><span style="color: #000000">.random_int(_min </span><span style="color: #0000FF">int</span><span style="color: #000000">, _max </span><span style="color: #0000FF">int</span><span style="color: #000000">) </span><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">'select floor(random()* (_max - _min + 1) + _min)::int;'</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">insert into</span><span style="color: #000000"> big_tree_test</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">         </span><span style="color: #A31515">'node_'</span><span style="color: #000000"> || t1.id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class="line"><span style="color: #000000">         </span><span style="color: #A31515">'node_'</span><span style="color: #000000"> || t2.r </span><span style="color: #0000FF">as</span><span style="color: #000000"> parent_id</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">select</span><span style="color: #000000"> id, pg_temp.random_int(</span><span style="color: #098658">1</span><span style="color: #000000">, _max_group) r</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span><span style="color: #795E26">generate_series</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">, _max_rows) id</span></span>
<span class="line"><span style="color: #000000">        ) t1</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">cross join</span><span style="color: #000000"> lateral (</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">select distinct</span><span style="color: #000000"> pg_temp.random_int(</span><span style="color: #098658">1</span><span style="color: #000000">, _max_rows) r</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span><span style="color: #795E26">generate_series</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">, t1.r)</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">where</span><span style="color: #000000"> r &lt;> t1.id</span></span>
<span class="line"><span style="color: #000000">        ) t2;    </span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>This script will insert text nodes in groups. There are two parameters:</p><ul><li><code>_max_rows</code> - how many id rows will be generated</li><li><code>_max_groups</code> - any id can repeat to point to different parents how many times? Minimal 1, maximum this number.</li></ul><p>For <code>_max_rows = 10</code> and <code>_max_groups = 3</code>, this script will generate the following test set:</p><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th>id</th><th>parent_id</th></tr></thead><tbody class="table-group-divider"><tr><td>node_1</td><td>node_3</td></tr><tr><td>node_1</td><td>node_8</td></tr><tr><td>node_4</td><td>node_8</td></tr><tr><td>node_5</td><td>node_7</td></tr><tr><td>node_6</td><td>node_4</td></tr><tr><td>node_6</td><td>node_6</td></tr><tr><td>node_6</td><td>node_9</td></tr><tr><td>node_7</td><td>node_10</td></tr><tr><td>node_8</td><td>node_10</td></tr><tr><td>node_8</td><td>node_5</td></tr><tr><td>node_8</td><td>node_9</td></tr><tr><td>node_9</td><td>node_9</td></tr><tr><td>node_10</td><td>node_1</td></tr></tbody></table><p>So, based on a manual calculation, this is the result we need to get for processing a <code>node_1</code>:</p><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th>id</th><th>parent_id</th><th>level</th></tr></thead><tbody class="table-group-divider"><tr><td>node_1</td><td>node_3</td><td>1</td></tr><tr><td>node_1</td><td>node_8</td><td>1</td></tr><tr><td>node_8</td><td>node_10</td><td>2</td></tr><tr><td>node_8</td><td>node_5</td><td>2</td></tr><tr><td>node_8</td><td>node_9</td><td>2</td></tr><tr><td>node_10</td><td>node_1</td><td>3</td></tr><tr><td>node_5</td><td>node_7</td><td>3</td></tr><tr><td>node_9</td><td>node_9</td><td>3</td></tr><tr><td>node_7</td><td>node_10</td><td>4</td></tr></tbody></table><p>Finally, we can create new functions to work with table <code>big_tree_test</code>:</p><ul><li>The version that uses recursive CTE:</li></ul><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_nodes_recursive_cte</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        id,</span></span>
<span class="line"><span style="color: #E6E6E6">        parent_id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        big_tree_test</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union</span><span style="color: #E6E6E6"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.parent_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.parent_id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> big_tree_test t </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> rec.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">), _cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        id,</span></span>
<span class="line"><span style="color: #E6E6E6">        parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">row_number</span><span style="color: #E6E6E6">() </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6">(),</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">case</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">when</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">lag</span><span style="color: #E6E6E6">(id) </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6">() </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> id</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">then</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">else</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> island_flips</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        _recursive_cte</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    id,   </span></span>
<span class="line"><span style="color: #E6E6E6">    parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">sum</span><span style="color: #E6E6E6">(island_flips) </span><span style="color: #569CD6">over</span><span style="color: #E6E6E6"> (</span><span style="color: #569CD6">order by</span><span style="color: #E6E6E6"> row_number) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    _cte</span></span>
<span class="line"><span style="color: #569CD6">order by</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    row_number</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_nodes_recursive_cte</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        id,</span></span>
<span class="line"><span style="color: #000000">        parent_id</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        big_tree_test</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        id = _id</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">union</span><span style="color: #000000"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        rec.parent_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class="line"><span style="color: #000000">        t.parent_id</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> big_tree_test t </span><span style="color: #0000FF">on</span><span style="color: #000000"> rec.parent_id = t.id</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">), _cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        id,</span></span>
<span class="line"><span style="color: #000000">        parent_id,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #795E26">row_number</span><span style="color: #000000">() </span><span style="color: #0000FF">over</span><span style="color: #000000">(),</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">when</span><span style="color: #000000"> </span><span style="color: #795E26">lag</span><span style="color: #000000">(id) </span><span style="color: #0000FF">over</span><span style="color: #000000">() = id</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">then</span><span style="color: #000000"> </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> island_flips</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        _recursive_cte</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    id,   </span></span>
<span class="line"><span style="color: #000000">    parent_id,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #795E26">sum</span><span style="color: #000000">(island_flips) </span><span style="color: #0000FF">over</span><span style="color: #000000"> (</span><span style="color: #0000FF">order by</span><span style="color: #000000"> row_number) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    _cte</span></span>
<span class="line"><span style="color: #0000FF">order by</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    row_number</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><ul><li>The version that uses recursive function call:</li></ul><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_nodes_recursive_function</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    _level </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">declare</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    _row record;</span></span>
<span class="line"><span style="color: #569CD6">begin</span><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6"> _result (</span></span>
<span class="line"><span style="color: #E6E6E6">        id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result t </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">        </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">for</span><span style="color: #E6E6E6"> _row </span><span style="color: #569CD6">in</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">            t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">            t.parent_id</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">            big_tree_test t</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">            t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">loop</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> _result</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">            _row.id, </span></span>
<span class="line"><span style="color: #E6E6E6">            _row.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">            _level;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        perform select_nodes_recursive_function(</span></span>
<span class="line"><span style="color: #E6E6E6">            _row.parent_id, </span></span>
<span class="line"><span style="color: #E6E6E6">            _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">        );</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">loop</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        _result t;</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_nodes_recursive_function</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    _level </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">declare</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    _row record;</span></span>
<span class="line"><span style="color: #0000FF">begin</span><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000"> _result (</span></span>
<span class="line"><span style="color: #000000">        id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result t </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.id = _id</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">        </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">for</span><span style="color: #000000"> _row </span><span style="color: #0000FF">in</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">            t.id,</span></span>
<span class="line"><span style="color: #000000">            t.parent_id</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">            big_tree_test t</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">            t.id = _id</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">loop</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">insert into</span><span style="color: #000000"> _result</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">            _row.id, </span></span>
<span class="line"><span style="color: #000000">            _row.parent_id,</span></span>
<span class="line"><span style="color: #000000">            _level;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">        perform select_nodes_recursive_function(</span></span>
<span class="line"><span style="color: #000000">            _row.parent_id, </span></span>
<span class="line"><span style="color: #000000">            _level + </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">        );</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">loop</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        t.id,</span></span>
<span class="line"><span style="color: #000000">        t.parent_id,</span></span>
<span class="line"><span style="color: #000000">        t.level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        _result t;</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>So, we're all set. Let's go.</p><h2 id="problem">Problem</h2><p>Right from the start, while doing smoke tests, I noticed something very wrong. The function <code>select_nodes_recursive_cte</code> doesn't return the expected results at all.</p><p>For a small test set above, this is what it returns:</p><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th>id</th><th>parent_id</th><th>level</th></tr></thead><tbody class="table-group-divider"><tr><td>node_1</td><td>node_3</td><td>1</td></tr><tr><td>node_1</td><td>node_8</td><td>1</td></tr><tr><td>node_8</td><td>node_10</td><td>2</td></tr><tr><td>node_8</td><td>node_5</td><td>2</td></tr><tr><td>node_8</td><td>node_9</td><td>2</td></tr><tr><td>node_5</td><td>node_7</td><td>3</td></tr><tr><td>node_10</td><td>node_1</td><td>4</td></tr><tr><td>node_9</td><td>node_9</td><td>5</td></tr><tr><td>node_7</td><td>node_10</td><td>6</td></tr></tbody></table><p>Nodes <code>node_5</code>, <code>node_10</code>, and <code>node_9</code> are all level 3, not 3, 4 and 6, and <code>node_7</code> is level 4, not 6.</p><p>After some investigation, my strategy of "islands and gaps" (see <a href="https://github.com/vb-consulting/blog/discussions/1">previous article</a>) is completely wrong!</p><p>Implementation was fine; the fact is that every change in <code>id</code> row doesn't mean automatically that we have the new recursion level. At all.</p><p>And after some more investigation, it appears that the only way to implement the recursion level calculation is to add level counter in CTE union queries.</p><p>However, there is a big problem with this approach:</p><p>There is no way to know which node was already processed in recursive CTE to be able to skip it entirely, and:</p><ul><li>If we have a circular reference, one node points to another, and that node points to the first node - we will have an infinite loop. It's not even a stack overflow, just an infinite loop.</li><li>The only way to exit this infinite loop is to set a hard limit on recursion depth.</li></ul><p>So, my final version looks like this now:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_nodes_recursive_cte</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    _max_recursion </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">100</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        id,</span></span>
<span class="line"><span style="color: #E6E6E6">        parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        big_tree_test</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union</span><span style="color: #E6E6E6"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.parent_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> big_tree_test t </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> rec.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6"> _max_recursion </span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> r.id, r.parent_id, r.level</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _recursive_cte r</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_nodes_recursive_cte</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    _max_recursion </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">100</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        id,</span></span>
<span class="line"><span style="color: #000000">        parent_id,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        big_tree_test</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        id = _id</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">union</span><span style="color: #000000"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        rec.parent_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class="line"><span style="color: #000000">        t.parent_id,</span></span>
<span class="line"><span style="color: #000000">        rec.level + </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> big_tree_test t </span><span style="color: #0000FF">on</span><span style="color: #000000"> rec.parent_id = t.id</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">level</span><span style="color: #000000"> &lt; _max_recursion </span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> r.id, r.parent_id, r.level</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> _recursive_cte r</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>But this is a very bad solution, and here is why:</p><p>We don't know which recursion depth is appropriate. And increasing the recursion threshold will only slow this function dramatically. We will still not know if we fetched all levels or if the recursive CTE ran in circles when it encountered the circular reference.</p><p>Let's see some tests - a test table with 1290 records and 250 nodes:</p><ul><li>Recursion depth 100 - 00.330 seconds.</li><li>Recursion depth 1000 - 03.531 seconds.</li><li>Recursion depth 10000 - 36.228 seconds.</li></ul><p>So that's no good. If anyone has a better implementation with recursion level (depth) implemented, I'd like to see it.</p><h2 id="the-solution">The Solution</h2><p>Let's try our procedural approach to this problem to see how it performs. Same test table: - 1290 records and 250 nodes - <strong>00.783 seconds.</strong></p><p>It's not bad at all, but let's try a bit bigger dataset:</p><ul><li>3987 records with 500 nodes - 04.291 seconds</li><li>13232 records with 999 nodes - <code>ERROR: stack depth limit exceeded</code></li></ul><p>So that's no good.</p><p>Let's see if we can optimize this function a bit.</p><h2 id="optimization-1">Optimization 1</h2><p>The first thing I noticed was that the message log was full of <code>NOTICE: relation "_result" already exists, skippingÀô</code> messages.</p><p>I'm not even sure if this is even an optimization, but I first would like to get rid of these messages.</p><p>So, instead of this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6"> _result (</span></span>
<span class="line"><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000"> _result (</span></span>
<span class="line"><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span></code></pre></div><p>We will have this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> information_schema.tables t</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'_result'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> table_type </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'LOCAL TEMPORARY'</span></span>
<span class="line"><span style="color: #E6E6E6">) </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> _result (</span></span>
<span class="line"><span style="color: #E6E6E6">        id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> information_schema.tables t</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.table_name = </span><span style="color: #A31515">'_result'</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> table_type = </span><span style="color: #A31515">'LOCAL TEMPORARY'</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> _result (</span></span>
<span class="line"><span style="color: #000000">        id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span></code></pre></div><p>The second thing I would try is to get rid of that loop. Looping is an anti-pattern with SQL, anyhow.</p><p>Instead, this is what I came up with:</p><ul><li>insert into the temp table and for <code>id</code> parameter and aggregate <code>parent_id</code> values in an array variable.</li><li>call recursion for each distinct value from that array variable.</li></ul><p>This is how that looks like:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> _insert_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> _result</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        _level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        big_tree_test t</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class="line"><span style="color: #E6E6E6">    returning </span></span>
<span class="line"><span style="color: #E6E6E6">        _result.parent_id</span></span>
<span class="line"><span style="color: #E6E6E6">) </span></span>
<span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> array_agg(</span><span style="color: #569CD6">distinct</span><span style="color: #E6E6E6"> p.parent_id)</span></span>
<span class="line"><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _parents</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _insert_cte p; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">perform select_nodes_recursive_function(p, _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> unnest(_parents) p;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">with</span><span style="color: #000000"> _insert_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">insert into</span><span style="color: #000000"> _result</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        t.id,</span></span>
<span class="line"><span style="color: #000000">        t.parent_id,</span></span>
<span class="line"><span style="color: #000000">        _level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        big_tree_test t</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        t.id = _id</span></span>
<span class="line"><span style="color: #000000">    returning </span></span>
<span class="line"><span style="color: #000000">        _result.parent_id</span></span>
<span class="line"><span style="color: #000000">) </span></span>
<span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> array_agg(</span><span style="color: #0000FF">distinct</span><span style="color: #000000"> p.parent_id)</span></span>
<span class="line"><span style="color: #0000FF">into</span><span style="color: #000000"> _parents</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> _insert_cte p; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">perform select_nodes_recursive_function(p, _level + </span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> unnest(_parents) p;</span></span></code></pre></div><p>Now, let's do performance things again:</p><ul><li>13232 records with 999 nodes - 07.338 seconds.</li></ul><p>Not bad, but let's see if we can do even better.</p><h2 id="optimization-2">Optimization 2</h2><p>The idea is to reduce the number of recursion calls as much as possible. Currently, we have this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #E6E6E6">perform select_nodes_recursive_function(p, _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> unnest(_parents) p;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #000000">perform select_nodes_recursive_function(p, _level + </span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> unnest(_parents) p;</span></span></code></pre></div><p>This executes the <code>select_nodes_recursive_function</code> function one for each element in <code>_parents</code> array variable. Instead, we could change the input parameter type so that it receives an entire array instead of a single value.</p><p>Great idea, let's do it!</p><p>Oh, wait, but to have that work as intended, we need to slightly modify the condition we use to exit the recursion in two steps:</p><ol><li>Remove for the array <code>id</code> parameter all IDs that are already processed (we don't want them).</li><li>Check is array empty, and exit if it is.</li></ol><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #E6E6E6">_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> unnest(_id) </span><span style="color: #569CD6">except</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">select distinct</span><span style="color: #E6E6E6"> t.id </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result t);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> _id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'{}'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #000000">_id = </span><span style="color: #0000FF">array</span><span style="color: #000000">(</span><span style="color: #0000FF">select</span><span style="color: #000000"> unnest(_id) </span><span style="color: #0000FF">except</span><span style="color: #000000"> </span><span style="color: #0000FF">select distinct</span><span style="color: #000000"> t.id </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result t);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">if</span><span style="color: #000000"> _id = </span><span style="color: #A31515">'{}'</span><span style="color: #000000"> </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span></code></pre></div><p>Also, we need to use <code>any</code> operator when filtering our table for the insert:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> _result</span></span>
<span class="line"><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">    t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">    _level</span></span>
<span class="line"><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">    big_tree_test t</span></span>
<span class="line"><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_id)</span></span>
<span class="line"><span style="color: #E6E6E6">returning </span></span>
<span class="line"><span style="color: #E6E6E6">    _result.parent_id</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">insert into</span><span style="color: #000000"> _result</span></span>
<span class="line"><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">    t.id,</span></span>
<span class="line"><span style="color: #000000">    t.parent_id,</span></span>
<span class="line"><span style="color: #000000">    _level</span></span>
<span class="line"><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">    big_tree_test t</span></span>
<span class="line"><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    t.id = any(_id)</span></span>
<span class="line"><span style="color: #000000">returning </span></span>
<span class="line"><span style="color: #000000">    _result.parent_id</span></span></code></pre></div><p>This seems to produce satisfying results...</p><p>Now, let's do performance things again:</p><ul><li>13232 records with 5000 nodes - 00.090 seconds.</li></ul><p>Wait what?</p><p>Let's increase the test data set some more:</p><ul><li>78146 records with 999 nodes - 00.450 seconds.</li><li>252296 records with 10000 nodes - 01.656 seconds.</li><li>757824 records with 19999 nodes - 05.372 seconds.</li></ul><p>So it's almost 757K tree records with 20K unique nodes in 5 seconds, and I haven't even used any indexes yet. Not bad, not bad at all...</p><p>Finally, let's see how that magic function looks like</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_nodes_recursive_function</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[],</span></span>
<span class="line"><span style="color: #E6E6E6">    _level </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">declare</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    _row record;</span></span>
<span class="line"><span style="color: #E6E6E6">    _parents </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[];</span></span>
<span class="line"><span style="color: #569CD6">begin</span><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> information_schema.tables t</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'_result'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> table_type </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'LOCAL TEMPORARY'</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> _result (</span></span>
<span class="line"><span style="color: #E6E6E6">            id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">            parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">        ) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    _id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> unnest(_id) </span><span style="color: #569CD6">except</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">select distinct</span><span style="color: #E6E6E6"> t.id </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result t);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> _id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'{}'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> _insert_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> _result</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">            t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">            t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">            _level</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">            big_tree_test t</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">            t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_id)</span></span>
<span class="line"><span style="color: #E6E6E6">        returning </span></span>
<span class="line"><span style="color: #E6E6E6">            _result.parent_id</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> array_agg(</span><span style="color: #569CD6">distinct</span><span style="color: #E6E6E6"> p.parent_id)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _parents</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _insert_cte p; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    perform select_nodes_recursive_function(_parents, _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        _result t;</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_nodes_recursive_function</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span><span style="color: #000000">[],</span></span>
<span class="line"><span style="color: #000000">    _level </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">declare</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    _row record;</span></span>
<span class="line"><span style="color: #000000">    _parents </span><span style="color: #0000FF">text</span><span style="color: #000000">[];</span></span>
<span class="line"><span style="color: #0000FF">begin</span><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> information_schema.tables t</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.table_name = </span><span style="color: #A31515">'_result'</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> table_type = </span><span style="color: #A31515">'LOCAL TEMPORARY'</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> _result (</span></span>
<span class="line"><span style="color: #000000">            id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">            parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">        ) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    _id = </span><span style="color: #0000FF">array</span><span style="color: #000000">(</span><span style="color: #0000FF">select</span><span style="color: #000000"> unnest(_id) </span><span style="color: #0000FF">except</span><span style="color: #000000"> </span><span style="color: #0000FF">select distinct</span><span style="color: #000000"> t.id </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result t);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> _id = </span><span style="color: #A31515">'{}'</span><span style="color: #000000"> </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">with</span><span style="color: #000000"> _insert_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">insert into</span><span style="color: #000000"> _result</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">            t.id,</span></span>
<span class="line"><span style="color: #000000">            t.parent_id,</span></span>
<span class="line"><span style="color: #000000">            _level</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">            big_tree_test t</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">            t.id = any(_id)</span></span>
<span class="line"><span style="color: #000000">        returning </span></span>
<span class="line"><span style="color: #000000">            _result.parent_id</span></span>
<span class="line"><span style="color: #000000">    ) </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> array_agg(</span><span style="color: #0000FF">distinct</span><span style="color: #000000"> p.parent_id)</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">into</span><span style="color: #000000"> _parents</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> _insert_cte p; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    perform select_nodes_recursive_function(_parents, _level + </span><span style="color: #098658">1</span><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        t.id,</span></span>
<span class="line"><span style="color: #000000">        t.parent_id,</span></span>
<span class="line"><span style="color: #000000">        t.level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        _result t;</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>To invoke this function, pass the array parameter:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> select_nodes_recursive_function(</span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">['node_1'])</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> * </span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> select_nodes_recursive_function(</span><span style="color: #0000FF">array</span><span style="color: #000000">['node_1'])</span></span></code></pre></div><p>And that's it: fast tree parsing recursion for PostgreSQL.</p><h2 id="conclusion">Conclusion</h2><p>This started as an exploration into the possibilities of parsing tree structures with PostgreSQL and has now grown into a series of articles.</p><p>My conclusion is that SQL is not that suitable for recursion. As we can see in this article, it has some severe limitations, mainly regarding recursion depth issues.</p><p>As far as I know, SQL was never even intended to do that in the first place.</p><p>On the other hand, the more procedural approach, optimized properly, can yield some spectacular results.</p><p>However, this approach may not be for everybody.</p><div class="my-5 px-5 border-top links svelte-1bxfgrx"><div><div class="link-title text-start svelte-1bxfgrx">PREVIOUS</div><a class="btn text-start" href="/blog/recursion-postgresql/part1-different-type-of-recursion">Part 1 - A Different Type of Recursion</a></div><div><div class="link-title text-end svelte-1bxfgrx">NEXT</div><a class="btn text-end" href="/blog/recursion-postgresql/part3-cycle-detection">Part 3 - Cycle Detection</a></div></div><div class="w-fit mx-auto mt-5 mb-3 border-top"><div class="alert text-center fs-smaller text-muted">To receive notifications about new posts and updates, consider subscribing to my LinkdIn page:<br><a class="btn btn-sm" href="https://www.linkedin.com/in/vb-software/"><i class="bi-linkedin"></i> <span class="text-primary">vb-software linkedin</span></a><br><br>You will receive notifications about new posts on your LinkedIn feed.</div></div><div class="pt-5 border-top"><div id="comments-section" class="h5">Comments</div><script defer src="https://cdn.commento.io/js/commento.js" data-no-fonts="true" data-css-override="https://vb-consulting.github.io/style.css"></script><div id="commento"></div></div><footer class="mt-3 py-5"><div class="w-fit mx-auto mb-3 border-top border-bottom"><div class="alert text-center fs-smaller text-muted"><div class="alert text-center fs-smaller text-muted mb-1">If you like my content, use my software, or otherwise benefit from my work, consider supporting me by buying me a coffee. The software runs on coffee after all.</div><a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="Click Here to Buy Me a Coffee Or Scan the Code" href="https://www.buymeacoffee.com/vbilopavu" style="display: inline-grid;">Buy me a Coffee <img class="m-auto svelte-byttq0" alt="Scan Here To Buy Me a Cofee" src="/bmc_qr.png"></a></div></div><div class="d-flex justify-content-center"><a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="I Post Software Development Content Daily" href="https://www.linkedin.com/in/vb-software/" style="display: inline-grid;">Follow me on LinkedIn <i class="bi bi-linkedin"></i></a></div><div class="text-center"><div class="mt-5 mb-5 background-floki svelte-byttq0" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog."></div></div></footer><div class="mb-5"></div></div></div><div class="rightside svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">on this page</span><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="recursion-with-postgresql-part-2---performances" title="Recursion with PostgreSQL Part 2 - Performances"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#recursion-with-postgresql-part-2---performances">Recursion with PostgreSQL Part 2 - Performances</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="testing" title="Testing"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#testing">Testing</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="problem" title="Problem"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#problem">Problem</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="the-solution" title="The Solution"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#the-solution">The Solution</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="optimization-1" title="Optimization 1"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#optimization-1">Optimization 1</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="optimization-2" title="Optimization 2"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#optimization-2">Optimization 2</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="conclusion" title="Conclusion"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#conclusion">Conclusion</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="comments-section" title="Comments"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#comments-section">Comments</a></li><li><hr class="svelte-9zwk14"><div class="navbar-nav sidenav"><div class="text-muted fs-_7rem mx-2">PREVIOUS</div><a class="btn btn-sm text-start sidebar-link" href="/blog/recursion-postgresql/part1-different-type-of-recursion"><span class="svelte-9zwk14">Part 1 - A Different Type of Recursion</span></a></div><div class="navbar-nav sidenav mt-3"><div class="text-muted fs-_7rem mx-2">NEXT</div><a class="btn btn-sm text-start sidebar-link" href="/blog/recursion-postgresql/part3-cycle-detection"><span class="svelte-9zwk14">Part 3 - Cycle Detection</span></a></div></li></ul></div></div></main><script>!function(){var i=document.querySelector("nav.navbar"),f=document.getElementsByTagName("main")[0],L=f.getElementsByClassName("sidebar")[0],w=f.getElementsByClassName("content")[0],o=document.querySelectorAll("div.code"),k=i.querySelector(".home");function E(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n])}function T(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n]);E(e,t),e.classList.add(t)}function t(e,t){var n=e.currentTarget;if(!n.classList.contains("bi-check")){for(var i="",o=0;o<n.classList.length;o++)if(n.classList[o].startsWith("bi-")){i=n.classList[o];break}n.classList.remove(i),n.classList.add("spinner-border-sm"),n.classList.add("spinner-border");e=bootstrap.Tooltip.getInstance(n);e&&(e.setContent({".tooltip-inner":"Copying..."}),e.show()),t(n,function(){var e;n.classList.remove(i),n.classList.remove("spinner-border-sm"),n.classList.remove("spinner-border"),n.classList.add("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&(e.setContent({".tooltip-inner":"Copied!"}),e.show()),setTimeout(function(){var e;n.classList.add(i),n.classList.remove("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&e.setContent({".tooltip-inner":n.dataset.bsTitle})},2e3)})}}"/"==document.location.pathname&&T(k,"d-none");var e=document.querySelector(".post-share > .copy-url"),n=(e&&e.addEventListener("click",function(e){t(e,function(e,t){navigator.clipboard.writeText(document.location.origin+document.location.pathname),t()})}),document.getElementsByTagName("html")[0]),a=i.querySelector("#theme-btn"),s="theme";function l(e){var t=a.getElementsByTagName("svg");"dark"===e?(t[0].style.display="",t[1].style.display="none",a.getElementsByClassName("check")[0].classList.add("checked")):(t[0].style.display="none",t[1].style.display="",a.getElementsByClassName("check")[0].classList.remove("checked"));for(var n=0;n<o.length;n++){var i=o[n];"dark"===e?(i.children[1].style.display="inherit",i.children[2].style.display="none"):"light"===e&&(i.children[1].style.display="none",i.children[2].style.display="inherit")}window._theme&&window._theme(e)}function r(e){t(e,function(e,t){navigator.clipboard.writeText(e.parentElement.nextSibling.innerText),t()})}function c(e){t(e,function(e,t){var n=localStorage.getItem(s);e="dark"===n?e.parentElement.parentElement.children[1]:e.parentElement.parentElement.children[2],setTimeout(function(){html2canvas(e).then(e=>{e.toBlob(e=>navigator.clipboard.write([new ClipboardItem({"image/png":e})])),t()})},0)})}a.addEventListener("click",()=>{var e="dark"===localStorage.getItem(s)?"light":"dark";localStorage.setItem(s,e),l(n.dataset.bsTheme=e)}),l(localStorage.getItem(s)),a.children[0].classList.remove("hidden");for(var d=0;d<o.length;d++){o[d].getElementsByClassName("copy-code")[0].addEventListener("click",r);var m=o[d].getElementsByClassName("photo-code");m.length&&m[0].addEventListener("click",c)}for(var S=function(){var a,o,s;if(f.children[2]&&"none"!=f.children[2].style.display)return a=f.querySelector(".main-content").querySelectorAll("[id]"),o=void 0,this.initNavs=function(e){s=e.querySelectorAll("li.bookmark-nav");for(var t=0;t<a.length;t++){for(var n=a[t].id,i=null,o=0;o<s.length;o++)if(s[o].dataset.id==n){i=s[o];break}a[t].nav=i}setTimeout(function(){for(var e=0;e<a.length;e++){var t=a[e];if(l(t).visible&&t.nav)return void t.nav.classList.add("active")}},1e3),r()},f.children[1].addEventListener("scroll",r),this;function l(e){var e=e.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight),n=0<e.top&&!(e.bottom<0||0<=e.top-t)||e.top<0&&e.bottom>t,i=!1;return{visible:n,above:i=n?i:e.bottom<t}}function r(){if(s&&s.length){for(var e=0;e<s.length;e++)s[e].classList.remove("active");for(var t=void 0,e=0;e<a.length;e++){const i=a[e];var n=l(i);if(!n.visible&&n.above&&(t=i.nav),n.visible&&i.nav&&!i.nav.classList.contains("active"))return i.nav.classList.add("active"),o&&clearTimeout(o),void(o=setTimeout(function(){i.nav.scrollIntoView({behavior:"smooth"}),o=void 0},250))}t&&!t.classList.contains("active")&&(t.classList.add("active"),o&&clearTimeout(o),o=setTimeout(function(){t.scrollIntoView({behavior:"smooth"}),o=void 0},250))}}}(),h=function(){var l,r=i.querySelector("#nav-btn"),c=480,d="200px",m="0.25fr",h=730,v=535,u=f.children[0].children[0].children[0],g=f.children[2]&&f.children[2].children[0].children[0],t="sidebar-pinned",p=null==localStorage.getItem(t)||"true"==localStorage.getItem(t),y=!1,b=!1;function n(){window._onresize&&window._onresize();var e=window.outerWidth||window.innerWidth,t=e<c,n=t?y?"100%":"0":p?""+d:"0",i=`grid-template-columns: ${n} 1fr`,o=t&&y?"width: 100%":"0"!=n?"":"display: none",a=t&&y?"display: none":"",s=t?y?"sidebar-show":"sidebar-hide":p?"sidebar-show":"sidebar-hide",n="0"==n;f.children[2]&&(m&&h&&v&&(n&&e<v||!n&&e<h?b||(u.innerHTML=l+g.innerHTML,S.initNavs(u),b=!0):b&&(u.innerHTML=l,S.initNavs(g),b=!1)),!m||t||b?(i+=";",f.children[2].style.display="none"):(i+=` ${m};`,f.children[2].style.display="")),T(r,!t&&p||t&&y?"rotate":"rotate-back","rotate","rotate-back"),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),f.style=L?i:"display: grid;",L&&T(L,s,"sidebar-show","sidebar-hide"),L&&(L.firstChild.style=o),w.style=a,t&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),t&&y&&T(k,"d-none")}function e(){var e=window.outerWidth<c;e?y=!y:p=!p,localStorage.setItem(t,p.toString()),n(),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),e&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),e&&y&&T(k,"d-none")}return m&&h&&v&&g&&(l=u.innerHTML,S.initNavs(g)),r.addEventListener("click",e),(window.onresize=n)(),this.closeSidebar=function(){window.outerWidth<c&&y&&e()},this}(),v=document.getElementsByClassName("auto-close"),u=0;u<v.length;u++)v[u].addEventListener("click",function(e){h.closeSidebar()});location.hash&&(e=document.getElementById(location.hash.replace("#","")))&&e.scrollIntoView()}();</script><script src="/bootstrap.bundle.min.js"></script><script>!function(){for(var e=document.querySelectorAll('[data-bs-toggle="tooltip"]'),t=0;t<e.length;t++)new bootstrap.Tooltip(e[t]);var n=document.getElementsByClassName("accordion-item");if(n.length){for(t=0;t<n.length;t++){var o=n[t];o.querySelectorAll("[href='"+document.location.pathname+"']").length&&o.firstChild.click()}var l=document.querySelector("nav.navbar").querySelector(".home"),a=document.getElementsByClassName("accordion");"/"==document.location.pathname&&l.classList.add("d-none");for(t=0;t<n.length;t++){var s=a[t];s&&s.firstChild&&"VB-Consulting"==s.firstChild.title&&(null!=s.firstChild.querySelector(".collapse")&&l.classList.contains("d-none")&&"/"!=document.location.pathname&&l.classList.remove("d-none"),s.addEventListener("show.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none"),l.classList.add("d-none")}),s.addEventListener("hide.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none")}))}}}();</script><script src="/html2canvas.min.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script></body><script async data-id="101435862" src="//static.getclicky.com/js"></script></html>