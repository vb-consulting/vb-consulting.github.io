<!DOCTYPE html><html lang=en><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Recursion with PostgreSQL Part 4 - Finding the Right Path</title><meta name=description content="Recursion with PostgreSQL Part 4 - Finding the Right Path"><link href=https://vb-consulting.github.io//blog/recursion-postgresql/part4-right-path/ rel=canonical><meta name=keywords content="postgresql, sql, plpgsql, recursion, tree, cte, function"><link rel=stylesheet href=/_elderjs/assets/svelte-b561abf6.css media=all><style></style><link href=/style.css?1702297205284 rel=stylesheet><script>!function(){var e="theme",t=localStorage.getItem(e);t||(t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",localStorage.setItem(e,t)),document.getElementsByTagName("html")[0].dataset.bsTheme=t}();</script><body class="d-flex flex-column h-100"><header id=header><nav class="navbar navbar-expand-md navbar-dark fixed-top py-0 py-md-0 svelte-13wa5zp"><div class="container-fluid flex-nowrap svelte-13wa5zp"><div class="d-flex svelte-13wa5zp"><button id=nav-btn type=button class="d-flex btn btn-sm logo animate-rotate svelte-13wa5zp"><i class=material-icons-outlined>menu</i></button></div><div class="d-flex right svelte-13wa5zp"><a class="nav-link my-auto me-2 svelte-13wa5zp"href=https://github.com/vb-consulting/blog/ ><i class=bi-github></i></a> <a class="github-button svelte-13wa5zp"href=https://github.com/vb-consulting/blog/ data-color-scheme="no-preference: light_high_contrast; light: light_high_contrast; dark: light_high_contrast;"data-icon=octicon-star data-show-count=true aria-label="Star vb-consulting/blog/ on GitHub"></a><div class="vr text-white my-auto svelte-13wa5zp"></div><button id=theme-btn type=button aria-pressed=true aria-label=theme class=svelte-13wa5zp><span class="check hidden svelte-13wa5zp"><span class="icon svelte-13wa5zp"><svg xmlns=http://www.w3.org/2000/svg width=32 height=32 viewBox="0 0 24 24"class=svelte-13wa5zp><path fill=currentColor d="M12 21q-3.775 0-6.388-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.625-.075.975.45t-.025 1.1q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.525-.35 1.075-.037t.475.987q-.35 3.45-2.937 5.725T12 21Zm0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19Zm-.25-6.75Z"></path></svg> <svg xmlns=http://www.w3.org/2000/svg width=32 height=32 viewBox="0 0 24 24"class=svelte-13wa5zp><g fill=none stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M0 0h24v24H0z"></path><path fill=currentColor d="M12 19a1 1 0 0 1 .993.883L13 20v1a1 1 0 0 1-1.993.117L11 21v-1a1 1 0 0 1 1-1zm6.313-2.09l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7a1 1 0 0 1 1.218-1.567l.102.07zm-11.306.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM4 11a1 1 0 0 1 .117 1.993L4 13H3a1 1 0 0 1-.117-1.993L3 11h1zm17 0a1 1 0 0 1 .117 1.993L21 13h-1a1 1 0 0 1-.117-1.993L20 11h1zM6.213 4.81l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7A1 1 0 0 1 6.11 4.74l.102.07zm12.894.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM12 2a1 1 0 0 1 .993.883L13 3v1a1 1 0 0 1-1.993.117L11 4V3a1 1 0 0 1 1-1zm0 5a5 5 0 1 1-4.995 5.217L7 12l.005-.217A5 5 0 0 1 12 7z"></path></g></svg></span></span></button></div></div></nav></header><main class=svelte-2kl70j><div class="sidebar sidebar-hide svelte-2kl70j"><div class=svelte-2kl70j><ul class="navbar-nav sidenav svelte-2kl70j"><li class="nav-item svelte-2kl70j"data-id=""title=VB-Consulting><a class="nav-link svelte-2kl70j text-uppercase"href=/ >VB-Consulting</a><li class="nav-divider svelte-2kl70j"><hr class=svelte-2kl70j><li class="nav-item toc2 svelte-2kl70j"data-id=""title=Norm.Net><a class="nav-link svelte-2kl70j text-uppercase"href=/norm.net/ >Norm.Net</a><li class="nav-item toc2 svelte-2kl70j"data-id=""title=RazorSvelte><a class="nav-link svelte-2kl70j text-uppercase"href=/razorsvelte/ >RazorSvelte</a><li class="nav-item toc2 svelte-2kl70j"data-id=""title=PgRoutiner><a class="nav-link svelte-2kl70j text-uppercase"href=/pgroutiner/ >PgRoutiner</a><li class="nav-item toc2 svelte-2kl70j"data-id=""title=XUnit.Npgsql><a class="nav-link svelte-2kl70j text-uppercase"href=/xunit.npgsql/ >XUnit.Npgsql</a><li class="nav-item toc2 svelte-2kl70j"data-id=""title="PostrgeSQL Schema Tools"><a class="nav-link svelte-2kl70j text-uppercase"href=/pg_schema_tools/ >PostrgeSQL Schema Tools</a><li class="nav-txt-divider text-muted svelte-2kl70j"><hr class=svelte-2kl70j><span class=svelte-2kl70j>latest blogs</span><hr class=svelte-2kl70j><li class="nav-item svelte-2kl70j"data-id=""title="What is Micro ORM?"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/micro-orm/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> What is Micro ORM?</a><li class="nav-item svelte-2kl70j"data-id=""title="Execute Custom Function For Each Record"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/postgresql-record-type/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Execute Custom Function For Each Record</a><li class="nav-item svelte-2kl70j"data-id=""title="Custom Temporal Tables in PostgreSQL"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/postgresql-temporal-tables/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Custom Temporal Tables in PostgreSQL</a><li class="nav-item svelte-2kl70j"data-id=""title="Which Way .NET Developer?"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/where-to/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Which Way .NET Developer?</a></ul></div></div><div class="content svelte-2kl70j"><div class="banner svelte-rzcvgm"style="background-image: url(/neretva.jpg); background-position: bottom;"></div><div class="container-sm main-content svelte-rzcvgm bannered"><div><span class="badge rounded-pill text-bg-secondary">postgresql</span><span class="badge rounded-pill text-bg-secondary">plpgsql</span><span class="badge rounded-pill text-bg-secondary">sql</span></div><h1 class=text-shadow id=recursion-with-postgresql-part-4---finding-the-right-path>Recursion with PostgreSQL Part 4 - Finding the Right Path</h1><div class="post-meta text-shadow"><div class=post-pic data-bs-toggle=tooltip data-bs-html=true title="Floki is a developer dog."style="background-image: url(/floki.jpeg)"></div><div><div class=post-author>floki</div><div class=post-date>Sep 18, 2023</div></div></div><p>The mystery has finally been resolved, and I have learned something today.<p>In my <a href=https://github.com/vb-consulting/blog/discussions/5>previous article</a>, I managed to get some really crazy performances in tree processing by using PostgreSQL recursive procedural-style function.<p>While recursive CTE was getting some severe performance degradation - even on a smaller scale: It usually would eat all of my available space.<p>Thanks to @fatalmind (Markus Winand) <a href=https://github.com/vb-consulting/blog/discussions/5#discussioncomment-7035413>comment</a>, I got better clarification on what path and cycle really mean.<h1 id=example>Example</h1><p>So we have this test table:<div class=one-liner><div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> big_tree_test (id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">, parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">);</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> big_tree_test (id </span><span style="color: #0000FF">text</span><span style="color: #000000">, parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">);</span></span></code></pre></div></div><pre><code>   id    | parent_id | 
---------+-----------+
 node_1  | node_3    |
 node_1  | node_8    |
 node_4  | node_8    |
 node_5  | node_7    |
 node_6  | node_4    |
 node_6  | node_6    |
 node_6  | node_9    |
 node_7  | node_10   |
 node_8  | node_10   |
 node_8  | node_5    |
 node_8  | node_9    |
 node_9  | node_9    |
 node_10 | node_1    |
</code></pre><p>Now, If we run recursive CTE for the <code>node_1</code> and if we include this statement: <code>cycle id set is_cycle using path</code>, we will get this:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">        id,</span></span>
<span class=line><span style="color: #E6E6E6">        parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">        big_tree_test</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'node_1'</span></span>
<span class=line><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union all</span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">        rec.parent_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        rec.level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> big_tree_test t </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> rec.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #E6E6E6">cycle id </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6"> is_cycle </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">path</span></span>
<span class=line><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> r.id, r.parent_id, r.level, is_cycle, </span><span style="color: #569CD6">path</span></span>
<span class=line><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _recursive_cte r</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">        id,</span></span>
<span class=line><span style="color: #000000">        parent_id,</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">        big_tree_test</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        id = </span><span style="color: #A31515">'node_1'</span></span>
<span class=line><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">union all</span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">        rec.parent_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class=line><span style="color: #000000">        t.parent_id,</span></span>
<span class=line><span style="color: #000000">        rec.level + </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">        _recursive_cte rec</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> big_tree_test t </span><span style="color: #0000FF">on</span><span style="color: #000000"> rec.parent_id = t.id</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #000000">cycle id </span><span style="color: #0000FF">set</span><span style="color: #000000"> is_cycle </span><span style="color: #0000FF">using</span><span style="color: #000000"> </span><span style="color: #0000FF">path</span></span>
<span class=line><span style="color: #0000FF">select</span><span style="color: #000000"> r.id, r.parent_id, r.level, is_cycle, </span><span style="color: #0000FF">path</span></span>
<span class=line><span style="color: #0000FF">from</span><span style="color: #000000"> _recursive_cte r</span></span></code></pre></div><pre><code>   id    | parent_id | level | is_cycle |                      path
---------+-----------+-------+----------+-------------------------------------------------
| node_1 |    node_3 |     1 |    false | {(node_1)}
| node_1 |    node_8 |     1 |    false | {(node_1)}
| node_8 |    node_9 |     2 |    false | {(node_1),(node_8)}
| node_8 |    node_5 |     2 |    false | {(node_1),(node_8)}
| node_8 |   node_10 |     2 |    false | {(node_1),(node_8)}
| node_9 |    node_9 |     3 |    false | {(node_1),(node_8),(node_9)}
| node_5 |    node_7 |     3 |    false | {(node_1),(node_8),(node_5)}
|node_10 |    node_1 |     3 |    false | {(node_1),(node_8),(node_10)}
| node_9 |    node_9 |     4 |     true | {(node_1),(node_8),(node_9),(node_9)}
| node_7 |   node_10 |     4 |    false | {(node_1),(node_8),(node_5),(node_7)}
| node_1 |    node_8 |     4 |     true | {(node_1),(node_8),(node_10),(node_1)}
| node_1 |    node_3 |     4 |     true | {(node_1),(node_8),(node_10),(node_1)}
|node_10 |    node_1 |     5 |    false | {(node_1),(node_8),(node_5),(node_7),(node_10)}
| node_1 |    node_8 |     6 |     true | {(node_1),(node_8),(node_5),(node_7),(node_10),(node_1)}
| node_1 |    node_3 |     6 |     true | {(node_1),(node_8),(node_5),(node_7),(node_10),(node_1)}
</code></pre><p>Now, If we take a look at this random record on level 3 for example:<pre><code>   id    | parent_id | level | is_cycle |                      path
---------+-----------+-------+----------+-------------------------------------------------
| node_5 |    node_7 |     3 |    false | {(node_1),(node_8),(node_5)}
</code></pre><p>To be able to get to that node connection <code>| node_5 | node_7 |</code> on level 3, and by starting from the <code>node_1</code> - we would have to go through following path:<ul><li><code>| node_1 | node_8 |</code> - level 1: we start with <code>node_1</code> and next node is <code>node_8</code> (parent of <code>node_1</code>).<li><code>| node_8 | node_5 |</code> - level 2: next is <code>node_8</code>, because that was parent of <code>node_1</code><li><code>| node_5 | node_7 |</code> - level 3: <code>node_5</code> is the parent of <code>node_8</code> at previous level 2, so now, we're at <code>node_5</code> at that is level 3.</ul><p>Following this path, we have calculated the entire path from <code>node_1</code> to node connection <code>| node_5 | node_7 |</code> to be this following path: <code>node_1</code>, <code>node_8</code>, <code>node_5</code>.<p>And that is the correct path calculation.<p>A cycle path means simply that if you follow that path - you will end at the already visited node at that path, which means you will run in circles (endless loop).<p>And indeed, if we check out the cycle paths in this example:<pre><code>   id    | parent_id | level | is_cycle |                      path
---------+-----------+-------+----------+-------------------------------------------------
| node_9 |    node_9 |     4 |     true | {(node_1),(node_8),(node_9),(node_9)}
| node_1 |    node_8 |     4 |     true | {(node_1),(node_8),(node_10),(node_1)}
| node_1 |    node_3 |     4 |     true | {(node_1),(node_8),(node_10),(node_1)}
| node_1 |    node_8 |     6 |     true | {(node_1),(node_8),(node_5),(node_7),(node_10),(node_1)}
| node_1 |    node_3 |     6 |     true | {(node_1),(node_8),(node_5),(node_7),(node_10),(node_1)}
</code></pre><p>We will notice some repeating nodes:<ul><li><code>{(node_1),(node_8),(node_9),(node_9)}</code> - <code>node_9</code> is repeating.<li><code>{(node_1),(node_8),(node_10),(node_1)}</code> - <code>node_1</code> is repeating.<li><code>{(node_1),(node_8),(node_5),(node_7),(node_10),(node_1)}</code> - <code>node_1</code> is repeating.<li><code>{(node_1),(node_8),(node_5),(node_7),(node_10),(node_1)}</code> - <code>node_1</code> is repeating.</ul><h2 id=new-recursive-function>New Recursive Function</h2><p>Given all that new understanding of what path and cycle actually means - I created a new version of my recursive function. This time to calculate and return the correct path and is cycle check:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> drop_function(</span><span style="color: #CE9178">'public'</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">'select_nodes_recursive_function'</span><span style="color: #E6E6E6">);</span></span>
<span class=line></span>
<span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> select_nodes_recursive_function(</span></span>
<span class=line><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[],</span></span>
<span class=line><span style="color: #E6E6E6">    _level </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    is_cycle </span><span style="color: #569CD6">boolean</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">path</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[]</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class=line><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">$$</span></span>
<span class=line><span style="color: #569CD6">declare</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">    _parents </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[];</span></span>
<span class=line><span style="color: #569CD6">begin</span><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> information_schema.tables t</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'_result'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> table_type </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'LOCAL TEMPORARY'</span></span>
<span class=line><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">then</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> _result (</span></span>
<span class=line><span style="color: #E6E6E6">            id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">            parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">            </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">            is_cycle </span><span style="color: #569CD6">boolean</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">            </span><span style="color: #569CD6">path</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[]</span></span>
<span class=line><span style="color: #E6E6E6">        ) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> _insert_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">insert</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _result</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">            t.id,</span></span>
<span class=line><span style="color: #E6E6E6">            t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">            _level,</span></span>
<span class=line><span style="color: #E6E6E6">            </span><span style="color: #DCDCAA">coalesce</span><span style="color: #E6E6E6">(l.is_cycle, false) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> is_cycle,</span></span>
<span class=line><span style="color: #E6E6E6">            array_append(l.path, t.id) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">path</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">            big_tree_test t</span></span>
<span class=line><span style="color: #E6E6E6">            </span><span style="color: #569CD6">left outer join</span><span style="color: #E6E6E6"> lateral (</span></span>
<span class=line><span style="color: #E6E6E6">                </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> p.path, t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(p.path) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> is_cycle</span></span>
<span class=line><span style="color: #E6E6E6">                </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result p</span></span>
<span class=line><span style="color: #E6E6E6">                </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> p.level </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _level </span><span style="color: #D4D4D4">-</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> p.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class=line><span style="color: #E6E6E6">            ) l </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> true</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">            t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_id)</span></span>
<span class=line><span style="color: #E6E6E6">            </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">coalesce</span><span style="color: #E6E6E6">(l.is_cycle, false)</span></span>
<span class=line><span style="color: #E6E6E6">        returning </span></span>
<span class=line><span style="color: #E6E6E6">            _result.parent_id</span></span>
<span class=line><span style="color: #E6E6E6">    ) </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> array_agg(p.parent_id)</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _parents</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _insert_cte p;</span></span>
<span class=line><span style="color: #E6E6E6">            </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> _parents </span><span style="color: #569CD6">is</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">then</span></span>
<span class=line><span style="color: #E6E6E6">        perform select_nodes_recursive_function(_parents, _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">);</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        t.id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.level,</span></span>
<span class=line><span style="color: #E6E6E6">        t.is_cycle,</span></span>
<span class=line><span style="color: #E6E6E6">        t.path</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        _result t;</span></span>
<span class=line><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">$$;</span></span>
<span class=line></span>
<span class=line><span style="color: #6A9955">-- helper function overload</span></span>
<span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> select_nodes_recursive_function(_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    is_cycle </span><span style="color: #569CD6">boolean</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">path</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[]</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class=line><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'select id, parent_id, level, is_cycle, path from select_nodes_recursive_function(array[_id]::text[])'</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">select</span><span style="color: #000000"> drop_function(</span><span style="color: #A31515">'public'</span><span style="color: #000000">, </span><span style="color: #A31515">'select_nodes_recursive_function'</span><span style="color: #000000">);</span></span>
<span class=line></span>
<span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> </span><span style="color: #795E26">replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> select_nodes_recursive_function(</span></span>
<span class=line><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span><span style="color: #000000">[],</span></span>
<span class=line><span style="color: #000000">    _level </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">1</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    is_cycle </span><span style="color: #0000FF">boolean</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">path</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000">[]</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class=line><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">$$</span></span>
<span class=line><span style="color: #0000FF">declare</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">    _parents </span><span style="color: #0000FF">text</span><span style="color: #000000">[];</span></span>
<span class=line><span style="color: #0000FF">begin</span><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> information_schema.tables t</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.table_name = </span><span style="color: #A31515">'_result'</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> table_type = </span><span style="color: #A31515">'LOCAL TEMPORARY'</span></span>
<span class=line><span style="color: #000000">    ) </span><span style="color: #0000FF">then</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> _result (</span></span>
<span class=line><span style="color: #000000">            id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">            parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">            </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">            is_cycle </span><span style="color: #0000FF">boolean</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">            </span><span style="color: #0000FF">path</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000">[]</span></span>
<span class=line><span style="color: #000000">        ) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">with</span><span style="color: #000000"> _insert_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">insert</span><span style="color: #000000"> </span><span style="color: #0000FF">into</span><span style="color: #000000"> _result</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">            t.id,</span></span>
<span class=line><span style="color: #000000">            t.parent_id,</span></span>
<span class=line><span style="color: #000000">            _level,</span></span>
<span class=line><span style="color: #000000">            </span><span style="color: #795E26">coalesce</span><span style="color: #000000">(l.is_cycle, false) </span><span style="color: #0000FF">as</span><span style="color: #000000"> is_cycle,</span></span>
<span class=line><span style="color: #000000">            array_append(l.path, t.id) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">path</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">            big_tree_test t</span></span>
<span class=line><span style="color: #000000">            </span><span style="color: #0000FF">left outer join</span><span style="color: #000000"> lateral (</span></span>
<span class=line><span style="color: #000000">                </span><span style="color: #0000FF">select</span><span style="color: #000000"> p.path, t.id = any(p.path) </span><span style="color: #0000FF">as</span><span style="color: #000000"> is_cycle</span></span>
<span class=line><span style="color: #000000">                </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result p</span></span>
<span class=line><span style="color: #000000">                </span><span style="color: #0000FF">where</span><span style="color: #000000"> p.level = _level - </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> p.parent_id = t.id</span></span>
<span class=line><span style="color: #000000">            ) l </span><span style="color: #0000FF">on</span><span style="color: #000000"> true</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">            t.id = any(_id)</span></span>
<span class=line><span style="color: #000000">            </span><span style="color: #0000FF">and</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #795E26">coalesce</span><span style="color: #000000">(l.is_cycle, false)</span></span>
<span class=line><span style="color: #000000">        returning </span></span>
<span class=line><span style="color: #000000">            _result.parent_id</span></span>
<span class=line><span style="color: #000000">    ) </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> array_agg(p.parent_id)</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">into</span><span style="color: #000000"> _parents</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> _insert_cte p;</span></span>
<span class=line><span style="color: #000000">            </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> _parents </span><span style="color: #0000FF">is</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">null</span><span style="color: #000000"> </span><span style="color: #0000FF">then</span></span>
<span class=line><span style="color: #000000">        perform select_nodes_recursive_function(_parents, _level + </span><span style="color: #098658">1</span><span style="color: #000000">);</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        t.id,</span></span>
<span class=line><span style="color: #000000">        t.parent_id,</span></span>
<span class=line><span style="color: #000000">        t.level,</span></span>
<span class=line><span style="color: #000000">        t.is_cycle,</span></span>
<span class=line><span style="color: #000000">        t.path</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        _result t;</span></span>
<span class=line><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">$$;</span></span>
<span class=line></span>
<span class=line><span style="color: #008000">-- helper function overload</span></span>
<span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> </span><span style="color: #795E26">replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> select_nodes_recursive_function(_id </span><span style="color: #0000FF">text</span><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    is_cycle </span><span style="color: #0000FF">boolean</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">path</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000">[]</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class=line><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">'select id, parent_id, level, is_cycle, path from select_nodes_recursive_function(array[_id]::text[])'</span><span style="color: #000000">;</span></span></code></pre></div><p>This is a crucial piece of logic that allowed for correct path calculation:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">    t.id,</span></span>
<span class=line><span style="color: #E6E6E6">    t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">    _level,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">coalesce</span><span style="color: #E6E6E6">(l.is_cycle, false) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> is_cycle,</span></span>
<span class=line><span style="color: #E6E6E6">    array_append(l.path, t.id) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">path</span></span>
<span class=line><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">    big_tree_test t</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">left outer join</span><span style="color: #E6E6E6"> lateral (</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> p.path, t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(p.path) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> is_cycle</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result p</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> p.level </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _level </span><span style="color: #D4D4D4">-</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> p.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class=line><span style="color: #E6E6E6">    ) l </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> true</span></span>
<span class=line><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">    t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_id)</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">coalesce</span><span style="color: #E6E6E6">(l.is_cycle, false)</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">    t.id,</span></span>
<span class=line><span style="color: #000000">    t.parent_id,</span></span>
<span class=line><span style="color: #000000">    _level,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #795E26">coalesce</span><span style="color: #000000">(l.is_cycle, false) </span><span style="color: #0000FF">as</span><span style="color: #000000"> is_cycle,</span></span>
<span class=line><span style="color: #000000">    array_append(l.path, t.id) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">path</span></span>
<span class=line><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">    big_tree_test t</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">left outer join</span><span style="color: #000000"> lateral (</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> p.path, t.id = any(p.path) </span><span style="color: #0000FF">as</span><span style="color: #000000"> is_cycle</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result p</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> p.level = _level - </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> p.parent_id = t.id</span></span>
<span class=line><span style="color: #000000">    ) l </span><span style="color: #0000FF">on</span><span style="color: #000000"> true</span></span>
<span class=line><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">    t.id = any(_id)</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">and</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #795E26">coalesce</span><span style="color: #000000">(l.is_cycle, false)</span></span></code></pre></div><ul><li>For every new node connection level, we can select the previous level <code>p.level = _level - 1</code> - for the same parent node - <code>p.parent_id = t.id</code>. That is what this <code>left outer join lateral</code> does. It is a <code>lateral</code> join because we need to include main table <code>big_tree_test t</code> into the subselect join query, and it is <code>left lateral</code> because the subquery may not find any results, and we want all from <code>big_tree_test t</code><li>And now we can add the current ID to this path - <code>array_append(l.path, t.id) as path</code> to calculate the right path.<li>That path is a cycle path if the current ID already exists in the previous path - <code>t.id = any(p.path) as is_cycle</code>.<li>And now, we can filter out cycles if we want with the expression <code>and not coalesce(l.is_cycle, false)</code></ul><p>I created many different tests with many different datasets. And they all return <strong>the identical results</strong> to a recursive CTE version:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> select_nodes_recursive_cte(</span></span>
<span class=line><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    is_cycle </span><span style="color: #569CD6">boolean</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">path</span><span style="color: #E6E6E6"> record[]</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class=line><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">$$</span></span>
<span class=line><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">        id,</span></span>
<span class=line><span style="color: #E6E6E6">        parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">        big_tree_test</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class=line><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union all</span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">        rec.parent_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        rec.level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> big_tree_test t </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> rec.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #E6E6E6">cycle id </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6"> is_cycle </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">path</span></span>
<span class=line><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> r.id, r.parent_id, r.level, is_cycle, </span><span style="color: #569CD6">path</span></span>
<span class=line><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _recursive_cte r</span></span>
<span class=line><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> is_cycle;</span></span>
<span class=line><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> </span><span style="color: #795E26">replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> select_nodes_recursive_cte(</span></span>
<span class=line><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    is_cycle </span><span style="color: #0000FF">boolean</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">path</span><span style="color: #000000"> record[]</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class=line><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">$$</span></span>
<span class=line><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">        id,</span></span>
<span class=line><span style="color: #000000">        parent_id,</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">        big_tree_test</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        id = _id</span></span>
<span class=line><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">union all</span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">        rec.parent_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class=line><span style="color: #000000">        t.parent_id,</span></span>
<span class=line><span style="color: #000000">        rec.level + </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">        _recursive_cte rec</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> big_tree_test t </span><span style="color: #0000FF">on</span><span style="color: #000000"> rec.parent_id = t.id</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #000000">cycle id </span><span style="color: #0000FF">set</span><span style="color: #000000"> is_cycle </span><span style="color: #0000FF">using</span><span style="color: #000000"> </span><span style="color: #0000FF">path</span></span>
<span class=line><span style="color: #0000FF">select</span><span style="color: #000000"> r.id, r.parent_id, r.level, is_cycle, </span><span style="color: #0000FF">path</span></span>
<span class=line><span style="color: #0000FF">from</span><span style="color: #000000"> _recursive_cte r</span></span>
<span class=line><span style="color: #0000FF">where</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> is_cycle;</span></span>
<span class=line><span style="color: #000000">$$;</span></span></code></pre></div><h2 id=performances>Performances</h2><p>Finally, performances:<table class="table table-sm table-hover table-bordered"style="width: initial;"><thead><tr><th align=right>round<th align=right>records <sup>1</sup><th align=right>unique nodes <sup>2</sup><th align=right>total rows <sup>3</sup><th align=center><code>select_nodes_recursive_function</code><th align=center><code>select_nodes_recursive_cte</code><tbody class=table-group-divider><tr><td align=right>1<td align=right>20<td align=right>10<td align=right>28<td align=center>00:00:00.055<td align=center>00:00:00.040<tr><td align=right>2<td align=right>20<td align=right>10<td align=right>28<td align=center>00:00:00.076<td align=center>00:00:00.043<tr><td align=right>3<td align=right>20<td align=right>10<td align=right>28<td align=center>00:00:00.056<td align=center>00:00:00.040<tr><td align=right>1<td align=right>49<td align=right>20<td align=right>3674<td align=center>00:00:00.106<td align=center>00:00:00.086<tr><td align=right>2<td align=right>49<td align=right>20<td align=right>3674<td align=center>00:00:00.078<td align=center>00:00:00.082<tr><td align=right>3<td align=right>49<td align=right>20<td align=right>3674<td align=center>00:00:00.071<td align=center>00:00:00.074<tr><td align=right>1<td align=right>101<td align=right>40<td align=right>1583446<td align=center>00:00:49.447<td align=center>00:00:31.218<tr><td align=right>2<td align=right>101<td align=right>40<td align=right>1583446<td align=center>00:00:46.344<td align=center>00:00:31.118<tr><td align=right>3<td align=right>101<td align=right>40<td align=right>1583446<td align=center>00:00:44.252<td align=center>00:00:31.099</table><ul><li><strong>1 - records</strong>: This is the number of total records in <code>big_tree_test</code> table. That is the number of tree connections.<li><strong>2 - unique nodes</strong>: This is the number of unique <code>id</code> values (nodes) in <code>big_tree_test</code> table. That is the number of the unique tree nodes.<li><strong>3 - total rows</strong>: This is the total number of records returned by those two functions. That is the number of unique paths between nodes.</ul><p>Note: any larger dataset from these would yield a too big dataset, and it would end up in the same error for both of these functions: <code>ERROR: could not write to file "base/pgsql_tmp/pgsql_tmp226.8386": No space left on device</code><p>Now, based on these results, we can conclude two things:<ol><li><p>PostgreSQL Recursive CTE built-in functionality is indeed faster and better optimized.<li><p>Both functions are returning an insane number of records. That is because the further two nodes are distant from each other on the graph - there are more possible paths between the two nodes. If we take two nodes from opposite sides of the graphs, there will be a vast number of possible paths between those two nodes. Both of these functions return <strong>all possible paths between all existing nodes</strong>. That is why the number of function results is progressively growing as the number of nodes (records in the test table) grows.</ol><h2 id=conslusion>Conslusion</h2><p>Now, we see that PostgreSQL functionality for the same algorithm is indeed better optimized, as it should be.<p>However, they both return an insane number of records, that is, the total number of possible paths between all possible nodes. And that is, of course, very hardware intensive.<p>And it very well may be unnecessary.<p>I started this series of articles with a clear requirement - Let's write a function that will return all table names that are related to the table from a parameter on any possible level. In that context, path calculation and even cycle aren't really necessary.<p>And that small distinct requirement could mean milliseconds of processing versus hours of expensive processing.<p>A simple example, let's modify this recursive function <code>select_nodes_recursive_function</code> so that:<ul><li>It doesn't return all possible paths.<li>It returns all possible nodes (connections) with only one path, Any path, just not all paths.<li>We will keep our "is cycle" check, just in case we don't end up in an endless loop.</ul><p>In that case, we would add <code>limit 1</code> to the lateral subquery that calculates our path:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">    t.id,</span></span>
<span class=line><span style="color: #E6E6E6">    t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">    _level,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">coalesce</span><span style="color: #E6E6E6">(l.is_cycle, false) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> is_cycle,</span></span>
<span class=line><span style="color: #E6E6E6">    array_append(l.path, t.id) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">path</span></span>
<span class=line><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">    big_tree_test t</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">left outer join</span><span style="color: #E6E6E6"> lateral (</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> p.path, t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(p.path) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> is_cycle</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result p</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> p.level </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _level </span><span style="color: #D4D4D4">-</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> p.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">limit</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class=line><span style="color: #E6E6E6">    ) l </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> true</span></span>
<span class=line><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">    t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_id)</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">coalesce</span><span style="color: #E6E6E6">(l.is_cycle, false)</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">    t.id,</span></span>
<span class=line><span style="color: #000000">    t.parent_id,</span></span>
<span class=line><span style="color: #000000">    _level,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #795E26">coalesce</span><span style="color: #000000">(l.is_cycle, false) </span><span style="color: #0000FF">as</span><span style="color: #000000"> is_cycle,</span></span>
<span class=line><span style="color: #000000">    array_append(l.path, t.id) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">path</span></span>
<span class=line><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">    big_tree_test t</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">left outer join</span><span style="color: #000000"> lateral (</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> p.path, t.id = any(p.path) </span><span style="color: #0000FF">as</span><span style="color: #000000"> is_cycle</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result p</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> p.level = _level - </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> p.parent_id = t.id</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">limit</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class=line><span style="color: #000000">    ) l </span><span style="color: #0000FF">on</span><span style="color: #000000"> true</span></span>
<span class=line><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">    t.id = any(_id)</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">and</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #795E26">coalesce</span><span style="color: #000000">(l.is_cycle, false)</span></span></code></pre></div><p>And that is enough to return only one example path, not all. Let's see performances now and a bit bigger dataset:<table class="table table-sm table-hover table-bordered"style="width: initial;"><thead><tr><th align=right>round<th align=right>records<th align=right>unique nodes<th align=right>total rows<th align=center><code>select_nodes_recursive_function</code><th align=center><code>select_nodes_recursive_cte</code><tbody class=table-group-divider><tr><td align=right>1<td align=right>305<td align=right>100<td align=right>9130<td align=center>00:00:01.815<td align=center><code>ERROR</code><tr><td align=right>2<td align=right>305<td align=right>100<td align=right>9130<td align=center>00:00:01.815<td align=center><code>ERROR</code><tr><td align=right>3<td align=right>305<td align=right>100<td align=right>9130<td align=center>00:00:01.815<td align=center><code>ERROR</code></table><p>So this small change with <code>limit 1</code> gave us:<ul><li>Unique nodes per recursion level with one example path.<li>Many times better performances than recursive CTE, which tried to yield a too-huge dataset (probably hundreds of millions) and ended up with ERROR (ran out of space).</ul><p>However, even that is not what is required in these functional requirements: Let's write a function that will return all table names that are related to the table from a parameter on any possible level.<p>For this, we simply need a unique node on any level. We basically don't even care about the level at all. So we may return a unique node on the first level we see that node.<p>And for that, the algorithm from the previous article is enough. I will paste it here now:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> select_nodes_recursive_function(</span></span>
<span class=line><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[],</span></span>
<span class=line><span style="color: #E6E6E6">    _level </span><span style="color: #569CD6">int</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class=line><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">$$</span></span>
<span class=line><span style="color: #569CD6">declare</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">    _row record;</span></span>
<span class=line><span style="color: #E6E6E6">    _parents </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[];</span></span>
<span class=line><span style="color: #569CD6">begin</span><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> information_schema.tables t</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'_result'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> table_type </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'LOCAL TEMPORARY'</span></span>
<span class=line><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">then</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> _result (</span></span>
<span class=line><span style="color: #E6E6E6">            id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">            parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">            </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class=line><span style="color: #E6E6E6">        ) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    _id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> array(</span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> unnest(_id) </span><span style="color: #569CD6">except</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">select distinct</span><span style="color: #E6E6E6"> t.id </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result t);</span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> _id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'{}'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">then</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> _insert_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">insert</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _result</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">            t.id,</span></span>
<span class=line><span style="color: #E6E6E6">            t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">            _level</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">            big_tree_test t</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">            t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_id)</span></span>
<span class=line><span style="color: #E6E6E6">        returning </span></span>
<span class=line><span style="color: #E6E6E6">            _result.parent_id</span></span>
<span class=line><span style="color: #E6E6E6">    ) </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> array_agg(</span><span style="color: #569CD6">distinct</span><span style="color: #E6E6E6"> p.parent_id)</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _parents</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _insert_cte p; </span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    perform select_nodes_recursive_function(_parents, _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">);</span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        t.id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        _result t;</span></span>
<span class=line><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">$$;</span></span>
<span class=line></span>
<span class=line><span style="color: #6A9955">-- helper overload</span></span>
<span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> select_nodes_recursive_function(_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class=line><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'select id, parent_id, level from select_nodes_recursive_function(array[_id]::text[], 1)'</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> </span><span style="color: #795E26">replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> select_nodes_recursive_function(</span></span>
<span class=line><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span><span style="color: #000000">[],</span></span>
<span class=line><span style="color: #000000">    _level </span><span style="color: #0000FF">int</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class=line><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">$$</span></span>
<span class=line><span style="color: #0000FF">declare</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">    _row record;</span></span>
<span class=line><span style="color: #000000">    _parents </span><span style="color: #0000FF">text</span><span style="color: #000000">[];</span></span>
<span class=line><span style="color: #0000FF">begin</span><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> information_schema.tables t</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.table_name = </span><span style="color: #A31515">'_result'</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> table_type = </span><span style="color: #A31515">'LOCAL TEMPORARY'</span></span>
<span class=line><span style="color: #000000">    ) </span><span style="color: #0000FF">then</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> _result (</span></span>
<span class=line><span style="color: #000000">            id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">            parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">            </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class=line><span style="color: #000000">        ) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    _id = array(</span><span style="color: #0000FF">select</span><span style="color: #000000"> unnest(_id) </span><span style="color: #0000FF">except</span><span style="color: #000000"> </span><span style="color: #0000FF">select distinct</span><span style="color: #000000"> t.id </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result t);</span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> _id = </span><span style="color: #A31515">'{}'</span><span style="color: #000000"> </span><span style="color: #0000FF">then</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">with</span><span style="color: #000000"> _insert_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">insert</span><span style="color: #000000"> </span><span style="color: #0000FF">into</span><span style="color: #000000"> _result</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">            t.id,</span></span>
<span class=line><span style="color: #000000">            t.parent_id,</span></span>
<span class=line><span style="color: #000000">            _level</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">            big_tree_test t</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">            t.id = any(_id)</span></span>
<span class=line><span style="color: #000000">        returning </span></span>
<span class=line><span style="color: #000000">            _result.parent_id</span></span>
<span class=line><span style="color: #000000">    ) </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> array_agg(</span><span style="color: #0000FF">distinct</span><span style="color: #000000"> p.parent_id)</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">into</span><span style="color: #000000"> _parents</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> _insert_cte p; </span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    perform select_nodes_recursive_function(_parents, _level + </span><span style="color: #098658">1</span><span style="color: #000000">);</span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        t.id,</span></span>
<span class=line><span style="color: #000000">        t.parent_id,</span></span>
<span class=line><span style="color: #000000">        t.level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        _result t;</span></span>
<span class=line><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">$$;</span></span>
<span class=line></span>
<span class=line><span style="color: #008000">-- helper overload</span></span>
<span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> </span><span style="color: #795E26">replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> select_nodes_recursive_function(_id </span><span style="color: #0000FF">text</span><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class=line><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">'select id, parent_id, level from select_nodes_recursive_function(array[_id]::text[], 1)'</span><span style="color: #000000">;</span></span></code></pre></div><p>To repeat: this function returns unique nodes at any level of recursion and exits when all nodes have been visited. And that's all that we need.<p>Now, let's see some performances:<table class="table table-sm table-hover table-bordered"style="width: initial;"><thead><tr><th align=right>round<th align=right>records<th align=right>unique nodes<th align=right>total rows<th align=center><code>select_nodes_recursive_function</code><th align=center><code>select_nodes_recursive_cte</code><tbody class=table-group-divider><tr><td align=right>1<td align=right>305<td align=right>100<td align=right>9130<td align=center>00:00:00.055<td align=center><code>ERROR</code><tr><td align=right>2<td align=right>305<td align=right>100<td align=right>9130<td align=center>00:00:00.048<td align=center><code>ERROR</code><tr><td align=right>3<td align=right>305<td align=right>100<td align=right>9130<td align=center>00:00:00.049<td align=center><code>ERROR</code></table><p>Of course, for this dataset, recursive CTE with cycle/path check breaks down.<p>But the thing is, we don't really need that. We can fulfill what is required by using simple recursion with <code>plpgsql</code>, and we will be able to process the data thousands of times faster.<p>So, in the final conclusion, I still believe that the classical recursion approach using the <code>plpgsql</code> procedural approach can yield much better results. It is flexible enough to help us avoid unnecessary processing and to return exactly what we need from our tree structures. Calculation of all possible paths can lead to serious performance degradations, and it would be wise to avoid that if we can. This is one possibility how we can do that.<div class="my-5 px-5 border-top links svelte-rzcvgm"><div><div class="link-title text-start svelte-rzcvgm">PREVIOUS</div><a class="btn btn-link text-start"href=/blog/recursion-postgresql/part3-cycle-detection>Part 3 - Cycle Detection</a></div><div><div class="link-title text-end svelte-rzcvgm text-muted">NEXT</div></div></div></div></div><div class="rightside svelte-2kl70j"><div class=svelte-2kl70j><ul class="navbar-nav sidenav svelte-2kl70j"><li class="nav-txt-divider text-muted svelte-2kl70j"><hr class=svelte-2kl70j><span class=svelte-2kl70j>on this page</span><hr class=svelte-2kl70j><li class="nav-item toc1 right svelte-2kl70j bookmark-nav"data-id=recursion-with-postgresql-part-4---finding-the-right-path title="Recursion with PostgreSQL Part 4 - Finding the Right Path"><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#recursion-with-postgresql-part-4---finding-the-right-path>Recursion with PostgreSQL Part 4 - Finding the Right Path</a><li class="nav-item toc1 right svelte-2kl70j bookmark-nav"data-id=example title=Example><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#example>Example</a><li class="nav-item toc2 right svelte-2kl70j bookmark-nav"data-id=new-recursive-function title="New Recursive Function"><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#new-recursive-function>New Recursive Function</a><li class="nav-item toc2 right svelte-2kl70j bookmark-nav"data-id=performances title=Performances><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#performances>Performances</a><li class="nav-item toc2 right svelte-2kl70j bookmark-nav"data-id=conslusion title=Conslusion><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#conslusion>Conslusion</a><li><hr class=svelte-2kl70j><div class="navbar-nav sidenav"><div class="text-muted fs-_7rem mx-2">PREVIOUS</div><a class="btn btn-link btn-sm text-start"href=/blog/recursion-postgresql/part3-cycle-detection>Part 3 - Cycle Detection</a></div></ul></div></div></main><script>!function(){var i=document.querySelector("nav.navbar"),f=document.getElementsByTagName("main")[0],L=f.getElementsByClassName("sidebar")[0],w=f.getElementsByClassName("content")[0],s=document.querySelectorAll("div.code");function k(e,t){for(var n=2;n<arguments.length;n++)e.classList.remove(arguments[n]);e.classList.add(t)}var t=document.getElementsByTagName("html")[0],a=i.querySelector("#theme-btn"),o="theme";function n(e){var t=a.getElementsByTagName("svg");"dark"===e?(t[0].style.display="",t[1].style.display="none",a.getElementsByClassName("check")[0].classList.add("checked")):(t[0].style.display="none",t[1].style.display="",a.getElementsByClassName("check")[0].classList.remove("checked"));for(var n=0;n<s.length;n++){var i=s[n];"dark"===e?(i.children[1].style.display="inherit",i.children[2].style.display="none"):"light"===e&&(i.children[1].style.display="none",i.children[2].style.display="inherit")}window._theme&&window._theme(e)}function r(e,t){var n=e.currentTarget;if(!n.classList.contains("bi-check")){for(var i="",s=0;s<n.classList.length;s++)if(n.classList[s].startsWith("bi-")){i=n.classList[s];break}n.classList.remove(i),n.classList.add("spinner-border-sm"),n.classList.add("spinner-border");e=bootstrap.Tooltip.getInstance(n);e&&(e.setContent({".tooltip-inner":"Copying..."}),e.show()),t(n,function(){var e;n.classList.remove(i),n.classList.remove("spinner-border-sm"),n.classList.remove("spinner-border"),n.classList.add("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&(e.setContent({".tooltip-inner":"Copied!"}),e.show()),setTimeout(function(){var e;n.classList.add(i),n.classList.remove("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&e.setContent({".tooltip-inner":n.dataset.bsTitle})},2e3)})}}function e(e){r(e,function(e,t){navigator.clipboard.writeText(e.parentElement.nextSibling.innerText),t()})}function l(e){r(e,function(e,t){var n=localStorage.getItem(o);e="dark"===n?e.parentElement.parentElement.children[1]:e.parentElement.parentElement.children[2],setTimeout(function(){html2canvas(e).then(e=>{e.toBlob(e=>navigator.clipboard.write([new ClipboardItem({"image/png":e})])),t()})},0)})}a.addEventListener("click",()=>{var e="dark"===localStorage.getItem(o)?"light":"dark";localStorage.setItem(o,e),n(t.dataset.bsTheme=e)}),n(localStorage.getItem(o)),a.children[0].classList.remove("hidden");for(var c=0;c<s.length;c++)s[c].getElementsByClassName("copy-code")[0].addEventListener("click",e),s[c].getElementsByClassName("photo-code")[0].addEventListener("click",l);for(var d,E=function(){var a,s,o;if(f.children[2]&&"none"!=f.children[2].style.display)return a=f.children[1].children[0].querySelectorAll("[id]"),s=void 0,this.initNavs=function(e){o=e.querySelectorAll("li.bookmark-nav");for(var t=0;t<a.length;t++){for(var n=a[t].id,i=null,s=0;s<o.length;s++)if(o[s].dataset.id==n){i=o[s];break}a[t].nav=i}setTimeout(function(){for(var e=0;e<a.length;e++){var t=a[e];if(r(t).visible&&t.nav)return void t.nav.classList.add("active")}},1e3),l()},f.children[1].addEventListener("scroll",l),this;function r(e){var e=e.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight),n=0<e.top&&!(e.bottom<0||0<=e.top-t)||e.top<0&&e.bottom>t,i=!1;return{visible:n,above:i=n?i:e.bottom<t}}function l(){if(o&&o.length){for(var e=0;e<o.length;e++)o[e].classList.remove("active");for(var t=void 0,e=0;e<a.length;e++){const i=a[e];var n=r(i);if(!n.visible&&n.above&&(t=i.nav),n.visible&&i.nav&&!i.nav.classList.contains("active"))return i.nav.classList.add("active"),s&&clearTimeout(s),void(s=setTimeout(function(){i.nav.scrollIntoView({behavior:"smooth"}),s=void 0},250))}t&&!t.classList.contains("active")&&(t.classList.add("active"),s&&clearTimeout(s),s=setTimeout(function(){t.scrollIntoView({behavior:"smooth"}),s=void 0},250))}}}(),h=function(){var r,l=i.querySelector("#nav-btn"),c=480,d="200px",h="0.25fr",v=730,m=535,u=f.children[0].children[0].children[0],g=f.children[2]&&f.children[2].children[0].children[0],e="sidebar-pinned",b=null==localStorage.getItem(e)||"true"==localStorage.getItem(e),p=!1,y=!1;function t(){window._onresize&&window._onresize();var e=window.outerWidth||window.innerWidth,t=e<c,n=t?p?"100%":"0":b?""+d:"0",i=`grid-template-columns: ${n} 1fr`,s=t&&p?"width: 100%":"0"!=n?"":"display: none",a=t&&p?"display: none":"",o=t?p?"sidebar-show":"sidebar-hide":b?"sidebar-show":"sidebar-hide",n="0"==n;f.children[2]&&(h&&v&&m&&(n&&e<m||!n&&e<v?y||(u.innerHTML=r+g.innerHTML,E.initNavs(u),y=!0):y&&(u.innerHTML=r,E.initNavs(g),y=!1)),!h||t||y?(i+=";",f.children[2].style.display="none"):(i+=` ${h};`,f.children[2].style.display="")),k(l,!t&&b||t&&p?"rotate":"rotate-back","rotate","rotate-back"),b?l.classList.add("text-shadow"):l.classList.remove("text-shadow"),f.style=L?i:"display: grid;",L&&k(L,o,"sidebar-show","sidebar-hide"),L&&(L.firstChild.style=s),w.style=a}function n(){window.outerWidth<c?p=!p:b=!b,localStorage.setItem(e,b.toString()),t(),b?l.classList.add("text-shadow"):l.classList.remove("text-shadow")}return h&&v&&m&&g&&(r=u.innerHTML,E.initNavs(g)),l.addEventListener("click",n),(window.onresize=t)(),this.closeSidebar=function(){window.outerWidth<c&&p&&n()},this}(),v=document.getElementsByClassName("auto-close"),m=0;m<v.length;m++)v[m].addEventListener("click",function(e){h.closeSidebar()});location.hash&&(d=document.getElementById(location.hash.replace("#","")))&&d.scrollIntoView()}();</script><script src=/bootstrap.bundle.min.js></script><script>!function(){for(var t=document.querySelectorAll('[data-bs-toggle="tooltip"]'),e=0;e<t.length;e++)new bootstrap.Tooltip(t[e]);var o=document.getElementsByClassName("accordion-item");if(o.length)for(e=0;e<o.length;e++){var l=o[e];l.querySelectorAll("[href='"+document.location.pathname+"']").length&&l.firstChild.click()}}();</script><script src=/html2canvas.min.js></script><script async defer src=https://buttons.github.io/buttons.js></script><script async data-id=101435862 src=//static.getclicky.com/js></script>