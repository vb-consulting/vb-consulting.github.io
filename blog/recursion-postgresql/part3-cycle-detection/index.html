<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Recursion with PostgreSQL Part 3 - Cycle Detection</title><meta name="description" content="Follow-Up 2 on PostgreSQL recursive function. Learning the cycle detection in recursive queries."><link href="https://vb-consulting.github.io/blog/recursion-postgresql/part3-cycle-detection/" rel="canonical"><meta name="keywords" content="postgresql, sql, plpgsql, recursion, tree, cte, function"><meta name="author" content="floki"><meta prefix="og: http://ogp.me/ns#" property="og:title" content="Recursion with PostgreSQL Part 3 - Cycle Detection"><meta prefix="og: http://ogp.me/ns#" property="og:description" content="Follow-Up 2 on PostgreSQL recursive function. Learning the cycle detection in recursive queries."><meta prefix="og: http://ogp.me/ns#" property="og:image" content="https://vb-consulting.github.io/neretva.jpg"><meta prefix="og: http://ogp.me/ns#" property="og:type" content="article"><meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="VB-Consulting"><meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://vb-consulting.github.io/blog/recursion-postgresql/part3-cycle-detection/"><meta name="twitter:image" content="https://vb-consulting.github.io/neretva.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:description" content="Follow-Up 2 on PostgreSQL recursive function. Learning the cycle detection in recursive queries."><link rel="stylesheet" href="/_elderjs/assets/svelte-345b0f69.css" media="all"><style></style><link href="/style.css?1730285059027" rel="stylesheet"><script>!function(){var e="theme",t=localStorage.getItem(e);t||(t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",localStorage.setItem(e,t)),document.getElementsByTagName("html")[0].dataset.bsTheme=t}();</script></head><body class="d-flex flex-column h-100"><header id="header"><nav class="navbar navbar-expand-md navbar-dark fixed-top py-0 py-md-0 svelte-30jr7w"><div class="container-fluid flex-nowrap svelte-30jr7w"><div class="d-flex svelte-30jr7w"><button id="nav-btn" type="button" class="d-flex btn btn-sm logo animate-rotate svelte-30jr7w"><i class="material-icons-outlined">menu</i></button> <a class="nav-link my-auto ms-2 fw-semibold home svelte-30jr7w" href="/"><i class="bi-chevron-double-left"></i> VB Home</a></div><div class="d-flex right svelte-30jr7w"><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Become a Patreon" href="https://www.patreon.com/vbconsulting" target="_blank"><div class="patreon"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Buy Me a Coffee" href="https://www.buymeacoffee.com/vbilopavu" target="_blank"><div class="bmc"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto me-2 svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="vb-consulting on GitHub" href="https://github.com/vb-consulting/"><i class="bi-github"></i></a> <a class="github-button svelte-30jr7w" href="https://github.com/vb-consulting/" data-bs-toggle="tooltip" data-bs-html="true" title="Star vb-consulting on GitHub" data-color-scheme="no-preference: light_high_contrast; light: light_high_contrast; dark: light_high_contrast;" data-icon="octicon-star" data-show-count="true" aria-label="Star vb-consulting on GitHub"></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><button id="theme-btn" type="button" aria-pressed="true" aria-label="theme" class="svelte-30jr7w"><span class="check hidden svelte-30jr7w"><span class="icon svelte-30jr7w"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><path fill="currentColor" d="M12 21q-3.775 0-6.388-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.625-.075.975.45t-.025 1.1q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.525-.35 1.075-.037t.475.987q-.35 3.45-2.937 5.725T12 21Zm0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19Zm-.25-6.75Z"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M0 0h24v24H0z"></path><path fill="currentColor" d="M12 19a1 1 0 0 1 .993.883L13 20v1a1 1 0 0 1-1.993.117L11 21v-1a1 1 0 0 1 1-1zm6.313-2.09l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7a1 1 0 0 1 1.218-1.567l.102.07zm-11.306.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM4 11a1 1 0 0 1 .117 1.993L4 13H3a1 1 0 0 1-.117-1.993L3 11h1zm17 0a1 1 0 0 1 .117 1.993L21 13h-1a1 1 0 0 1-.117-1.993L20 11h1zM6.213 4.81l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7A1 1 0 0 1 6.11 4.74l.102.07zm12.894.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM12 2a1 1 0 0 1 .993.883L13 3v1a1 1 0 0 1-1.993.117L11 4V3a1 1 0 0 1 1-1zm0 5a5 5 0 1 1-4.995 5.217L7 12l.005-.217A5 5 0 0 1 12 7z"></path></g></svg></span></span></button></div></div></nav></header><main class="svelte-9zwk14"><div class="sidebar sidebar-hide svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-item svelte-9zwk14" data-id="" title="VB-Consulting"><a class="nav-link svelte-9zwk14 text-uppercase" href="/">VB-Consulting</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="NpgsqlRest"><a class="nav-link svelte-9zwk14 text-uppercase" href="/npgsqlrest/">NpgsqlRest</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="Norm.Net"><a class="nav-link svelte-9zwk14 text-uppercase" href="/norm.net/">Norm.Net</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="RazorSvelte"><a class="nav-link svelte-9zwk14 text-uppercase" href="/razorsvelte/">RazorSvelte</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PgRoutiner"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pgroutiner/">PgRoutiner</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="XUnit.Npgsql"><a class="nav-link svelte-9zwk14 text-uppercase" href="/xunit.npgsql/">XUnit.Npgsql</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="pgmigrations"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pgmigrations/">pgmigrations</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PostrgeSQL Schema Tools"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pg_schema_tools/">PostrgeSQL Schema Tools</a></li><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">blogs</span><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="See all blogs..."><a class="nav-link btn btn-sm w-fit px-3 mx-auto svelte-9zwk14 lr-arrow text-uppercase" href="/blogs/"><i class="bi bi-arrow-right-circle svelte-9zwk14"></i> <span class="btn-link">ALL BLOGS</span></a></li><li class="nav-item svelte-9zwk14" data-id="" title="Unit Testing and TDD With PostgreSQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/unit-testing-postgresql/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Unit Testing and TDD With PostgreSQL is Easy</a></li><li class="nav-item svelte-9zwk14" data-id="" title="From Transaction Scripts and Domain Model to SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/domain-model-transaction-script/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>From Transaction Scripts and Domain Model to SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Transaction Script DDD vs SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/transaction-script/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Transaction Script DDD vs SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Common Sense Software Design Approach for RDBMS-backed Type of Software"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/common-sense-design/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Common Sense Software Design</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-v2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest v2 Update üêòüî•</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-update1.6.2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest Update 1.6.2</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL Array Example"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-array/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Arrays üêò</a></li><li class="nav-item svelte-9zwk14" data-id="" title="How DDD is screwing up your SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/sql-vs-ddd/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>How DDD is screwing up your SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL Paging Benchmarks"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-paging/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Paging Benchmarks</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest NuGet Library</a></li></ul></div></div><div class="content svelte-9zwk14"><div class="banner svelte-1bxfgrx" style="background-image: url(/neretva.jpg); background-position: bottom; background-blend-mode: luminosity;"></div><div class="container-sm main-content blog svelte-1bxfgrx bannered"><div class="blog-head svelte-1bxfgrx"><a href="https://github.com/vb-consulting/blog/blob/master/LICENSE" class="text-shadow svelte-1bxfgrx" style="color: white">CC0-1.0 license</a></div><div class="categories svelte-1bxfgrx"><a href="/blogs/postgresql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># postgresql</span> </a><a href="/blogs/plpgsql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># plpgsql</span> </a><a href="/blogs/sql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># sql</span></a></div><h1 class="text-shadow" id="recursion-with-postgresql-part-3---cycle-detection">Recursion with PostgreSQL Part 3 - Cycle Detection</h1><div class="post-meta text-shadow"><div></div><div class="post-details"><div class="post-pic" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog." style="background-image: url(/floki2.jpg)"></div><div class="post-details-right"><div class="post-share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Frecursion-postgresql%2Fpart3-cycle-detection%2F" class="me-1 bi-linkedin" data-bs-toggle="tooltip" data-bs-html="true" title="Share on LinkedIn"><i class=""></i></a> <a href="http://twitter.com/share?text=Recursion%20with%20PostgreSQL%20Part%203%20-%20Cycle%20Detection%0AFollow-Up%202%20on%20PostgreSQL%20recursive%20function.%20Learning%20the%20cycle%20detection%20in%20recursive%20queries.%0A&url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Frecursion-postgresql%2Fpart3-cycle-detection%2F&hashtags=postgresql%2Cplpgsql%2Csql" class="me-1 bi-twitter-x" data-bs-toggle="tooltip" data-bs-html="true" title="Share on X"><i class=""></i></a> <a href="#" class="copy-url bi-clipboard" data-bs-toggle="tooltip" data-bs-html="true" title="Copy URL"><i class=""></i></a></div><div class="post-author">floki</div><div class="post-date">Sep 18, 2023</div></div></div></div><p>Yesterday, I wrote another article for my Recursion with PostgreSQL series: <a href="https://github.com/vb-consulting/blog/discussions/4">Recursion with PostgreSQL Follow-Up 1 - Performances </a>.</p><p>My conclusion was that the CTE recursion method was severely lacking a way out of the infinite loops - and then I proceeded to write a version that defined a maximum recursion depth as a parameter:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_nodes_recursive_cte</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    _max_recursion </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">100</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        id,</span></span>
<span class="line"><span style="color: #E6E6E6">        parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        big_tree_test</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union</span><span style="color: #E6E6E6"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.parent_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> big_tree_test t </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> rec.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6"> _max_recursion </span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> r.id, r.parent_id, r.level</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _recursive_cte r</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_nodes_recursive_cte</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    _max_recursion </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">100</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        id,</span></span>
<span class="line"><span style="color: #000000">        parent_id,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        big_tree_test</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        id = _id</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">union</span><span style="color: #000000"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        rec.parent_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class="line"><span style="color: #000000">        t.parent_id,</span></span>
<span class="line"><span style="color: #000000">        rec.level + </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> big_tree_test t </span><span style="color: #0000FF">on</span><span style="color: #000000"> rec.parent_id = t.id</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">level</span><span style="color: #000000"> &lt; _max_recursion </span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> r.id, r.parent_id, r.level</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> _recursive_cte r</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>And that seemed to me as a significant limitation on the part of PostgreSQL's recursive functionality, a sort of deal breaker in my book.</p><p>Then, I proceeded with a classic functional recursion (as opposed to this CTE recursion), and I tried to figure out how much it could be optimized.</p><p>Oh, much little did I know...</p><p>During the day, @xocolatl (Vik Fearing) left <a href="https://github.com/vb-consulting/blog/discussions/1#discussioncomment-7027306">this comment</a> that pointed out that PostgreSQL already has a feature called <a href="https://www.postgresql.org/docs/current/queries-with.html#QUERIES-WITH-CYCLE">Cycle Detection</a> which was exactly to solution for my problem.</p><p>And Vik was kind enough to even write a full working version for me (using the example from the first article).</p><p>What can I say? I always felt that three days of debugging and testing could save 30 minutes of reading the documentation. And I'm also amazed that there is always something new to learn in SQL, even after many decades of use.</p><p>Anyway, the CYCLE feature was exactly the right solution. Documentation:</p><blockquote><p>When working with recursive queries, it is important to be sure that the recursive part of the query will eventually return no tuples, or else the query will <strong>loop indefinitely.</strong> Sometimes, using UNION instead of UNION ALL can accomplish this by discarding rows that duplicate previous output rows. However, often, a cycle does not involve output rows that are completely duplicated: it may be necessary to check just one or a few fields to see if the same point has been reached before. The standard method for handling such situations is to compute an array of the already-visited values.</p></blockquote><p>The way it works syntax-wise is to add at the end of recursive CTE this: <code>CYCLE [field_to_check_for_cycle] SET is_cycle USING path</code>, where <code>path</code> is a newly generated field containing a path to check, but you may call it or use it as you wish.</p><p>The <code>is_cycle</code> is also a new field with a fixed name of the boolean type that will tell us if we are in a cycle or not. And all we have to do at the end is to check if we are in the cycle with <code>where not is_cycle</code>, and that is it.</p><p>So, given that example, Vik provided the function <code>select_nodes_recursive_cte</code>, will now look like this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_nodes_recursive_cte</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        id,</span></span>
<span class="line"><span style="color: #E6E6E6">        parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        big_tree_test</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union</span><span style="color: #E6E6E6"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.parent_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        rec.level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> big_tree_test t </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> rec.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">cycle id </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6"> is_cycle </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">path</span></span>
<span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> r.id, r.parent_id, r.level</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _recursive_cte r</span></span>
<span class="line"><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> is_cycle;</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_nodes_recursive_cte</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        id,</span></span>
<span class="line"><span style="color: #000000">        parent_id,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        big_tree_test</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        id = _id</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">union</span><span style="color: #000000"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">        rec.parent_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class="line"><span style="color: #000000">        t.parent_id,</span></span>
<span class="line"><span style="color: #000000">        rec.level + </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">        _recursive_cte rec</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> big_tree_test t </span><span style="color: #0000FF">on</span><span style="color: #000000"> rec.parent_id = t.id</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">cycle id </span><span style="color: #0000FF">set</span><span style="color: #000000"> is_cycle </span><span style="color: #0000FF">using</span><span style="color: #000000"> </span><span style="color: #0000FF">path</span></span>
<span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> r.id, r.parent_id, r.level</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> _recursive_cte r</span></span>
<span class="line"><span style="color: #0000FF">where</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> is_cycle;</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><h2 id="new-problem">New Problem</h2><p>After I tested this version on my standard test fixture:</p><div class="one-liner"><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> big_tree_test</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> * </span><span style="color: #0000FF">from</span><span style="color: #000000"> big_tree_test</span></span></code></pre></div></div><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th>id</th><th>parent_id</th></tr></thead><tbody class="table-group-divider"><tr><td>node_1</td><td>node_3</td></tr><tr><td>node_1</td><td>node_8</td></tr><tr><td>node_4</td><td>node_8</td></tr><tr><td>node_5</td><td>node_7</td></tr><tr><td>node_6</td><td>node_4</td></tr><tr><td>node_6</td><td>node_6</td></tr><tr><td>node_6</td><td>node_9</td></tr><tr><td>node_7</td><td>node_10</td></tr><tr><td>node_8</td><td>node_10</td></tr><tr><td>node_8</td><td>node_5</td></tr><tr><td>node_8</td><td>node_9</td></tr><tr><td>node_9</td><td>node_9</td></tr><tr><td>node_10</td><td>node_1</td></tr></tbody></table><p>I expect to see the following manually checked results:</p><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th>id</th><th>parent_id</th><th>level</th></tr></thead><tbody class="table-group-divider"><tr><td>node_1</td><td>node_3</td><td>1</td></tr><tr><td>node_1</td><td>node_8</td><td>1</td></tr><tr><td>node_8</td><td>node_10</td><td>2</td></tr><tr><td>node_8</td><td>node_5</td><td>2</td></tr><tr><td>node_8</td><td>node_9</td><td>2</td></tr><tr><td>node_10</td><td>node_1</td><td>3</td></tr><tr><td>node_5</td><td>node_7</td><td>3</td></tr><tr><td>node_9</td><td>node_9</td><td>3</td></tr><tr><td>node_7</td><td>node_10</td><td>4</td></tr></tbody></table><p>However, that is NOT what the new function with CYCLE returns. This version adds another (unexpected) recursion level (level 5 with <code>node_10</code>):</p><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th>id</th><th>parent_id</th><th>level</th></tr></thead><tbody class="table-group-divider"><tr><td>node_1</td><td>node_3</td><td>1</td></tr><tr><td>node_1</td><td>node_8</td><td>1</td></tr><tr><td>node_8</td><td>node_10</td><td>2</td></tr><tr><td>node_8</td><td>node_5</td><td>2</td></tr><tr><td>node_8</td><td>node_9</td><td>2</td></tr><tr><td>node_10</td><td>node_1</td><td>3</td></tr><tr><td>node_5</td><td>node_7</td><td>3</td></tr><tr><td>node_9</td><td>node_9</td><td>3</td></tr><tr><td>node_7</td><td>node_10</td><td>4</td></tr><tr><td><strong>node_10</strong></td><td><strong>node_1</strong></td><td><strong>5</strong></td></tr></tbody></table><p>The node <code>node_10</code> - <code>node_1</code> has already appeared in level 3 and, therefore, in my opinion - shouldn't be included in the results.</p><p>After some investigation, my best assumption is that the PostgreSQL algorithm, when it decides that the row is a cycle row - includes that row also into the results and then exists cycle.</p><p>And again, the only way to exclude this field that I've found is to use the MIN aggregate in the final query:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">    t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">min</span><span style="color: #E6E6E6">(t.level) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    _result t</span></span>
<span class="line"><span style="color: #569CD6">group by</span></span>
<span class="line"><span style="color: #E6E6E6">    t.id, t.parent_id;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    t.id,</span></span>
<span class="line"><span style="color: #000000">    t.parent_id,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #795E26">min</span><span style="color: #000000">(t.level) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    _result t</span></span>
<span class="line"><span style="color: #0000FF">group by</span></span>
<span class="line"><span style="color: #000000">    t.id, t.parent_id;</span></span></code></pre></div><p>After this small tweak - the results from both functions <code>select_nodes_recursive_cte</code> (recursive CTE with CYCLE) and <code>select_nodes_recursive_function</code> (my optimized classic function recursion version) - are identical.</p><p>The next step is to do some serious performance testing.</p><p>However, I'm still not completely sure about this last node: Maybe it would be a better idea to leave <code>select_nodes_recursive_cte</code> as-is (without MIN aggregate) and to modify <code>select_nodes_recursive_function</code> to behave identically as CTE with CYCLE version. That means that before exiting recursion, we must include that last node.</p><p>So the final version <code>select_nodes_recursive_function</code> looks like this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">select_nodes_recursive_function</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _p_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[],</span></span>
<span class="line"><span style="color: #E6E6E6">    _level </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">declare</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    _row record;</span></span>
<span class="line"><span style="color: #E6E6E6">    _parents </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[];</span></span>
<span class="line"><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[];</span></span>
<span class="line"><span style="color: #569CD6">begin</span><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> information_schema.tables t</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'_result'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> table_type </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'LOCAL TEMPORARY'</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> _result (</span></span>
<span class="line"><span style="color: #E6E6E6">            id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">            parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class="line"><span style="color: #E6E6E6">        ) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    _id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> unnest(_p_id) </span><span style="color: #569CD6">except</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">select distinct</span><span style="color: #E6E6E6"> t.id </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result t);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> _id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'{}'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">then</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> _result</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">            t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">            t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">            _level</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">            big_tree_test t</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">            t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_p_id);</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> _insert_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> _result</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span></span>
<span class="line"><span style="color: #E6E6E6">            t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">            t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">            _level</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span></span>
<span class="line"><span style="color: #E6E6E6">            big_tree_test t</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">            t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_id)</span></span>
<span class="line"><span style="color: #E6E6E6">        returning </span></span>
<span class="line"><span style="color: #E6E6E6">            _result.parent_id</span></span>
<span class="line"><span style="color: #E6E6E6">    ) </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> array_agg(</span><span style="color: #569CD6">distinct</span><span style="color: #E6E6E6"> p.parent_id)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _parents</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _insert_cte p; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    perform select_nodes_recursive_function(_parents, _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        t.id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class="line"><span style="color: #E6E6E6">        t.level</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">        _result t;</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">select_nodes_recursive_function</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _p_id </span><span style="color: #0000FF">text</span><span style="color: #000000">[],</span></span>
<span class="line"><span style="color: #000000">    _level </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">declare</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    _row record;</span></span>
<span class="line"><span style="color: #000000">    _parents </span><span style="color: #0000FF">text</span><span style="color: #000000">[];</span></span>
<span class="line"><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span><span style="color: #000000">[];</span></span>
<span class="line"><span style="color: #0000FF">begin</span><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> information_schema.tables t</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.table_name = </span><span style="color: #A31515">'_result'</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> table_type = </span><span style="color: #A31515">'LOCAL TEMPORARY'</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> _result (</span></span>
<span class="line"><span style="color: #000000">            id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">            parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">            </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class="line"><span style="color: #000000">        ) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    _id = </span><span style="color: #0000FF">array</span><span style="color: #000000">(</span><span style="color: #0000FF">select</span><span style="color: #000000"> unnest(_p_id) </span><span style="color: #0000FF">except</span><span style="color: #000000"> </span><span style="color: #0000FF">select distinct</span><span style="color: #000000"> t.id </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result t);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> _id = </span><span style="color: #A31515">'{}'</span><span style="color: #000000"> </span><span style="color: #0000FF">then</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">insert into</span><span style="color: #000000"> _result</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">            t.id,</span></span>
<span class="line"><span style="color: #000000">            t.parent_id,</span></span>
<span class="line"><span style="color: #000000">            _level</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">            big_tree_test t</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">            t.id = any(_p_id);</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">with</span><span style="color: #000000"> _insert_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">insert into</span><span style="color: #000000"> _result</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">select</span></span>
<span class="line"><span style="color: #000000">            t.id,</span></span>
<span class="line"><span style="color: #000000">            t.parent_id,</span></span>
<span class="line"><span style="color: #000000">            _level</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">from</span></span>
<span class="line"><span style="color: #000000">            big_tree_test t</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">            t.id = any(_id)</span></span>
<span class="line"><span style="color: #000000">        returning </span></span>
<span class="line"><span style="color: #000000">            _result.parent_id</span></span>
<span class="line"><span style="color: #000000">    ) </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> array_agg(</span><span style="color: #0000FF">distinct</span><span style="color: #000000"> p.parent_id)</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">into</span><span style="color: #000000"> _parents</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> _insert_cte p; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    perform select_nodes_recursive_function(_parents, _level + </span><span style="color: #098658">1</span><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        t.id,</span></span>
<span class="line"><span style="color: #000000">        t.parent_id,</span></span>
<span class="line"><span style="color: #000000">        t.level</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">        _result t;</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>As we can see, before we exit the recursion with <code>return</code> - we insert the current nodes with the current level.</p><p>Both functions are returning identical results now, and we are finally ready for serious performance testing.</p><h2 id="performance-testing">Performance Testing</h2><table class="table table-sm table-hover table-bordered" style="width: initial;"><thead><tr><th align="right">round</th><th align="right">records <sup>1</sup></th><th align="right">unique nodes <sup>2</sup></th><th align="center"><code>select_nodes_recursive_function</code></th><th align="center"><code>select_nodes_recursive_cte</code></th></tr></thead><tbody class="table-group-divider"><tr><td align="right">1</td><td align="right">13</td><td align="right">8</td><td align="center">00:00:00.058</td><td align="center">00:00:00.044</td></tr><tr><td align="right">2</td><td align="right">13</td><td align="right">8</td><td align="center">00:00:00.060</td><td align="center">00:00:00.037</td></tr><tr><td align="right">3</td><td align="right">13</td><td align="right">8</td><td align="center">00:00:00.053</td><td align="center">00:00:00.060</td></tr><tr><td align="right">1</td><td align="right">45</td><td align="right">20</td><td align="center">00:00:00.055</td><td align="center">00:00:00.051</td></tr><tr><td align="right">2</td><td align="right">45</td><td align="right">20</td><td align="center">00:00:00.056</td><td align="center">00:00:00.054</td></tr><tr><td align="right">3</td><td align="right">45</td><td align="right">20</td><td align="center">00:00:00.053</td><td align="center">00:00:00.071</td></tr><tr><td align="right">1</td><td align="right">90</td><td align="right">30</td><td align="center">00:00:00.065</td><td align="center">00:00:24.986</td></tr><tr><td align="right">2</td><td align="right">90</td><td align="right">30</td><td align="center">00:00:00.048</td><td align="center">00:00:19.298</td></tr><tr><td align="right">3</td><td align="right">90</td><td align="right">30</td><td align="center">00:00:00.060</td><td align="center">00:00:21.342</td></tr><tr><td align="right">1</td><td align="right">128</td><td align="right">30</td><td align="center">00:00:00.092</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">2</td><td align="right">128</td><td align="right">30</td><td align="center">00:00:00.041</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">3</td><td align="right">128</td><td align="right">30</td><td align="center">00:00:00.058</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">1</td><td align="right">291</td><td align="right">99</td><td align="center">00:00:00.089</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">2</td><td align="right">291</td><td align="right">99</td><td align="center">00:00:00.063</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">3</td><td align="right">291</td><td align="right">99</td><td align="center">00:00:00.049</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">1</td><td align="right">1723</td><td align="right">148</td><td align="center">00:00:00.100</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">2</td><td align="right">1723</td><td align="right">148</td><td align="center">00:00:00.050</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">3</td><td align="right">1723</td><td align="right">148</td><td align="center">00:00:00.054</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">1</td><td align="right">6638</td><td align="right">499</td><td align="center">00:00:00.092</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">2</td><td align="right">6638</td><td align="right">499</td><td align="center">00:00:00.069</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">3</td><td align="right">6638</td><td align="right">499</td><td align="center">00:00:00.078</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">1</td><td align="right">24803</td><td align="right">999</td><td align="center">00:00:00.120</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">2</td><td align="right">24803</td><td align="right">999</td><td align="center">00:00:00.128</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">3</td><td align="right">24803</td><td align="right">999</td><td align="center">00:00:00.128</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">1</td><td align="right">126804</td><td align="right">5000</td><td align="center">00:00:00.785</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">2</td><td align="right">126804</td><td align="right">5000</td><td align="center">00:00:00.751</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">3</td><td align="right">126804</td><td align="right">5000</td><td align="center">00:00:00.778</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">1</td><td align="right">1301479</td><td align="right">99999</td><td align="center">00:00:07.665</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">2</td><td align="right">1301479</td><td align="right">99999</td><td align="center">00:00:07.743</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">3</td><td align="right">1301479</td><td align="right">99999</td><td align="center">00:00:08.729</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">1</td><td align="right">2510281</td><td align="right">49998</td><td align="center">00:00:12.596</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">2</td><td align="right">2510281</td><td align="right">49998</td><td align="center">00:00:13.621</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">3</td><td align="right">2510281</td><td align="right">49998</td><td align="center">00:00:14.128</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">1</td><td align="right">5050378</td><td align="right">100000</td><td align="center">00:00:37.156</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">2</td><td align="right">5050378</td><td align="right">100000</td><td align="center">00:00:39.230</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr><tr><td align="right">3</td><td align="right">5050378</td><td align="right">100000</td><td align="center">00:00:40.284</td><td align="center"><code>ERROR</code> <sup>3</sup></td></tr></tbody></table><ul><li><strong>1</strong> - <strong>records</strong> is the number of total records in <code>big_tree_test</code> table. That is the number of tree connections.</li><li><strong>2</strong> - <strong>unique nodes</strong> is the number of unique id values (nodes) in <code>big_tree_test</code> table. That is the number of unique tree nodes.</li><li><strong>3</strong> - Execution ends up in an error. Approximately after a minute and a half of execution, it breaks with: <code>ERROR: could not write to file "base/pgsql_tmp/pgsql_tmp226.8386": No space left on device</code>. I have 400GB free on my laptop. In later tests, when I ran this function on a larger, the connection was being reset. So, something very strange is going on with recursive CTE execution.</li></ul><p>Optimized function <code>select_nodes_recursive_function</code> starts to seriously degrade in performance just after a couple of million tree connections and after a million unique tree nodes.</p><p>For the last performance tests, I tried to create an index on the tree table:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">index</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">on</span><span style="color: #E6E6E6"> big_tree_test </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> btree (id);</span></span>
<span class="line"><span style="color: #E6E6E6">reindex </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> big_tree_test;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">index</span><span style="color: #000000"> </span><span style="color: #795E26">on</span><span style="color: #000000"> big_tree_test </span><span style="color: #0000FF">using</span><span style="color: #000000"> btree (id);</span></span>
<span class="line"><span style="color: #000000">reindex </span><span style="color: #0000FF">table</span><span style="color: #000000"> big_tree_test;</span></span></code></pre></div><p>Results are approximately the same:</p><ol><li>00:00:33.184</li><li>00:00:37.163</li><li>00:00:36.106</li></ol><p>Most likely, indexes were never used.</p><p>Perhaps someone has a better idea?</p><h2 id="conclusion">Conclusion</h2><p>Makeup what you will, it is what it is.</p><p>I still hold the position that recursive CTE queries are confusing, at least to me.</p><p>Anyhow, if someone is using them and starts to experience performance issues, maybe there is a better way?</p><p>This approach I demonstrated in this series may be the solution for processing a huge number of tree nodes.</p><p>Or maybe not.</p><p>Anyhow, I said last time that I'd focus on testing and debugging these functions now, I guess it will have to wait for another article in this series.</p><h2 id="update-1">UPDATE 1</h2><p>I was suggested to use UNION ALL instead of just UNION in the CTE version. Unfortunately, no difference. On a small dataset, it will return identical results, it will be slow on a medium dataset, and it will crash on a big dataset.</p><p>I still don't know what to think of it.</p><p>Either the PostgreSQL CTE implementation is bad or ... I really don't know.</p><p>Next, I'll try to play around with that CTE version execution plan to try to figure it out.</p><h2 id="update-2">UPDATE 2</h2><p>Here is the execution plan for the CTE version (with UNION ALL, which should be better because it doesn't look for duplicates):</p><pre><code>CTE Scan on _recursive_cte r  (cost=73.68..86.58 rows=322 width=68) (actual time=0.014..81982.777 rows=7341736 loops=1)
  Filter: (NOT is_cycle)
  Rows Removed by Filter: 11291893
  CTE _recursive_cte
    ->  Recursive Union  (cost=0.00..73.68 rows=645 width=76) (actual time=0.012..65812.549 rows=18633629 loops=1)
          ->  Seq Scan on big_tree_test  (cost=0.00..2.59 rows=5 width=51) (actual time=0.011..0.019 rows=5 loops=1)
                Filter: (id = 'node_1'::text)
                Rows Removed by Filter: 122
          ->  Hash Join  (cost=1.31..5.82 rows=64 width=76) (actual time=216.675..1395.792 rows=503611 loops=37)
                Hash Cond: (t.id = rec.parent_id)
                ->  Seq Scan on big_tree_test t  (cost=0.00..2.27 rows=127 width=14) (actual time=0.009..0.031 rows=127 loops=36)
                ->  Hash  (cost=1.00..1.00 rows=25 width=68) (actual time=216.606..216.606 rows=198425 loops=37)
                      Buckets: 32768 (originally 1024)  Batches: 128 (originally 1)  Memory Usage: 117836kB
                      ->  WorkTable Scan on _recursive_cte rec  (cost=0.00..1.00 rows=25 width=68) (actual time=0.044..104.818 rows=198425 loops=37)
                            Filter: (NOT is_cycle)
                            Rows Removed by Filter: 305186
Planning Time: 0.206 ms
Execution Time: 83266.186 ms
</code></pre><p>This <code>-> Recursive Union (cost=0.00..73.68 rows=645 width=76) (actual time=0.012..65812.549 rows=18633629 loops=1)</code>, this has some crazy number of rows and execution time.</p><p>The <code>big_tree_test</code> has only 127 records with 49 unique id's.</p><p>I'm baffled.</p><div class="my-5 px-5 border-top links svelte-1bxfgrx"><div><div class="link-title text-start svelte-1bxfgrx">PREVIOUS</div><a class="btn text-start" href="/blog/recursion-postgresql/part2-performances">Part 2 - Performances</a></div><div><div class="link-title text-end svelte-1bxfgrx">NEXT</div><a class="btn text-end" href="/blog/recursion-postgresql/part4-right-path">Part 4 - Finding the Right Path</a></div></div><div class="w-fit mx-auto mt-5 mb-3 border-top"><div class="alert text-center fs-smaller text-muted">To receive notifications about new posts and updates, consider subscribing to my LinkdIn page:<br><a class="btn btn-sm" href="https://www.linkedin.com/in/vb-software/"><i class="bi-linkedin"></i> <span class="text-primary">vb-software linkedin</span></a><br><br>You will receive notifications about new posts on your LinkedIn feed.</div></div><div class="pt-5 border-top"><div id="comments-section" class="h5">Comments</div><script defer src="https://cdn.commento.io/js/commento.js" data-no-fonts="true" data-css-override="https://vb-consulting.github.io/style.css"></script><div id="commento"></div></div><footer class="mt-3 py-5"><div class="w-fit mx-auto mb-3 border-top border-bottom"><div class="alert text-center fs-smaller text-muted"><div class="alert text-center fs-smaller text-muted mb-1">If you like my content, use my software, or otherwise benefit from my work, consider supporting me by buying me a coffee. The software runs on coffee after all.</div><a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="Click Here to Buy Me a Coffee Or Scan the Code" href="https://www.buymeacoffee.com/vbilopavu" style="display: inline-grid;">Buy me a Coffee <img class="m-auto svelte-byttq0" alt="Scan Here To Buy Me a Cofee" src="/bmc_qr.png"></a></div></div><div class="d-flex justify-content-center"><a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="I Post Software Development Content Daily" href="https://www.linkedin.com/in/vb-software/" style="display: inline-grid;">Follow me on LinkedIn <i class="bi bi-linkedin"></i></a></div><div class="text-center"><div class="mt-5 mb-5 background-floki svelte-byttq0" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog."></div></div></footer><div class="mb-5"></div></div></div><div class="rightside svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">on this page</span><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="recursion-with-postgresql-part-3---cycle-detection" title="Recursion with PostgreSQL Part 3 - Cycle Detection"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#recursion-with-postgresql-part-3---cycle-detection">Recursion with PostgreSQL Part 3 - Cycle Detection</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="new-problem" title="New Problem"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#new-problem">New Problem</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="performance-testing" title="Performance Testing"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#performance-testing">Performance Testing</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="conclusion" title="Conclusion"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#conclusion">Conclusion</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="update-1" title="UPDATE 1"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#update-1">UPDATE 1</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="update-2" title="UPDATE 2"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#update-2">UPDATE 2</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="comments-section" title="Comments"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#comments-section">Comments</a></li><li><hr class="svelte-9zwk14"><div class="navbar-nav sidenav"><div class="text-muted fs-_7rem mx-2">PREVIOUS</div><a class="btn btn-sm text-start sidebar-link" href="/blog/recursion-postgresql/part2-performances"><span class="svelte-9zwk14">Part 2 - Performances</span></a></div><div class="navbar-nav sidenav mt-3"><div class="text-muted fs-_7rem mx-2">NEXT</div><a class="btn btn-sm text-start sidebar-link" href="/blog/recursion-postgresql/part4-right-path"><span class="svelte-9zwk14">Part 4 - Finding the Right Path</span></a></div></li></ul></div></div></main><script>!function(){var i=document.querySelector("nav.navbar"),f=document.getElementsByTagName("main")[0],L=f.getElementsByClassName("sidebar")[0],w=f.getElementsByClassName("content")[0],o=document.querySelectorAll("div.code"),k=i.querySelector(".home");function E(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n])}function T(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n]);E(e,t),e.classList.add(t)}function t(e,t){var n=e.currentTarget;if(!n.classList.contains("bi-check")){for(var i="",o=0;o<n.classList.length;o++)if(n.classList[o].startsWith("bi-")){i=n.classList[o];break}n.classList.remove(i),n.classList.add("spinner-border-sm"),n.classList.add("spinner-border");e=bootstrap.Tooltip.getInstance(n);e&&(e.setContent({".tooltip-inner":"Copying..."}),e.show()),t(n,function(){var e;n.classList.remove(i),n.classList.remove("spinner-border-sm"),n.classList.remove("spinner-border"),n.classList.add("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&(e.setContent({".tooltip-inner":"Copied!"}),e.show()),setTimeout(function(){var e;n.classList.add(i),n.classList.remove("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&e.setContent({".tooltip-inner":n.dataset.bsTitle})},2e3)})}}"/"==document.location.pathname&&T(k,"d-none");var e=document.querySelector(".post-share > .copy-url"),n=(e&&e.addEventListener("click",function(e){t(e,function(e,t){navigator.clipboard.writeText(document.location.origin+document.location.pathname),t()})}),document.getElementsByTagName("html")[0]),a=i.querySelector("#theme-btn"),s="theme";function l(e){var t=a.getElementsByTagName("svg");"dark"===e?(t[0].style.display="",t[1].style.display="none",a.getElementsByClassName("check")[0].classList.add("checked")):(t[0].style.display="none",t[1].style.display="",a.getElementsByClassName("check")[0].classList.remove("checked"));for(var n=0;n<o.length;n++){var i=o[n];"dark"===e?(i.children[1].style.display="inherit",i.children[2].style.display="none"):"light"===e&&(i.children[1].style.display="none",i.children[2].style.display="inherit")}window._theme&&window._theme(e)}function r(e){t(e,function(e,t){navigator.clipboard.writeText(e.parentElement.nextSibling.innerText),t()})}function c(e){t(e,function(e,t){var n=localStorage.getItem(s);e="dark"===n?e.parentElement.parentElement.children[1]:e.parentElement.parentElement.children[2],setTimeout(function(){html2canvas(e).then(e=>{e.toBlob(e=>navigator.clipboard.write([new ClipboardItem({"image/png":e})])),t()})},0)})}a.addEventListener("click",()=>{var e="dark"===localStorage.getItem(s)?"light":"dark";localStorage.setItem(s,e),l(n.dataset.bsTheme=e)}),l(localStorage.getItem(s)),a.children[0].classList.remove("hidden");for(var d=0;d<o.length;d++){o[d].getElementsByClassName("copy-code")[0].addEventListener("click",r);var m=o[d].getElementsByClassName("photo-code");m.length&&m[0].addEventListener("click",c)}for(var S=function(){var a,o,s;if(f.children[2]&&"none"!=f.children[2].style.display)return a=f.querySelector(".main-content").querySelectorAll("[id]"),o=void 0,this.initNavs=function(e){s=e.querySelectorAll("li.bookmark-nav");for(var t=0;t<a.length;t++){for(var n=a[t].id,i=null,o=0;o<s.length;o++)if(s[o].dataset.id==n){i=s[o];break}a[t].nav=i}setTimeout(function(){for(var e=0;e<a.length;e++){var t=a[e];if(l(t).visible&&t.nav)return void t.nav.classList.add("active")}},1e3),r()},f.children[1].addEventListener("scroll",r),this;function l(e){var e=e.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight),n=0<e.top&&!(e.bottom<0||0<=e.top-t)||e.top<0&&e.bottom>t,i=!1;return{visible:n,above:i=n?i:e.bottom<t}}function r(){if(s&&s.length){for(var e=0;e<s.length;e++)s[e].classList.remove("active");for(var t=void 0,e=0;e<a.length;e++){const i=a[e];var n=l(i);if(!n.visible&&n.above&&(t=i.nav),n.visible&&i.nav&&!i.nav.classList.contains("active"))return i.nav.classList.add("active"),o&&clearTimeout(o),void(o=setTimeout(function(){i.nav.scrollIntoView({behavior:"smooth"}),o=void 0},250))}t&&!t.classList.contains("active")&&(t.classList.add("active"),o&&clearTimeout(o),o=setTimeout(function(){t.scrollIntoView({behavior:"smooth"}),o=void 0},250))}}}(),h=function(){var l,r=i.querySelector("#nav-btn"),c=480,d="200px",m="0.25fr",h=730,v=535,u=f.children[0].children[0].children[0],g=f.children[2]&&f.children[2].children[0].children[0],t="sidebar-pinned",p=null==localStorage.getItem(t)||"true"==localStorage.getItem(t),y=!1,b=!1;function n(){window._onresize&&window._onresize();var e=window.outerWidth||window.innerWidth,t=e<c,n=t?y?"100%":"0":p?""+d:"0",i=`grid-template-columns: ${n} 1fr`,o=t&&y?"width: 100%":"0"!=n?"":"display: none",a=t&&y?"display: none":"",s=t?y?"sidebar-show":"sidebar-hide":p?"sidebar-show":"sidebar-hide",n="0"==n;f.children[2]&&(m&&h&&v&&(n&&e<v||!n&&e<h?b||(u.innerHTML=l+g.innerHTML,S.initNavs(u),b=!0):b&&(u.innerHTML=l,S.initNavs(g),b=!1)),!m||t||b?(i+=";",f.children[2].style.display="none"):(i+=` ${m};`,f.children[2].style.display="")),T(r,!t&&p||t&&y?"rotate":"rotate-back","rotate","rotate-back"),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),f.style=L?i:"display: grid;",L&&T(L,s,"sidebar-show","sidebar-hide"),L&&(L.firstChild.style=o),w.style=a,t&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),t&&y&&T(k,"d-none")}function e(){var e=window.outerWidth<c;e?y=!y:p=!p,localStorage.setItem(t,p.toString()),n(),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),e&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),e&&y&&T(k,"d-none")}return m&&h&&v&&g&&(l=u.innerHTML,S.initNavs(g)),r.addEventListener("click",e),(window.onresize=n)(),this.closeSidebar=function(){window.outerWidth<c&&y&&e()},this}(),v=document.getElementsByClassName("auto-close"),u=0;u<v.length;u++)v[u].addEventListener("click",function(e){h.closeSidebar()});location.hash&&(e=document.getElementById(location.hash.replace("#","")))&&e.scrollIntoView()}();</script><script src="/bootstrap.bundle.min.js"></script><script>!function(){for(var e=document.querySelectorAll('[data-bs-toggle="tooltip"]'),t=0;t<e.length;t++)new bootstrap.Tooltip(e[t]);var n=document.getElementsByClassName("accordion-item");if(n.length){for(t=0;t<n.length;t++){var o=n[t];o.querySelectorAll("[href='"+document.location.pathname+"']").length&&o.firstChild.click()}var l=document.querySelector("nav.navbar").querySelector(".home"),a=document.getElementsByClassName("accordion");"/"==document.location.pathname&&l.classList.add("d-none");for(t=0;t<n.length;t++){var s=a[t];s&&s.firstChild&&"VB-Consulting"==s.firstChild.title&&(null!=s.firstChild.querySelector(".collapse")&&l.classList.contains("d-none")&&"/"!=document.location.pathname&&l.classList.remove("d-none"),s.addEventListener("show.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none"),l.classList.add("d-none")}),s.addEventListener("hide.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none")}))}}}();</script><script src="/html2canvas.min.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script></body><script async data-id="101435862" src="//static.getclicky.com/js"></script></html>