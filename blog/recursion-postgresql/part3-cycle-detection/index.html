<!DOCTYPE html><html lang=en><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Recursion with PostgreSQL Part 3 - Cycle Detection</title><meta name=description content="Follow-Up 2 on PostgreSQL recursive function. Learning the cycle detection in recursive queries."><link href=https:/vb-consulting.github.io/blog/recursion-postgresql/part3-cycle-detection/ rel=canonical><meta name=keywords content="postgresql, sql, plpgsql, recursion, tree, cte, function"><meta name=author content=floki><meta property=og:title content="Recursion with PostgreSQL Part 3 - Cycle Detection"><meta property=og:description content="Follow-Up 2 on PostgreSQL recursive function. Learning the cycle detection in recursive queries."><meta property=og:image content=/neretva.jpg><meta property=og:type content=article><meta property=og:site_name content=VB-Consulting><meta property=og:url content=https:/vb-consulting.github.io/blog/recursion-postgresql/part3-cycle-detection/ ><meta name=twitter:image content=/neretva.jpg><meta name=twitter:card content=summary_large_image><meta name=twitter:description content="Follow-Up 2 on PostgreSQL recursive function. Learning the cycle detection in recursive queries."><link rel=stylesheet href=/_elderjs/assets/svelte-ed29dff4.css media=all><style></style><link href=/style.css?1702387073779 rel=stylesheet><script>!function(){var e="theme",t=localStorage.getItem(e);t||(t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",localStorage.setItem(e,t)),document.getElementsByTagName("html")[0].dataset.bsTheme=t}();</script><body class="d-flex flex-column h-100"><header id=header><nav class="navbar navbar-expand-md navbar-dark fixed-top py-0 py-md-0 svelte-13wa5zp"><div class="container-fluid flex-nowrap svelte-13wa5zp"><div class="d-flex svelte-13wa5zp"><button id=nav-btn type=button class="d-flex btn btn-sm logo animate-rotate svelte-13wa5zp"><i class=material-icons-outlined>menu</i></button></div><div class="d-flex right svelte-13wa5zp"><a class="nav-link my-auto me-2 svelte-13wa5zp"href=https://github.com/vb-consulting/blog/ ><i class=bi-github></i></a> <a class="github-button svelte-13wa5zp"href=https://github.com/vb-consulting/blog/ data-color-scheme="no-preference: light_high_contrast; light: light_high_contrast; dark: light_high_contrast;"data-icon=octicon-star data-show-count=true aria-label="Star vb-consulting/blog/ on GitHub"></a><div class="vr text-white my-auto svelte-13wa5zp"></div><button id=theme-btn type=button aria-pressed=true aria-label=theme class=svelte-13wa5zp><span class="check hidden svelte-13wa5zp"><span class="icon svelte-13wa5zp"><svg xmlns=http://www.w3.org/2000/svg width=32 height=32 viewBox="0 0 24 24"class=svelte-13wa5zp><path fill=currentColor d="M12 21q-3.775 0-6.388-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.625-.075.975.45t-.025 1.1q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.525-.35 1.075-.037t.475.987q-.35 3.45-2.937 5.725T12 21Zm0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19Zm-.25-6.75Z"></path></svg> <svg xmlns=http://www.w3.org/2000/svg width=32 height=32 viewBox="0 0 24 24"class=svelte-13wa5zp><g fill=none stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M0 0h24v24H0z"></path><path fill=currentColor d="M12 19a1 1 0 0 1 .993.883L13 20v1a1 1 0 0 1-1.993.117L11 21v-1a1 1 0 0 1 1-1zm6.313-2.09l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7a1 1 0 0 1 1.218-1.567l.102.07zm-11.306.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM4 11a1 1 0 0 1 .117 1.993L4 13H3a1 1 0 0 1-.117-1.993L3 11h1zm17 0a1 1 0 0 1 .117 1.993L21 13h-1a1 1 0 0 1-.117-1.993L20 11h1zM6.213 4.81l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7A1 1 0 0 1 6.11 4.74l.102.07zm12.894.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM12 2a1 1 0 0 1 .993.883L13 3v1a1 1 0 0 1-1.993.117L11 4V3a1 1 0 0 1 1-1zm0 5a5 5 0 1 1-4.995 5.217L7 12l.005-.217A5 5 0 0 1 12 7z"></path></g></svg></span></span></button></div></div></nav></header><main class=svelte-2kl70j><div class="sidebar sidebar-hide svelte-2kl70j"><div class=svelte-2kl70j><ul class="navbar-nav sidenav svelte-2kl70j"><li class="nav-item svelte-2kl70j"data-id=""title=VB-Consulting><a class="nav-link svelte-2kl70j text-uppercase"href=/ >VB-Consulting</a><li class="nav-divider svelte-2kl70j"><hr class=svelte-2kl70j><li class="nav-item toc2 svelte-2kl70j"data-id=""title=Norm.Net><a class="nav-link svelte-2kl70j text-uppercase"href=/norm.net/ >Norm.Net</a><li class="nav-item toc2 svelte-2kl70j"data-id=""title=RazorSvelte><a class="nav-link svelte-2kl70j text-uppercase"href=/razorsvelte/ >RazorSvelte</a><li class="nav-item toc2 svelte-2kl70j"data-id=""title=PgRoutiner><a class="nav-link svelte-2kl70j text-uppercase"href=/pgroutiner/ >PgRoutiner</a><li class="nav-item toc2 svelte-2kl70j"data-id=""title=XUnit.Npgsql><a class="nav-link svelte-2kl70j text-uppercase"href=/xunit.npgsql/ >XUnit.Npgsql</a><li class="nav-item toc2 svelte-2kl70j"data-id=""title="PostrgeSQL Schema Tools"><a class="nav-link svelte-2kl70j text-uppercase"href=/pg_schema_tools/ >PostrgeSQL Schema Tools</a><li class="nav-txt-divider text-muted svelte-2kl70j"><hr class=svelte-2kl70j><span class=svelte-2kl70j>blogs</span><hr class=svelte-2kl70j><li class="nav-item svelte-2kl70j"data-id=""title="What is Micro ORM?"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/micro-orm/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> What is Micro ORM?</a><li class="nav-item svelte-2kl70j"data-id=""title="What have the STORED PROCEDURES ever done for us?"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/what-have-stored-procedures-ever-done/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> What have the STORED PROCEDURES ever done for us?</a><li class="nav-item svelte-2kl70j"data-id=""title="Which Way .NET Developer?"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/where-to/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Which Way .NET Developer?</a><li class="nav-item svelte-2kl70j"data-id=""title="Custom Temporal Tables in PostgreSQL"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/postgresql-temporal-tables/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Custom Temporal Tables in PostgreSQL</a><li class="nav-item svelte-2kl70j"data-id=""title="Haters Build Software"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/haters-build-software/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Haters Build Software</a><li class="nav-item svelte-2kl70j"data-id=""title="Recursion with PostgreSQL Part 1 - A Different Type of Recursion"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/recursion-postgresql/part1-different-type-of-recursion/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Recursion with PostgreSQL Part 1 - A Different Type of Recursion</a><li class="nav-item svelte-2kl70j"data-id=""title="Recursion with PostgreSQL Part 2 - Performances"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/recursion-postgresql/part2-performances/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Recursion with PostgreSQL Part 2 - Performances</a><li class="nav-item svelte-2kl70j active"data-id=""title="Recursion with PostgreSQL Part 3 - Cycle Detection"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/recursion-postgresql/part3-cycle-detection/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Recursion with PostgreSQL Part 3 - Cycle Detection</a><li class="nav-item svelte-2kl70j"data-id=""title="Recursion with PostgreSQL Part 4 - Finding the Right Path"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/recursion-postgresql/part4-right-path/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Recursion with PostgreSQL Part 4 - Finding the Right Path</a><li class="nav-item svelte-2kl70j"data-id=""title="Execute Custom Function For Each Record"><a class="nav-link svelte-2kl70j lr-arrow text-uppercase"href=/blog/postgresql-record-type/ ><i class="bi bi-chat-left-text svelte-2kl70j"></i> Execute Custom Function For Each Record</a><li class="nav-item toc2 svelte-2kl70j"data-id=""title="ALL BLOGS"><a class="nav-link btn btn-link btn-sm svelte-2kl70j lr-arrow text-uppercase"href=/blogs/ ><i class="bi bi-arrow-right-circle svelte-2kl70j"></i> ALL BLOGS</a></ul></div></div><div class="content svelte-2kl70j"><div class="banner svelte-g8mw6f"style="background-image: url(/neretva.jpg); background-position: bottom;"></div><div class="container-sm main-content blog svelte-g8mw6f bannered"><div class="blog-head svelte-g8mw6f"><span class="badge rounded-pill text-bg-secondary">postgresql</span><span class="badge rounded-pill text-bg-secondary">plpgsql</span><span class="badge rounded-pill text-bg-secondary">sql</span> <a href=https://github.com/vb-consulting/blog/blob/master/LICENSE style="color: var(--bs-secondary-color) !important;"class=svelte-g8mw6f>CC0-1.0 license</a></div><h1 class=text-shadow id=recursion-with-postgresql-part-3---cycle-detection>Recursion with PostgreSQL Part 3 - Cycle Detection</h1><div class="post-meta text-shadow"><div class=post-share><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2Fvb-consulting.github.io%2Fblog%2Frecursion-postgresql%2Fpart3-cycle-detection%2F"class="me-1 bi-linkedin"data-bs-toggle=tooltip data-bs-html=true title="Share on LinkedIn"><i></i></a> <a href="http://twitter.com/share?text=Recursion%20with%20PostgreSQL%20Part%203%20-%20Cycle%20Detection%0A%0AFollow-Up%202%20on%20PostgreSQL%20recursive%20function.%20Learning%20the%20cycle%20detection%20in%20recursive%20queries.%0A%0A%0A&url=https%3A%2Fvb-consulting.github.io%2Fblog%2Frecursion-postgresql%2Fpart3-cycle-detection%2F&hashtags=postgresql%2Cplpgsql%2Csql"class="me-1 bi-twitter-x"data-bs-toggle=tooltip data-bs-html=true title="Share on X"><i></i></a> <a href=# class="copy-url bi-clipboard"data-bs-toggle=tooltip data-bs-html=true title="Copy URL"><i></i></a></div><div class=post-details><div class=post-pic data-bs-toggle=tooltip data-bs-html=true title="Floki is a developer dog."style="background-image: url(/floki.jpeg)"></div><div class=post-details-right><div class=post-author>floki</div><div class=post-date>Sep 18, 2023</div></div></div></div><p>Yesterday, I wrote another article for my Recursion with PostgreSQL series: <a href=https://github.com/vb-consulting/blog/discussions/4>Recursion with PostgreSQL Follow-Up 1 - Performances </a>.<p>My conclusion was that the CTE recursion method was severely lacking a way out of the infinite loops - and then I proceeded to write a version that defined a maximum recursion depth as a parameter:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> select_nodes_recursive_cte(</span></span>
<span class=line><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    _max_recursion </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">100</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class=line><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">$$</span></span>
<span class=line><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">        id,</span></span>
<span class=line><span style="color: #E6E6E6">        parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">        big_tree_test</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class=line><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union</span><span style="color: #E6E6E6"> </span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">        rec.parent_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        rec.level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> big_tree_test t </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> rec.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6"> _max_recursion </span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> r.id, r.parent_id, r.level</span></span>
<span class=line><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _recursive_cte r</span></span>
<span class=line><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> </span><span style="color: #795E26">replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> select_nodes_recursive_cte(</span></span>
<span class=line><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    _max_recursion </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">100</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class=line><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">$$</span></span>
<span class=line><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">        id,</span></span>
<span class=line><span style="color: #000000">        parent_id,</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">        big_tree_test</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        id = _id</span></span>
<span class=line><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">union</span><span style="color: #000000"> </span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">        rec.parent_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class=line><span style="color: #000000">        t.parent_id,</span></span>
<span class=line><span style="color: #000000">        rec.level + </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">        _recursive_cte rec</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> big_tree_test t </span><span style="color: #0000FF">on</span><span style="color: #000000"> rec.parent_id = t.id</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">where</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">level</span><span style="color: #000000"> &lt; _max_recursion </span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">select</span><span style="color: #000000"> r.id, r.parent_id, r.level</span></span>
<span class=line><span style="color: #0000FF">from</span><span style="color: #000000"> _recursive_cte r</span></span>
<span class=line><span style="color: #000000">$$;</span></span></code></pre></div><p>And that seemed to me as a significant limitation on the part of PostgreSQL's recursive functionality, a sort of deal breaker in my book.<p>Then, I proceeded with a classic functional recursion (as opposed to this CTE recursion), and I tried to figure out how much it could be optimized.<p>Oh, much little did I know...<p>During the day, @xocolatl (Vik Fearing) left <a href=https://github.com/vb-consulting/blog/discussions/1#discussioncomment-7027306>this comment</a> that pointed out that PostgreSQL already has a feature called <a href=https://www.postgresql.org/docs/current/queries-with.html#QUERIES-WITH-CYCLE>Cycle Detection</a> which was exactly to solution for my problem.<p>And Vik was kind enough to even write a full working version for me (using the example from the first article).<p>What can I say? I always felt that three days of debugging and testing could save 30 minutes of reading the documentation. And I'm also amazed that there is always something new to learn in SQL, even after many decades of use.<p>Anyway, the CYCLE feature was exactly the right solution. Documentation:<blockquote><p>When working with recursive queries, it is important to be sure that the recursive part of the query will eventually return no tuples, or else the query will <strong>loop indefinitely.</strong> Sometimes, using UNION instead of UNION ALL can accomplish this by discarding rows that duplicate previous output rows. However, often, a cycle does not involve output rows that are completely duplicated: it may be necessary to check just one or a few fields to see if the same point has been reached before. The standard method for handling such situations is to compute an array of the already-visited values.</blockquote><p>The way it works syntax-wise is to add at the end of recursive CTE this: <code>CYCLE [field_to_check_for_cycle] SET is_cycle USING path</code>, where <code>path</code> is a newly generated field containing a path to check, but you may call it or use it as you wish.<p>The <code>is_cycle</code> is also a new field with a fixed name of the boolean type that will tell us if we are in a cycle or not. And all we have to do at the end is to check if we are in the cycle with <code>where not is_cycle</code>, and that is it.<p>So, given that example, Vik provided the function <code>select_nodes_recursive_cte</code>, will now look like this:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> select_nodes_recursive_cte(</span></span>
<span class=line><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">sql</span></span>
<span class=line><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">$$</span></span>
<span class=line><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">recursive</span><span style="color: #E6E6E6"> _recursive_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">        id,</span></span>
<span class=line><span style="color: #E6E6E6">        parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">        big_tree_test</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> _id</span></span>
<span class=line><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">union</span><span style="color: #E6E6E6"> </span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">        rec.parent_id </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        rec.level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">        _recursive_cte rec</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">inner join</span><span style="color: #E6E6E6"> big_tree_test t </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> rec.parent_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> t.id</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #E6E6E6">cycle id </span><span style="color: #569CD6">set</span><span style="color: #E6E6E6"> is_cycle </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">path</span></span>
<span class=line><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> r.id, r.parent_id, r.level</span></span>
<span class=line><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _recursive_cte r</span></span>
<span class=line><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> is_cycle;</span></span>
<span class=line><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> </span><span style="color: #795E26">replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> select_nodes_recursive_cte(</span></span>
<span class=line><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">language</span><span style="color: #000000"> </span><span style="color: #0000FF">sql</span></span>
<span class=line><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">$$</span></span>
<span class=line><span style="color: #0000FF">with</span><span style="color: #000000"> </span><span style="color: #0000FF">recursive</span><span style="color: #000000"> _recursive_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">        id,</span></span>
<span class=line><span style="color: #000000">        parent_id,</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">        big_tree_test</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        id = _id</span></span>
<span class=line><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">union</span><span style="color: #000000"> </span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">        rec.parent_id </span><span style="color: #0000FF">as</span><span style="color: #000000"> id,</span></span>
<span class=line><span style="color: #000000">        t.parent_id,</span></span>
<span class=line><span style="color: #000000">        rec.level + </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">        _recursive_cte rec</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">inner join</span><span style="color: #000000"> big_tree_test t </span><span style="color: #0000FF">on</span><span style="color: #000000"> rec.parent_id = t.id</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #000000">cycle id </span><span style="color: #0000FF">set</span><span style="color: #000000"> is_cycle </span><span style="color: #0000FF">using</span><span style="color: #000000"> </span><span style="color: #0000FF">path</span></span>
<span class=line><span style="color: #0000FF">select</span><span style="color: #000000"> r.id, r.parent_id, r.level</span></span>
<span class=line><span style="color: #0000FF">from</span><span style="color: #000000"> _recursive_cte r</span></span>
<span class=line><span style="color: #0000FF">where</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> is_cycle;</span></span>
<span class=line><span style="color: #000000">$$;</span></span></code></pre></div><h2 id=new-problem>New Problem</h2><p>After I tested this version on my standard test fixture:<div class=one-liner><div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> big_tree_test</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">select</span><span style="color: #000000"> * </span><span style="color: #0000FF">from</span><span style="color: #000000"> big_tree_test</span></span></code></pre></div></div><table class="table table-sm table-hover table-bordered"style="width: initial;"><thead><tr><th>id<th>parent_id<tbody class=table-group-divider><tr><td>node_1<td>node_3<tr><td>node_1<td>node_8<tr><td>node_4<td>node_8<tr><td>node_5<td>node_7<tr><td>node_6<td>node_4<tr><td>node_6<td>node_6<tr><td>node_6<td>node_9<tr><td>node_7<td>node_10<tr><td>node_8<td>node_10<tr><td>node_8<td>node_5<tr><td>node_8<td>node_9<tr><td>node_9<td>node_9<tr><td>node_10<td>node_1</table><p>I expect to see the following manually checked results:<table class="table table-sm table-hover table-bordered"style="width: initial;"><thead><tr><th>id<th>parent_id<th>level<tbody class=table-group-divider><tr><td>node_1<td>node_3<td>1<tr><td>node_1<td>node_8<td>1<tr><td>node_8<td>node_10<td>2<tr><td>node_8<td>node_5<td>2<tr><td>node_8<td>node_9<td>2<tr><td>node_10<td>node_1<td>3<tr><td>node_5<td>node_7<td>3<tr><td>node_9<td>node_9<td>3<tr><td>node_7<td>node_10<td>4</table><p>However, that is NOT what the new function with CYCLE returns. This version adds another (unexpected) recursion level (level 5 with <code>node_10</code>):<table class="table table-sm table-hover table-bordered"style="width: initial;"><thead><tr><th>id<th>parent_id<th>level<tbody class=table-group-divider><tr><td>node_1<td>node_3<td>1<tr><td>node_1<td>node_8<td>1<tr><td>node_8<td>node_10<td>2<tr><td>node_8<td>node_5<td>2<tr><td>node_8<td>node_9<td>2<tr><td>node_10<td>node_1<td>3<tr><td>node_5<td>node_7<td>3<tr><td>node_9<td>node_9<td>3<tr><td>node_7<td>node_10<td>4<tr><td><strong>node_10</strong><td><strong>node_1</strong><td><strong>5</strong></table><p>The node <code>node_10</code> - <code>node_1</code> has already appeared in level 3 and, therefore, in my opinion - shouldn't be included in the results.<p>After some investigation, my best assumption is that the PostgreSQL algorithm, when it decides that the row is a cycle row - includes that row also into the results and then exists cycle.<p>And again, the only way to exclude this field that I've found is to use the MIN aggregate in the final query:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class=line><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">    t.id,</span></span>
<span class=line><span style="color: #E6E6E6">    t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">min</span><span style="color: #E6E6E6">(t.level) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">level</span></span>
<span class=line><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">    _result t</span></span>
<span class=line><span style="color: #569CD6">group by</span></span>
<span class=line><span style="color: #E6E6E6">    t.id, t.parent_id;</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class=line><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">    t.id,</span></span>
<span class=line><span style="color: #000000">    t.parent_id,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #795E26">min</span><span style="color: #000000">(t.level) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">level</span></span>
<span class=line><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">    _result t</span></span>
<span class=line><span style="color: #0000FF">group by</span></span>
<span class=line><span style="color: #000000">    t.id, t.parent_id;</span></span></code></pre></div><p>After this small tweak - the results from both functions <code>select_nodes_recursive_cte</code> (recursive CTE with CYCLE) and <code>select_nodes_recursive_function</code> (my optimized classic function recursion version) - are identical.<p>The next step is to do some serious performance testing.<p>However, I'm still not completely sure about this last node: Maybe it would be a better idea to leave <code>select_nodes_recursive_cte</code> as-is (without MIN aggregate) and to modify <code>select_nodes_recursive_function</code> to behave identically as CTE with CYCLE version. That means that before exiting recursion, we must include that last node.<p>So the final version <code>select_nodes_recursive_function</code> looks like this:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">or</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> select_nodes_recursive_function(</span></span>
<span class=line><span style="color: #E6E6E6">    _p_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[],</span></span>
<span class=line><span style="color: #E6E6E6">    _level </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">    id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class=line><span style="color: #E6E6E6">)</span></span>
<span class=line><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class=line><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">$$</span></span>
<span class=line><span style="color: #569CD6">declare</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">    _row record;</span></span>
<span class=line><span style="color: #E6E6E6">    _parents </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[];</span></span>
<span class=line><span style="color: #E6E6E6">    _id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[];</span></span>
<span class=line><span style="color: #569CD6">begin</span><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">exists</span><span style="color: #E6E6E6">(</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> information_schema.tables t</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> t.table_name </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'_result'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">and</span><span style="color: #E6E6E6"> table_type </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'LOCAL TEMPORARY'</span></span>
<span class=line><span style="color: #E6E6E6">    ) </span><span style="color: #569CD6">then</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> temp </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> _result (</span></span>
<span class=line><span style="color: #E6E6E6">            id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">            parent_id </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">,</span></span>
<span class=line><span style="color: #E6E6E6">            </span><span style="color: #569CD6">level</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">int</span></span>
<span class=line><span style="color: #E6E6E6">        ) </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">commit</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    _id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> array(</span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> unnest(_p_id) </span><span style="color: #569CD6">except</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">select distinct</span><span style="color: #E6E6E6"> t.id </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _result t);</span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6"> _id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">'{}'</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">then</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">insert</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _result</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">            t.id,</span></span>
<span class=line><span style="color: #E6E6E6">            t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">            _level</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">            big_tree_test t</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">            t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_p_id);</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">end</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">if</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">    </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">with</span><span style="color: #E6E6E6"> _insert_cte </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> (</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">insert</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _result</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">select</span></span>
<span class=line><span style="color: #E6E6E6">            t.id,</span></span>
<span class=line><span style="color: #E6E6E6">            t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">            _level</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">from</span></span>
<span class=line><span style="color: #E6E6E6">            big_tree_test t</span></span>
<span class=line><span style="color: #E6E6E6">        </span><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">            t.id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> any(_id)</span></span>
<span class=line><span style="color: #E6E6E6">        returning </span></span>
<span class=line><span style="color: #E6E6E6">            _result.parent_id</span></span>
<span class=line><span style="color: #E6E6E6">    ) </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> array_agg(</span><span style="color: #569CD6">distinct</span><span style="color: #E6E6E6"> p.parent_id)</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">into</span><span style="color: #E6E6E6"> _parents</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> _insert_cte p; </span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    perform select_nodes_recursive_function(_parents, _level </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">);</span></span>
<span class=line></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> query </span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        t.id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.parent_id,</span></span>
<span class=line><span style="color: #E6E6E6">        t.level</span></span>
<span class=line><span style="color: #E6E6E6">    </span><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class=line><span style="color: #E6E6E6">        _result t;</span></span>
<span class=line><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class=line><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">or</span><span style="color: #000000"> </span><span style="color: #795E26">replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> select_nodes_recursive_function(</span></span>
<span class=line><span style="color: #000000">    _p_id </span><span style="color: #0000FF">text</span><span style="color: #000000">[],</span></span>
<span class=line><span style="color: #000000">    _level </span><span style="color: #0000FF">int</span><span style="color: #000000"> = </span><span style="color: #098658">1</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">    id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class=line><span style="color: #000000">)</span></span>
<span class=line><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class=line><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">$$</span></span>
<span class=line><span style="color: #0000FF">declare</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">    _row record;</span></span>
<span class=line><span style="color: #000000">    _parents </span><span style="color: #0000FF">text</span><span style="color: #000000">[];</span></span>
<span class=line><span style="color: #000000">    _id </span><span style="color: #0000FF">text</span><span style="color: #000000">[];</span></span>
<span class=line><span style="color: #0000FF">begin</span><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #0000FF">exists</span><span style="color: #000000">(</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">from</span><span style="color: #000000"> information_schema.tables t</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> t.table_name = </span><span style="color: #A31515">'_result'</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> table_type = </span><span style="color: #A31515">'LOCAL TEMPORARY'</span></span>
<span class=line><span style="color: #000000">    ) </span><span style="color: #0000FF">then</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">create</span><span style="color: #000000"> temp </span><span style="color: #0000FF">table</span><span style="color: #000000"> _result (</span></span>
<span class=line><span style="color: #000000">            id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">            parent_id </span><span style="color: #0000FF">text</span><span style="color: #000000">,</span></span>
<span class=line><span style="color: #000000">            </span><span style="color: #0000FF">level</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span></span>
<span class=line><span style="color: #000000">        ) </span><span style="color: #0000FF">on</span><span style="color: #000000"> </span><span style="color: #0000FF">commit</span><span style="color: #000000"> </span><span style="color: #0000FF">drop</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    _id = array(</span><span style="color: #0000FF">select</span><span style="color: #000000"> unnest(_p_id) </span><span style="color: #0000FF">except</span><span style="color: #000000"> </span><span style="color: #0000FF">select distinct</span><span style="color: #000000"> t.id </span><span style="color: #0000FF">from</span><span style="color: #000000"> _result t);</span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> _id = </span><span style="color: #A31515">'{}'</span><span style="color: #000000"> </span><span style="color: #0000FF">then</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">insert</span><span style="color: #000000"> </span><span style="color: #0000FF">into</span><span style="color: #000000"> _result</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">            t.id,</span></span>
<span class=line><span style="color: #000000">            t.parent_id,</span></span>
<span class=line><span style="color: #000000">            _level</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">            big_tree_test t</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">            t.id = any(_p_id);</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">end</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">    </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">with</span><span style="color: #000000"> _insert_cte </span><span style="color: #0000FF">as</span><span style="color: #000000"> (</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">insert</span><span style="color: #000000"> </span><span style="color: #0000FF">into</span><span style="color: #000000"> _result</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">select</span></span>
<span class=line><span style="color: #000000">            t.id,</span></span>
<span class=line><span style="color: #000000">            t.parent_id,</span></span>
<span class=line><span style="color: #000000">            _level</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">from</span></span>
<span class=line><span style="color: #000000">            big_tree_test t</span></span>
<span class=line><span style="color: #000000">        </span><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">            t.id = any(_id)</span></span>
<span class=line><span style="color: #000000">        returning </span></span>
<span class=line><span style="color: #000000">            _result.parent_id</span></span>
<span class=line><span style="color: #000000">    ) </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> array_agg(</span><span style="color: #0000FF">distinct</span><span style="color: #000000"> p.parent_id)</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">into</span><span style="color: #000000"> _parents</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> _insert_cte p; </span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    perform select_nodes_recursive_function(_parents, _level + </span><span style="color: #098658">1</span><span style="color: #000000">);</span></span>
<span class=line></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> query </span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        t.id,</span></span>
<span class=line><span style="color: #000000">        t.parent_id,</span></span>
<span class=line><span style="color: #000000">        t.level</span></span>
<span class=line><span style="color: #000000">    </span><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class=line><span style="color: #000000">        _result t;</span></span>
<span class=line><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class=line><span style="color: #000000">$$;</span></span></code></pre></div><p>As we can see, before we exit the recursion with <code>return</code> - we insert the current nodes with the current level.<p>Both functions are returning identical results now, and we are finally ready for serious performance testing.<h2 id=performance-testing>Performance Testing</h2><table class="table table-sm table-hover table-bordered"style="width: initial;"><thead><tr><th align=right>round<th align=right>records <sup>1</sup><th align=right>unique nodes <sup>2</sup><th align=center><code>select_nodes_recursive_function</code><th align=center><code>select_nodes_recursive_cte</code><tbody class=table-group-divider><tr><td align=right>1<td align=right>13<td align=right>8<td align=center>00:00:00.058<td align=center>00:00:00.044<tr><td align=right>2<td align=right>13<td align=right>8<td align=center>00:00:00.060<td align=center>00:00:00.037<tr><td align=right>3<td align=right>13<td align=right>8<td align=center>00:00:00.053<td align=center>00:00:00.060<tr><td align=right>1<td align=right>45<td align=right>20<td align=center>00:00:00.055<td align=center>00:00:00.051<tr><td align=right>2<td align=right>45<td align=right>20<td align=center>00:00:00.056<td align=center>00:00:00.054<tr><td align=right>3<td align=right>45<td align=right>20<td align=center>00:00:00.053<td align=center>00:00:00.071<tr><td align=right>1<td align=right>90<td align=right>30<td align=center>00:00:00.065<td align=center>00:00:24.986<tr><td align=right>2<td align=right>90<td align=right>30<td align=center>00:00:00.048<td align=center>00:00:19.298<tr><td align=right>3<td align=right>90<td align=right>30<td align=center>00:00:00.060<td align=center>00:00:21.342<tr><td align=right>1<td align=right>128<td align=right>30<td align=center>00:00:00.092<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>2<td align=right>128<td align=right>30<td align=center>00:00:00.041<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>3<td align=right>128<td align=right>30<td align=center>00:00:00.058<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>1<td align=right>291<td align=right>99<td align=center>00:00:00.089<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>2<td align=right>291<td align=right>99<td align=center>00:00:00.063<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>3<td align=right>291<td align=right>99<td align=center>00:00:00.049<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>1<td align=right>1723<td align=right>148<td align=center>00:00:00.100<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>2<td align=right>1723<td align=right>148<td align=center>00:00:00.050<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>3<td align=right>1723<td align=right>148<td align=center>00:00:00.054<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>1<td align=right>6638<td align=right>499<td align=center>00:00:00.092<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>2<td align=right>6638<td align=right>499<td align=center>00:00:00.069<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>3<td align=right>6638<td align=right>499<td align=center>00:00:00.078<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>1<td align=right>24803<td align=right>999<td align=center>00:00:00.120<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>2<td align=right>24803<td align=right>999<td align=center>00:00:00.128<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>3<td align=right>24803<td align=right>999<td align=center>00:00:00.128<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>1<td align=right>126804<td align=right>5000<td align=center>00:00:00.785<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>2<td align=right>126804<td align=right>5000<td align=center>00:00:00.751<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>3<td align=right>126804<td align=right>5000<td align=center>00:00:00.778<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>1<td align=right>1301479<td align=right>99999<td align=center>00:00:07.665<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>2<td align=right>1301479<td align=right>99999<td align=center>00:00:07.743<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>3<td align=right>1301479<td align=right>99999<td align=center>00:00:08.729<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>1<td align=right>2510281<td align=right>49998<td align=center>00:00:12.596<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>2<td align=right>2510281<td align=right>49998<td align=center>00:00:13.621<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>3<td align=right>2510281<td align=right>49998<td align=center>00:00:14.128<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>1<td align=right>5050378<td align=right>100000<td align=center>00:00:37.156<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>2<td align=right>5050378<td align=right>100000<td align=center>00:00:39.230<td align=center><code>ERROR</code> <sup>3</sup><tr><td align=right>3<td align=right>5050378<td align=right>100000<td align=center>00:00:40.284<td align=center><code>ERROR</code> <sup>3</sup></table><ul><li><strong>1</strong> - <strong>records</strong> is the number of total records in <code>big_tree_test</code> table. That is the number of tree connections.<li><strong>2</strong> - <strong>unique nodes</strong> is the number of unique id values (nodes) in <code>big_tree_test</code> table. That is the number of unique tree nodes.<li><strong>3</strong> - Execution ends up in an error. Approximately after a minute and a half of execution, it breaks with: <code>ERROR: could not write to file "base/pgsql_tmp/pgsql_tmp226.8386": No space left on device</code>. I have 400GB free on my laptop. In later tests, when I ran this function on a larger, the connection was being reset. So, something very strange is going on with recursive CTE execution.</ul><p>Optimized function <code>select_nodes_recursive_function</code> starts to seriously degrade in performance just after a couple of million tree connections and after a million unique tree nodes.<p>For the last performance tests, I tried to create an index on the tree table:<div class="code sql"><div class=toolbar><div class="copy-code bi-clipboard"data-bs-toggle=tooltip data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera"data-bs-toggle=tooltip data-bs-title="Copy code image to clipboard"></div></div><pre class=shiki style="background-color: #222222"><code class=code-highlight><span class=line><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">index</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">on</span><span style="color: #E6E6E6"> big_tree_test </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6"> btree (id);</span></span>
<span class=line><span style="color: #E6E6E6">reindex </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> big_tree_test;</span></span></code></pre><pre class=shiki style="background-color: #FFFFFF"><code class=code-highlight><span class=line><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">index</span><span style="color: #000000"> </span><span style="color: #0000FF">on</span><span style="color: #000000"> big_tree_test </span><span style="color: #0000FF">using</span><span style="color: #000000"> btree (id);</span></span>
<span class=line><span style="color: #000000">reindex </span><span style="color: #0000FF">table</span><span style="color: #000000"> big_tree_test;</span></span></code></pre></div><p>Results are approximately the same:<ol><li>00:00:33.184<li>00:00:37.163<li>00:00:36.106</ol><p>Most likely, indexes were never used.<p>Perhaps someone has a better idea?<h2 id=conclusion>Conclusion</h2><p>Makeup what you will, it is what it is.<p>I still hold the position that recursive CTE queries are confusing, at least to me.<p>Anyhow, if someone is using them and starts to experience performance issues, maybe there is a better way?<p>This approach I demonstrated in this series may be the solution for processing a huge number of tree nodes.<p>Or maybe not.<p>Anyhow, I said last time that I'd focus on testing and debugging these functions now, I guess it will have to wait for another article in this series.<h2 id=update-1>UPDATE 1</h2><p>I was suggested to use UNION ALL instead of just UNION in the CTE version. Unfortunately, no difference. On a small dataset, it will return identical results, it will be slow on a medium dataset, and it will crash on a big dataset.<p>I still don't know what to think of it.<p>Either the PostgreSQL CTE implementation is bad or ... I really don't know.<p>Next, I'll try to play around with that CTE version execution plan to try to figure it out.<h2 id=update-2>UPDATE 2</h2><p>Here is the execution plan for the CTE version (with UNION ALL, which should be better because it doesn't look for duplicates):<pre><code>CTE Scan on _recursive_cte r  (cost=73.68..86.58 rows=322 width=68) (actual time=0.014..81982.777 rows=7341736 loops=1)
  Filter: (NOT is_cycle)
  Rows Removed by Filter: 11291893
  CTE _recursive_cte
    ->  Recursive Union  (cost=0.00..73.68 rows=645 width=76) (actual time=0.012..65812.549 rows=18633629 loops=1)
          ->  Seq Scan on big_tree_test  (cost=0.00..2.59 rows=5 width=51) (actual time=0.011..0.019 rows=5 loops=1)
                Filter: (id = 'node_1'::text)
                Rows Removed by Filter: 122
          ->  Hash Join  (cost=1.31..5.82 rows=64 width=76) (actual time=216.675..1395.792 rows=503611 loops=37)
                Hash Cond: (t.id = rec.parent_id)
                ->  Seq Scan on big_tree_test t  (cost=0.00..2.27 rows=127 width=14) (actual time=0.009..0.031 rows=127 loops=36)
                ->  Hash  (cost=1.00..1.00 rows=25 width=68) (actual time=216.606..216.606 rows=198425 loops=37)
                      Buckets: 32768 (originally 1024)  Batches: 128 (originally 1)  Memory Usage: 117836kB
                      ->  WorkTable Scan on _recursive_cte rec  (cost=0.00..1.00 rows=25 width=68) (actual time=0.044..104.818 rows=198425 loops=37)
                            Filter: (NOT is_cycle)
                            Rows Removed by Filter: 305186
Planning Time: 0.206 ms
Execution Time: 83266.186 ms
</code></pre><p>This <code>-> Recursive Union (cost=0.00..73.68 rows=645 width=76) (actual time=0.012..65812.549 rows=18633629 loops=1)</code>, this has some crazy number of rows and execution time.<p>The <code>big_tree_test</code> has only 127 records with 49 unique id's.<p>I'm baffled.<div class="my-5 px-5 border-top links svelte-g8mw6f"><div><div class="link-title text-start svelte-g8mw6f">PREVIOUS</div><a class="btn btn-link text-start"href=/blog/recursion-postgresql/part2-performances>Part 2 - Performances</a></div><div><div class="link-title text-end svelte-g8mw6f">NEXT</div><a class="btn btn-link text-end"href=/blog/recursion-postgresql/part4-right-path>Part 4 - Finding the Right Path</a></div></div></div></div><div class="rightside svelte-2kl70j"><div class=svelte-2kl70j><ul class="navbar-nav sidenav svelte-2kl70j"><li class="nav-txt-divider text-muted svelte-2kl70j"><hr class=svelte-2kl70j><span class=svelte-2kl70j>on this page</span><hr class=svelte-2kl70j><li class="nav-item toc1 right svelte-2kl70j bookmark-nav"data-id=recursion-with-postgresql-part-3---cycle-detection title="Recursion with PostgreSQL Part 3 - Cycle Detection"><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#recursion-with-postgresql-part-3---cycle-detection>Recursion with PostgreSQL Part 3 - Cycle Detection</a><li class="nav-item toc2 right svelte-2kl70j bookmark-nav"data-id=new-problem title="New Problem"><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#new-problem>New Problem</a><li class="nav-item toc2 right svelte-2kl70j bookmark-nav"data-id=performance-testing title="Performance Testing"><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#performance-testing>Performance Testing</a><li class="nav-item toc2 right svelte-2kl70j bookmark-nav"data-id=conclusion title=Conclusion><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#conclusion>Conclusion</a><li class="nav-item toc2 right svelte-2kl70j bookmark-nav"data-id=update-1 title="UPDATE 1"><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#update-1>UPDATE 1</a><li class="nav-item toc2 right svelte-2kl70j bookmark-nav"data-id=update-2 title="UPDATE 2"><a class="nav-link auto-close svelte-2kl70j bookmark-link"href=#update-2>UPDATE 2</a><li><hr class=svelte-2kl70j><div class="navbar-nav sidenav"><div class="text-muted fs-_7rem mx-2">PREVIOUS</div><a class="btn btn-link btn-sm text-start"href=/blog/recursion-postgresql/part2-performances>Part 2 - Performances</a></div><div class="navbar-nav sidenav mt-3"><div class="text-muted fs-_7rem mx-2">NEXT</div><a class="btn btn-link btn-sm text-start"href=/blog/recursion-postgresql/part4-right-path>Part 4 - Finding the Right Path</a></div></ul></div></div></main><script>!function(){var i=document.querySelector("nav.navbar"),f=document.getElementsByTagName("main")[0],L=f.getElementsByClassName("sidebar")[0],w=f.getElementsByClassName("content")[0],a=document.querySelectorAll("div.code");function k(e,t){for(var n=2;n<arguments.length;n++)e.classList.remove(arguments[n]);e.classList.add(t)}function t(e,t){var n=e.currentTarget;if(!n.classList.contains("bi-check")){for(var i="",a=0;a<n.classList.length;a++)if(n.classList[a].startsWith("bi-")){i=n.classList[a];break}n.classList.remove(i),n.classList.add("spinner-border-sm"),n.classList.add("spinner-border");e=bootstrap.Tooltip.getInstance(n);e&&(e.setContent({".tooltip-inner":"Copying..."}),e.show()),t(n,function(){var e;n.classList.remove(i),n.classList.remove("spinner-border-sm"),n.classList.remove("spinner-border"),n.classList.add("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&(e.setContent({".tooltip-inner":"Copied!"}),e.show()),setTimeout(function(){var e;n.classList.add(i),n.classList.remove("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&e.setContent({".tooltip-inner":n.dataset.bsTitle})},2e3)})}}var e=document.querySelector(".post-share > .copy-url"),n=(e&&e.addEventListener("click",function(e){t(e,function(e,t){navigator.clipboard.writeText(document.location.origin+document.location.pathname),t()})}),document.getElementsByTagName("html")[0]),s=i.querySelector("#theme-btn"),o="theme";function r(e){var t=s.getElementsByTagName("svg");"dark"===e?(t[0].style.display="",t[1].style.display="none",s.getElementsByClassName("check")[0].classList.add("checked")):(t[0].style.display="none",t[1].style.display="",s.getElementsByClassName("check")[0].classList.remove("checked"));for(var n=0;n<a.length;n++){var i=a[n];"dark"===e?(i.children[1].style.display="inherit",i.children[2].style.display="none"):"light"===e&&(i.children[1].style.display="none",i.children[2].style.display="inherit")}window._theme&&window._theme(e)}function l(e){t(e,function(e,t){navigator.clipboard.writeText(e.parentElement.nextSibling.innerText),t()})}function c(e){t(e,function(e,t){var n=localStorage.getItem(o);e="dark"===n?e.parentElement.parentElement.children[1]:e.parentElement.parentElement.children[2],setTimeout(function(){html2canvas(e).then(e=>{e.toBlob(e=>navigator.clipboard.write([new ClipboardItem({"image/png":e})])),t()})},0)})}s.addEventListener("click",()=>{var e="dark"===localStorage.getItem(o)?"light":"dark";localStorage.setItem(o,e),r(n.dataset.bsTheme=e)}),r(localStorage.getItem(o)),s.children[0].classList.remove("hidden");for(var d=0;d<a.length;d++)a[d].getElementsByClassName("copy-code")[0].addEventListener("click",l),a[d].getElementsByClassName("photo-code")[0].addEventListener("click",c);for(var E=function(){var s,a,o;if(f.children[2]&&"none"!=f.children[2].style.display)return s=f.children[1].children[0].querySelectorAll("[id]"),a=void 0,this.initNavs=function(e){o=e.querySelectorAll("li.bookmark-nav");for(var t=0;t<s.length;t++){for(var n=s[t].id,i=null,a=0;a<o.length;a++)if(o[a].dataset.id==n){i=o[a];break}s[t].nav=i}setTimeout(function(){for(var e=0;e<s.length;e++){var t=s[e];if(r(t).visible&&t.nav)return void t.nav.classList.add("active")}},1e3),l()},f.children[1].addEventListener("scroll",l),this;function r(e){var e=e.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight),n=0<e.top&&!(e.bottom<0||0<=e.top-t)||e.top<0&&e.bottom>t,i=!1;return{visible:n,above:i=n?i:e.bottom<t}}function l(){if(o&&o.length){for(var e=0;e<o.length;e++)o[e].classList.remove("active");for(var t=void 0,e=0;e<s.length;e++){const i=s[e];var n=r(i);if(!n.visible&&n.above&&(t=i.nav),n.visible&&i.nav&&!i.nav.classList.contains("active"))return i.nav.classList.add("active"),a&&clearTimeout(a),void(a=setTimeout(function(){i.nav.scrollIntoView({behavior:"smooth"}),a=void 0},250))}t&&!t.classList.contains("active")&&(t.classList.add("active"),a&&clearTimeout(a),a=setTimeout(function(){t.scrollIntoView({behavior:"smooth"}),a=void 0},250))}}}(),h=function(){var r,l=i.querySelector("#nav-btn"),c=480,d="200px",h="0.25fr",m=730,v=535,u=f.children[0].children[0].children[0],g=f.children[2]&&f.children[2].children[0].children[0],e="sidebar-pinned",p=null==localStorage.getItem(e)||"true"==localStorage.getItem(e),b=!1,y=!1;function t(){window._onresize&&window._onresize();var e=window.outerWidth||window.innerWidth,t=e<c,n=t?b?"100%":"0":p?""+d:"0",i=`grid-template-columns: ${n} 1fr`,a=t&&b?"width: 100%":"0"!=n?"":"display: none",s=t&&b?"display: none":"",o=t?b?"sidebar-show":"sidebar-hide":p?"sidebar-show":"sidebar-hide",n="0"==n;f.children[2]&&(h&&m&&v&&(n&&e<v||!n&&e<m?y||(u.innerHTML=r+g.innerHTML,E.initNavs(u),y=!0):y&&(u.innerHTML=r,E.initNavs(g),y=!1)),!h||t||y?(i+=";",f.children[2].style.display="none"):(i+=` ${h};`,f.children[2].style.display="")),k(l,!t&&p||t&&b?"rotate":"rotate-back","rotate","rotate-back"),p?l.classList.add("text-shadow"):l.classList.remove("text-shadow"),f.style=L?i:"display: grid;",L&&k(L,o,"sidebar-show","sidebar-hide"),L&&(L.firstChild.style=a),w.style=s}function n(){window.outerWidth<c?b=!b:p=!p,localStorage.setItem(e,p.toString()),t(),p?l.classList.add("text-shadow"):l.classList.remove("text-shadow")}return h&&m&&v&&g&&(r=u.innerHTML,E.initNavs(g)),l.addEventListener("click",n),(window.onresize=t)(),this.closeSidebar=function(){window.outerWidth<c&&b&&n()},this}(),m=document.getElementsByClassName("auto-close"),v=0;v<m.length;v++)m[v].addEventListener("click",function(e){h.closeSidebar()});location.hash&&(e=document.getElementById(location.hash.replace("#","")))&&e.scrollIntoView()}();</script><script src=/bootstrap.bundle.min.js></script><script>!function(){for(var t=document.querySelectorAll('[data-bs-toggle="tooltip"]'),e=0;e<t.length;e++)new bootstrap.Tooltip(t[e]);var o=document.getElementsByClassName("accordion-item");if(o.length)for(e=0;e<o.length;e++){var l=o[e];l.querySelectorAll("[href='"+document.location.pathname+"']").length&&l.firstChild.click()}}();</script><script src=/html2canvas.min.js></script><script async defer src=https://buttons.github.io/buttons.js></script><script async data-id=101435862 src=//static.getclicky.com/js></script>