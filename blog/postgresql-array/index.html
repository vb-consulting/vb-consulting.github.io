<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PostgreSQL Arrays üêò</title><meta name="description" content="PostgreSQL Array Example"><link href="https://vb-consulting.github.io/blog/postgresql-array/" rel="canonical"><meta name="keywords" content="postgresql, programming, arrays"><meta name="author" content="floki"><meta prefix="og: http://ogp.me/ns#" property="og:title" content="PostgreSQL Arrays üêò"><meta prefix="og: http://ogp.me/ns#" property="og:description" content="PostgreSQL Array Example"><meta prefix="og: http://ogp.me/ns#" property="og:image" content="https://vb-consulting.github.io/eleph2.jpg"><meta prefix="og: http://ogp.me/ns#" property="og:type" content="article"><meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="VB-Consulting"><meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://vb-consulting.github.io/blog/postgresql-array/"><meta name="twitter:image" content="https://vb-consulting.github.io/eleph2.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:description" content="PostgreSQL Array Example"><link rel="stylesheet" href="/_elderjs/assets/svelte-d5812efd.css" media="all"><style></style><link href="/style.css?1714816204671" rel="stylesheet"><script>!function(){var e="theme",t=localStorage.getItem(e);t||(t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",localStorage.setItem(e,t)),document.getElementsByTagName("html")[0].dataset.bsTheme=t}();</script></head><body class="d-flex flex-column h-100"><header id="header"><nav class="navbar navbar-expand-md navbar-dark fixed-top py-0 py-md-0 svelte-30jr7w"><div class="container-fluid flex-nowrap svelte-30jr7w"><div class="d-flex svelte-30jr7w"><button id="nav-btn" type="button" class="d-flex btn btn-sm logo animate-rotate svelte-30jr7w"><i class="material-icons-outlined">menu</i></button> <a class="nav-link my-auto ms-2 fw-semibold home svelte-30jr7w" href="/"><i class="bi-chevron-double-left"></i> VB Home</a></div><div class="d-flex right svelte-30jr7w"><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Become a Patreon" href="https://www.patreon.com/vbconsulting" target="_blank"><div class="patreon"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="Buy Me a Coffee" href="https://www.buymeacoffee.com/vbilopavu" target="_blank"><div class="bmc"></div></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><a class="nav-link my-auto me-2 svelte-30jr7w" data-bs-toggle="tooltip" data-bs-html="true" title="vb-consulting on GitHub" href="https://github.com/vb-consulting/"><i class="bi-github"></i></a> <a class="github-button svelte-30jr7w" href="https://github.com/vb-consulting/" data-bs-toggle="tooltip" data-bs-html="true" title="Star vb-consulting on GitHub" data-color-scheme="no-preference: light_high_contrast; light: light_high_contrast; dark: light_high_contrast;" data-icon="octicon-star" data-show-count="true" aria-label="Star vb-consulting on GitHub"></a><div class="vr1 text-muted my-auto svelte-30jr7w"></div><button id="theme-btn" type="button" aria-pressed="true" aria-label="theme" class="svelte-30jr7w"><span class="check hidden svelte-30jr7w"><span class="icon svelte-30jr7w"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><path fill="currentColor" d="M12 21q-3.775 0-6.388-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.625-.075.975.45t-.025 1.1q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.525-.35 1.075-.037t.475.987q-.35 3.45-2.937 5.725T12 21Zm0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19Zm-.25-6.75Z"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="svelte-30jr7w"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M0 0h24v24H0z"></path><path fill="currentColor" d="M12 19a1 1 0 0 1 .993.883L13 20v1a1 1 0 0 1-1.993.117L11 21v-1a1 1 0 0 1 1-1zm6.313-2.09l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7a1 1 0 0 1 1.218-1.567l.102.07zm-11.306.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM4 11a1 1 0 0 1 .117 1.993L4 13H3a1 1 0 0 1-.117-1.993L3 11h1zm17 0a1 1 0 0 1 .117 1.993L21 13h-1a1 1 0 0 1-.117-1.993L20 11h1zM6.213 4.81l.094.083l.7.7a1 1 0 0 1-1.32 1.497l-.094-.083l-.7-.7A1 1 0 0 1 6.11 4.74l.102.07zm12.894.083a1 1 0 0 1 .083 1.32l-.083.094l-.7.7a1 1 0 0 1-1.497-1.32l.083-.094l.7-.7a1 1 0 0 1 1.414 0zM12 2a1 1 0 0 1 .993.883L13 3v1a1 1 0 0 1-1.993.117L11 4V3a1 1 0 0 1 1-1zm0 5a5 5 0 1 1-4.995 5.217L7 12l.005-.217A5 5 0 0 1 12 7z"></path></g></svg></span></span></button></div></div></nav></header><main class="svelte-9zwk14"><div class="sidebar sidebar-hide svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-item svelte-9zwk14" data-id="" title="VB-Consulting"><a class="nav-link svelte-9zwk14 text-uppercase" href="/">VB-Consulting</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="NpgsqlRest"><a class="nav-link svelte-9zwk14 text-uppercase" href="/npgsqlrest/">NpgsqlRest</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="Norm.Net"><a class="nav-link svelte-9zwk14 text-uppercase" href="/norm.net/">Norm.Net</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="RazorSvelte"><a class="nav-link svelte-9zwk14 text-uppercase" href="/razorsvelte/">RazorSvelte</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PgRoutiner"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pgroutiner/">PgRoutiner</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="XUnit.Npgsql"><a class="nav-link svelte-9zwk14 text-uppercase" href="/xunit.npgsql/">XUnit.Npgsql</a></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="PostrgeSQL Schema Tools"><a class="nav-link svelte-9zwk14 text-uppercase" href="/pg_schema_tools/">PostrgeSQL Schema Tools</a></li><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">blogs</span><hr class="svelte-9zwk14"></li><li class="nav-item toc2 svelte-9zwk14" data-id="" title="See all blogs..."><a class="nav-link btn btn-sm w-fit px-3 mx-auto svelte-9zwk14 lr-arrow text-uppercase" href="/blogs/"><i class="bi bi-arrow-right-circle svelte-9zwk14"></i> <span class="btn-link">ALL BLOGS</span></a></li><li class="nav-item svelte-9zwk14" data-id="" title="Transaction Script DDD vs SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/transaction-script/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Transaction Script DDD vs SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Common Sense Software Design Approach for RDBMS-backed Type of Software"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/common-sense-design/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Common Sense Software Design</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-v2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest v2 Update üêòüî•</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest-update1.6.2/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest Update 1.6.2</a></li><li class="nav-item svelte-9zwk14 active" data-id="" title="PostgreSQL Array Example"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-array/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Arrays üêò</a></li><li class="nav-item svelte-9zwk14" data-id="" title="How DDD is screwing up your SQL"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/sql-vs-ddd/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>How DDD is screwing up your SQL</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL Paging Benchmarks"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-paging/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>PostgreSQL Paging Benchmarks</a></li><li class="nav-item svelte-9zwk14" data-id="" title="Automatic REST API for PostgreSQL Database as .NET8 Middleware"><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/npgsqlrest/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>NpgsqlRest NuGet Library</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL crazy experiment with the record type."><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-record-type/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Execute Custom Function For Each Record</a></li><li class="nav-item svelte-9zwk14" data-id="" title="PostgreSQL script that implements temporal tables without extension."><a class="nav-link svelte-9zwk14 lr-arrow text-uppercase" href="/blog/postgresql-temporal-tables/"><i class="bi bi-chat-left-text svelte-9zwk14"></i>Custom Temporal Tables in PostgreSQL</a></li></ul></div></div><div class="content svelte-9zwk14"><div class="banner svelte-1bxfgrx" style="background-image: url(/eleph2.jpg); background-position: center; background-blend-mode: difference;"></div><div class="container-sm main-content blog svelte-1bxfgrx bannered"><div class="blog-head svelte-1bxfgrx"><a href="https://github.com/vb-consulting/blog/blob/master/LICENSE" class="text-shadow svelte-1bxfgrx" style="color: white">CC0-1.0 license</a></div><div class="categories svelte-1bxfgrx"><a href="/blogs/general" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># general</span> </a><a href="/blogs/software-development" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># software development</span> </a><a href="/blogs/postgresql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># postgresql</span> </a><a href="/blogs/sql" class="btn btn-sm text-shadow svelte-1bxfgrx"><span class="cat"># sql</span></a></div><h1 class="text-shadow" id="postgresql-arrays-">PostgreSQL Arrays üêò</h1><div class="post-meta text-shadow"><div></div><div class="post-details"><div class="post-pic" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog." style="background-image: url(/floki2.jpg)"></div><div class="post-details-right"><div class="post-share"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Fpostgresql-array%2F" class="me-1 bi-linkedin" data-bs-toggle="tooltip" data-bs-html="true" title="Share on LinkedIn"><i class=""></i></a> <a href="http://twitter.com/share?text=PostgreSQL%20Arrays%20%F0%9F%90%98%0APostgreSQL%20Array%20Example%0A&url=https%3A%2F%2Fvb-consulting.github.io%2Fblog%2Fpostgresql-array%2F&hashtags=software%20development%2Cpostgresql%2Csql" class="me-1 bi-twitter-x" data-bs-toggle="tooltip" data-bs-html="true" title="Share on X"><i class=""></i></a> <a href="#" class="copy-url bi-clipboard" data-bs-toggle="tooltip" data-bs-html="true" title="Copy URL"><i class=""></i></a></div><div class="post-author">floki</div><div class="post-date">May 4, 2024</div></div></div></div><h2 id="many-to-many">Many-To-Many</h2><p>Traditionally in relational databases, many-to-many data design is implemented using three tables.</p><p>Classic examples are users and roles: One user can be in many roles and one role can be on many users. For example, most developers are familiar with something like this (or, a variation of this approach):</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">users</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">generated</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">always</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">identity</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">unique</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">roles</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    role_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">generated</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">always</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">identity</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">unique</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">users_roles</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> users,</span></span>
<span class="line"><span style="color: #E6E6E6">    role_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> roles,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6"> (user_id, role_id)</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">users</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    user_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000"> </span><span style="color: #0000FF">generated</span><span style="color: #000000"> </span><span style="color: #0000FF">always</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">identity</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">unique</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">roles</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    role_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000"> </span><span style="color: #0000FF">generated</span><span style="color: #000000"> </span><span style="color: #0000FF">always</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">identity</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">unique</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">users_roles</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    user_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">references</span><span style="color: #000000"> users,</span></span>
<span class="line"><span style="color: #000000">    role_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">references</span><span style="color: #000000"> roles,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">primary key</span><span style="color: #000000"> (user_id, role_id)</span></span>
<span class="line"><span style="color: #000000">);</span></span></code></pre></div><h2 id="postgresql-way">PostgreSQL Way</h2><p>PostgreSQL is a different and unique database because it offers a vast range of data types, that other databases lack.</p><p>One of those types is the array type. In the example above, we are completely certain that our system will never have more than a few roles. In that case, we can use the array type safely.</p><p>Not only that PostgreSQL have array types - but it has also implemented <a href="https://www.postgresql.org/docs/current/functions-array.html">mathematical operators</a> over arrays. And, not only that, you can also ensure data integrity with the <code>CHECK</code> constraints.</p><p>So, the classic example from above can be vastly simplified in one, single table:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">users</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">generated</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">always</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">identity</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">unique</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    roles </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[] </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">constraint</span><span style="color: #E6E6E6"> roles_check </span><span style="color: #569CD6">check</span><span style="color: #E6E6E6"> (roles </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">@ </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">['admin', 'user', 'guest'])</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">users</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    user_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000"> </span><span style="color: #0000FF">generated</span><span style="color: #000000"> </span><span style="color: #0000FF">always</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">identity</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">unique</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    roles </span><span style="color: #0000FF">text</span><span style="color: #000000">[] </span><span style="color: #0000FF">not null</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">constraint</span><span style="color: #000000"> roles_check </span><span style="color: #0000FF">check</span><span style="color: #000000"> (roles &lt;@ </span><span style="color: #0000FF">array</span><span style="color: #000000">['admin', 'user', 'guest'])</span></span>
<span class="line"><span style="color: #000000">);</span></span></code></pre></div><p>The constraint <code>roles_check check (roles &lt;@ array['admin', 'user', 'guest'])</code> uses <code>&lt;@</code> array operator to ensure that every insert and update can only have array values that exist on the right side array <code>['admin', 'user', 'guest']</code>.</p><p>From the <a href="https://www.postgresql.org/docs/current/functions-array.html">official documentation</a>:</p><blockquote><p><code>anyarray &lt;@ anyarray ‚Üí boolean</code></p><p>Is the first array contained by the second?</p><p><code>ARRAY[2,2,7] &lt;@ ARRAY[1,7,4,2,6] ‚Üí t</code></p></blockquote><p>Meaning, each element in the first array has to exist in the second.</p><p>If we try to do this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> users (</span><span style="color: #569CD6">name</span><span style="color: #E6E6E6">, roles) </span></span>
<span class="line"><span style="color: #569CD6">values</span><span style="color: #E6E6E6"> (</span><span style="color: #CE9178">'user1'</span><span style="color: #E6E6E6">, </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">['admin', 'user']);</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">insert into</span><span style="color: #000000"> users (</span><span style="color: #0000FF">name</span><span style="color: #000000">, roles) </span></span>
<span class="line"><span style="color: #0000FF">values</span><span style="color: #000000"> (</span><span style="color: #A31515">'user1'</span><span style="color: #000000">, </span><span style="color: #0000FF">array</span><span style="color: #000000">['admin', 'user']);</span></span></code></pre></div><p>It will insert the new record successfully. The same goes for the update.</p><p>However, if we try this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">insert into</span><span style="color: #E6E6E6"> users (</span><span style="color: #569CD6">name</span><span style="color: #E6E6E6">, roles) </span></span>
<span class="line"><span style="color: #569CD6">values</span><span style="color: #E6E6E6"> (</span><span style="color: #CE9178">'user2'</span><span style="color: #E6E6E6">, </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">['super', 'admin']);</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">insert into</span><span style="color: #000000"> users (</span><span style="color: #0000FF">name</span><span style="color: #000000">, roles) </span></span>
<span class="line"><span style="color: #0000FF">values</span><span style="color: #000000"> (</span><span style="color: #A31515">'user2'</span><span style="color: #000000">, </span><span style="color: #0000FF">array</span><span style="color: #000000">['super', 'admin']);</span></span></code></pre></div><p>It will end up with the following error: <code>ERROR: new row for relation "users" violates check constraint "roles_check"</code>. The same goes for the update.</p><p>Our data integrity is now protected.</p><h2 id="changing-the-rules">Changing The Rules</h2><p>Requirements change, and naturally, we would like to change our list of valid roles. We can do that with the simple script:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">begin</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> users </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">constraint</span><span style="color: #E6E6E6"> roles_check;</span></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> users </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">constraint</span><span style="color: #E6E6E6"> roles_check </span><span style="color: #569CD6">check</span><span style="color: #E6E6E6"> (roles </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">@ </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">['super', 'admin', 'user']); </span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">begin</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> users </span><span style="color: #0000FF">drop</span><span style="color: #000000"> </span><span style="color: #0000FF">constraint</span><span style="color: #000000"> roles_check;</span></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> users </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">constraint</span><span style="color: #000000"> roles_check </span><span style="color: #0000FF">check</span><span style="color: #000000"> (roles &lt;@ </span><span style="color: #0000FF">array</span><span style="color: #000000">['super', 'admin', 'user']); </span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span></code></pre></div><p>This script will recreate the <code>roles_check</code> constraint to allow only these roles: <code>['super', 'admin', 'user']</code>.</p><p>However, there are two problems with this approach:</p><ol><li>We already have records that have the <code>guest</code> role. That role is not allowed by the new definition. The script will fail with the following error message: <code>ERROR: check constraint "roles_check" of relation "users" is violated by some row</code>.</li><li>If the table <code>users</code> is too big, this script may take a long time to run. PostgreSQL needs to check every record for integrity (which may be too long for big tables), and while doing so, all reads and writes are blocked.</li></ol><p>To address this issue, a new constraint can be created using the <code>not valid</code> directive:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">begin</span><span style="color: #E6E6E6">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> users </span><span style="color: #569CD6">drop</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">constraint</span><span style="color: #E6E6E6"> roles_check;</span></span>
<span class="line"><span style="color: #569CD6">alter</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> users </span><span style="color: #569CD6">add</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">constraint</span><span style="color: #E6E6E6"> roles_check </span><span style="color: #569CD6">check</span><span style="color: #E6E6E6"> (roles </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">@ </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">['super', 'admin', 'user']) </span><span style="color: #569CD6">not</span><span style="color: #E6E6E6"> valid; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">begin</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> users </span><span style="color: #0000FF">drop</span><span style="color: #000000"> </span><span style="color: #0000FF">constraint</span><span style="color: #000000"> roles_check;</span></span>
<span class="line"><span style="color: #0000FF">alter</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> users </span><span style="color: #0000FF">add</span><span style="color: #000000"> </span><span style="color: #0000FF">constraint</span><span style="color: #000000"> roles_check </span><span style="color: #0000FF">check</span><span style="color: #000000"> (roles &lt;@ </span><span style="color: #0000FF">array</span><span style="color: #000000">['super', 'admin', 'user']) </span><span style="color: #0000FF">not</span><span style="color: #000000"> valid; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span></code></pre></div><p>From the <a href="https://www.postgresql.org/docs/current/sql-altertable.html">documentation</a>:</p><blockquote><p>Normally, this form will cause a scan of the table to verify that all existing rows in the table satisfy the new constraint. But if the NOT VALID option is used, this potentially-lengthy scan is skipped.</p></blockquote><p>In practice this means the following:</p><ul><li>Records with invalid role <code>guest</code> will remain intact. That small deviation from the data integrity can be safely ignored (if business rules permit).</li><li>All new inserts and updates will enforce new data integrity rules - roles must exist in a new array: <code>['super', 'admin', 'user']</code>.</li><li>The script that updates the new <code>check</code> constraint will run fast, even on big tables and it will not lock or block anyone or anything.</li></ul><h2 id="advanced-scenarios">Advanced Scenarios</h2><p>The <code>check</code> constraint is neat, but it gets pretty messy if we have some complicated business logic.</p><p>In that case, we can use the PostgreSQL functions for validation. We can write a function that receives an entire record for validation and returns true or false.</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">roles_check_func</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _record record</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">boolean</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">begin</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">-- Some complicated logic here, branching, loops, and all, this is just an example.</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> _record.roles </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">@ </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">['admin', 'user', 'guest'];</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">roles_check_func</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _record record</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">boolean</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">begin</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">-- Some complicated logic here, branching, loops, and all, this is just an example.</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> _record.roles &lt;@ </span><span style="color: #0000FF">array</span><span style="color: #000000">['admin', 'user', 'guest'];</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>Note that only <code>plpgsql</code> functions can use <code>record</code> types.</p><p>Now, we can use this function in the <code>check</code> constraint:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">users</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">generated</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">always</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">identity</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">unique</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    roles </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6">[] </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">constraint</span><span style="color: #E6E6E6"> roles_check </span><span style="color: #569CD6">check</span><span style="color: #E6E6E6"> (roles_check_func(users))</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">users</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    user_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000"> </span><span style="color: #0000FF">generated</span><span style="color: #000000"> </span><span style="color: #0000FF">always</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">identity</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">unique</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    roles </span><span style="color: #0000FF">text</span><span style="color: #000000">[] </span><span style="color: #0000FF">not null</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">constraint</span><span style="color: #000000"> roles_check </span><span style="color: #0000FF">check</span><span style="color: #000000"> (roles_check_func(users))</span></span>
<span class="line"><span style="color: #000000">);</span></span></code></pre></div><p>Once we have that function and check constraint in place, we can safely replace the function definition without recreating the constraint:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create or replace</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">roles_check_func</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #E6E6E6">    _record record</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">returns</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">boolean</span></span>
<span class="line"><span style="color: #569CD6">language</span><span style="color: #E6E6E6"> plpgsql</span></span>
<span class="line"><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">$$</span></span>
<span class="line"><span style="color: #569CD6">begin</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">-- Some complicated logic here, branching, loops, and all, this is just an example.</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">return</span><span style="color: #E6E6E6"> _record.roles </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">@ </span><span style="color: #569CD6">array</span><span style="color: #E6E6E6">['xxx', 'yyy', 'zzz'];</span></span>
<span class="line"><span style="color: #569CD6">end</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">$$;</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create or replace</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">roles_check_func</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">    _record record</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">returns</span><span style="color: #000000"> </span><span style="color: #0000FF">boolean</span></span>
<span class="line"><span style="color: #0000FF">language</span><span style="color: #000000"> plpgsql</span></span>
<span class="line"><span style="color: #0000FF">as</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">$$</span></span>
<span class="line"><span style="color: #0000FF">begin</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">-- Some complicated logic here, branching, loops, and all, this is just an example.</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> _record.roles &lt;@ </span><span style="color: #0000FF">array</span><span style="color: #000000">['xxx', 'yyy', 'zzz'];</span></span>
<span class="line"><span style="color: #0000FF">end</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">$$;</span></span></code></pre></div><p>This will act like using the <code>not valid</code> option when recreating the constraint, meaning:</p><ul><li>No long table scans.</li><li>No table locking.</li></ul><p>While, at the same time offers a powerful programming model to implement complex business logic for our data.</p><h2 id="other-usages">Other Usages</h2><p>Arrays are not just useful in these scenarios when we have just a few immutable value combinations that the field can have. They are also extremely useful in data projections with <code>select</code> queries, for example as aggregates.</p><p>Consider the denormalized example from the start of this article (which is very common):</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">users</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">generated</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">always</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">identity</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">unique</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">roles</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    role_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">generated</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">always</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">identity</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">name</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">text</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">unique</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">create</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">table</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">users_roles</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #E6E6E6">    user_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> users,</span></span>
<span class="line"><span style="color: #E6E6E6">    role_id </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">not null</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">references</span><span style="color: #E6E6E6"> roles,</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">primary key</span><span style="color: #E6E6E6"> (user_id, role_id)</span></span>
<span class="line"><span style="color: #E6E6E6">);</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">users</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    user_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000"> </span><span style="color: #0000FF">generated</span><span style="color: #000000"> </span><span style="color: #0000FF">always</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">identity</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">unique</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">roles</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    role_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">primary key</span><span style="color: #000000"> </span><span style="color: #0000FF">generated</span><span style="color: #000000"> </span><span style="color: #0000FF">always</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">identity</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">name</span><span style="color: #000000"> </span><span style="color: #0000FF">text</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">unique</span></span>
<span class="line"><span style="color: #000000">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">create</span><span style="color: #000000"> </span><span style="color: #0000FF">table</span><span style="color: #000000"> </span><span style="color: #795E26">users_roles</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    user_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">references</span><span style="color: #000000"> users,</span></span>
<span class="line"><span style="color: #000000">    role_id </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #0000FF">not null</span><span style="color: #000000"> </span><span style="color: #0000FF">references</span><span style="color: #000000"> roles,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">primary key</span><span style="color: #000000"> (user_id, role_id)</span></span>
<span class="line"><span style="color: #000000">);</span></span></code></pre></div><p>Now, we would like to retrieve a user with id 1, and all roles for that user. We can do something like this:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    u.user_id, u.name, r.name </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">role</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    users u </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">join</span><span style="color: #E6E6E6"> users_roles ur </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6">(user_id)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">join</span><span style="color: #E6E6E6"> roles r </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6">(role_id)</span></span>
<span class="line"><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    u.user_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    u.user_id, u.name, r.name </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">role</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    users u </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">join</span><span style="color: #000000"> users_roles ur </span><span style="color: #0000FF">using</span><span style="color: #000000">(user_id)</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">join</span><span style="color: #000000"> roles r </span><span style="color: #0000FF">using</span><span style="color: #000000">(role_id)</span></span>
<span class="line"><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    u.user_id = </span><span style="color: #098658">1</span></span></code></pre></div><p>The result would be:</p><table class="table table-sm table-hover table-bordered ms-0 mb-5" style="width: initial;"><thead><tr><th><code>user_id</code></th><th><code>name</code></th><th><code>role</code></th></tr></thead><tbody class="table-group-divider"><tr><td>1</td><td>Bob</td><td>admin</td></tr><tr><td>1</td><td>Bob</td><td>reader</td></tr><tr><td>1</td><td>Bob</td><td>writer</td></tr><tr><td>1</td><td>Bob</td><td>user</td></tr><tr><td>1</td><td>Bob</td><td>guest</td></tr></tbody></table><p>Obviously, we now have a redundancy in our projection and the client has to compensate for that fact.</p><p>Either that or, issue two separate queries, which is still a very suboptimal solution (much more code and a higher latency).</p><p>On PostgreSQL, we can group by <code>user_id</code> and <code>name</code> and then aggregate roles into array projection:</p><div class="code sql"><div class="toolbar"><div class="copy-code bi-clipboard" data-bs-toggle="tooltip" data-bs-title="Copy code to clipboard"></div><div class="photo-code bi-camera" data-bs-toggle="tooltip" data-bs-title="Copy code image to clipboard"></div></div><pre class="shiki slack-dark" style="background-color: #222222" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #569CD6">select</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    u.user_id, u.name, array_agg(r.name) </span><span style="color: #569CD6">as</span><span style="color: #E6E6E6"> roles</span></span>
<span class="line"><span style="color: #569CD6">from</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    users u </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">join</span><span style="color: #E6E6E6"> users_roles ur </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6">(user_id)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">join</span><span style="color: #E6E6E6"> roles r </span><span style="color: #569CD6">using</span><span style="color: #E6E6E6">(role_id)</span></span>
<span class="line"><span style="color: #569CD6">where</span><span style="color: #E6E6E6"> </span></span>
<span class="line"><span style="color: #E6E6E6">    u.user_id </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #569CD6">group by</span></span>
<span class="line"><span style="color: #E6E6E6">    u.user_id, u.name</span></span></code></pre><pre class="shiki light-plus" style="background-color: #FFFFFF" tabindex="0"><code class="code-highlight"><span class="line"><span style="color: #0000FF">select</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    u.user_id, u.name, array_agg(r.name) </span><span style="color: #0000FF">as</span><span style="color: #000000"> roles</span></span>
<span class="line"><span style="color: #0000FF">from</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    users u </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">join</span><span style="color: #000000"> users_roles ur </span><span style="color: #0000FF">using</span><span style="color: #000000">(user_id)</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">join</span><span style="color: #000000"> roles r </span><span style="color: #0000FF">using</span><span style="color: #000000">(role_id)</span></span>
<span class="line"><span style="color: #0000FF">where</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    u.user_id = </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">group by</span></span>
<span class="line"><span style="color: #000000">    u.user_id, u.name</span></span></code></pre></div><p>See more on array aggregates in the PostgreSQL <a href="https://www.postgresql.org/docs/9.5/functions-aggregate.html">aggregates documentation reference</a>.</p><p>The result of this query is, basically, the same as the previous one but only in a normalized structure without redundancy where roles are aggregated into the array:</p><table class="table table-sm table-hover table-bordered ms-0 mb-5" style="width: initial;"><thead><tr><th><code>user_id</code></th><th><code>name</code></th><th><code>roles</code></th></tr></thead><tbody class="table-group-divider"><tr><td>1</td><td>Bob</td><td><code>["admin", "reader", "writer", "user", "guest"]</code></td></tr></tbody></table><p>This aggregated array is usually represented as a standard memory structure on the client such as an array or a list. In C# that would be a string array and in Python that would be a string list.</p><p>So that means that clients will try to fit them into memory and we have to have that fact in mind and not return too much data in array types.</p><h2 id="conclusion">Conclusion</h2><p>Arrays are an extremely powerful data type in PostgreSQL, but they do come with a price.</p><p>Doing operations with the array type will mean that PostgreSQL will try to fit them in memory (os select for example), As such they are not suitable for bigger structures.</p><p>But for smaller datasets, such as in this example - they can be a powerful ally that can simplify the data model and programming model as well.</p><p>Whatsomore, data contained in arrays is not normalized. In case we would need to do a data update we would still suffer from update anomaly. For example, changing the name from <code>admin</code> to <code>administrator</code> would be a complicated and costly operation, at least compared to a fully normalized structure like the example at the beginning of this article.</p><p>Still, there are cases when doing data denormalization by using arrays can incredibly simplify design, and programming models and boost performance. The rule of thumb is when the dataset is fairly small like an example with a few roles in this example and there dataset is immutable. This is precisely this role example, but the may be others in real life. PostgreSQL offers the tools and data types to do exactly that - simplify design, simplify programming models and boost performance.</p><div class="text-muted text-center fs-_7rem mb-2">MORE PostgreSql Articles</div><div class="d-flex justify-content-center row"><a class="btn btn-sm text-start sidebar-link me-1" href="/blog/postgresql-temporal-tables/"><span class="">Custom Temporal Tables in PostgreSQL</span> </a><a class="btn btn-sm text-start sidebar-link me-1" href="/blog/recursion-postgresql/part1-different-type-of-recursion/"><span class="">Recursion with PostgreSQL Part 1 - A Different Type of Recursion</span> </a><a class="btn btn-sm text-start sidebar-link me-1" href="/blog/recursion-postgresql/part2-performances/"><span class="">Recursion with PostgreSQL Part 2 - Performances</span> </a><a class="btn btn-sm text-start sidebar-link me-1" href="/blog/recursion-postgresql/part3-cycle-detection/"><span class="">Recursion with PostgreSQL Part 3 - Cycle Detection</span> </a><a class="btn btn-sm text-start sidebar-link me-1" href="/blog/recursion-postgresql/part4-right-path/"><span class="">Recursion with PostgreSQL Part 4 - Finding the Right Path</span> </a><a class="btn btn-sm text-start sidebar-link me-1" href="/blog/postgresql-record-type/"><span class="">Execute Custom Function For Each Record</span></a></div><div class="w-fit mx-auto mt-5 mb-3 border-top"><div class="alert text-center fs-smaller text-muted">To receive notifications about new posts and updates, consider subscribing to my LinkdIn page:<br><a class="btn btn-sm" href="https://www.linkedin.com/in/vb-software/"><i class="bi-linkedin"></i> <span class="text-primary">vb-software linkedin</span></a><br><br>You will receive notifications about new posts on your LinkedIn feed.</div></div><div class="pt-5 border-top"><div id="comments-section" class="h5">Comments</div><script defer src="https://cdn.commento.io/js/commento.js" data-no-fonts="true" data-css-override="https://vb-consulting.github.io/style.css"></script><div id="commento"></div></div><footer class="mt-3 py-5"><div class="w-fit mx-auto mb-3 border-top border-bottom"><div class="alert text-center fs-smaller text-muted"><div class="alert text-center fs-smaller text-muted mb-1">If you like my content, use my software, or otherwise benefit from my work, consider supporting me by buying me a coffee. The software runs on coffee after all.</div><a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="Click Here to Buy Me a Coffee Or Scan the Code" href="https://www.buymeacoffee.com/vbilopavu" style="display: inline-grid;">Buy me a Coffee <img class="m-auto svelte-byttq0" alt="Scan Here To Buy Me a Cofee" src="/bmc_qr.png"></a></div></div><div class="d-flex justify-content-center"><a class="btn rl-arrow" target="_blank" data-bs-toggle="tooltip" data-bs-html="true" title="I Post Software Development Content Daily" href="https://www.linkedin.com/in/vb-software/" style="display: inline-grid;">Follow me on LinkedIn <i class="bi bi-linkedin"></i></a></div><div class="text-center"><div class="mt-5 mb-5 background-floki svelte-byttq0" data-bs-toggle="tooltip" data-bs-html="true" title="Floki is a developer dog."></div></div></footer><div class="mb-5"></div></div></div><div class="rightside svelte-9zwk14"><div class="svelte-9zwk14"><ul class="navbar-nav sidenav svelte-9zwk14"><li class="nav-txt-divider text-muted svelte-9zwk14"><hr class="svelte-9zwk14"><span class="svelte-9zwk14">on this page</span><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="postgresql-arrays-" title="PostgreSQL Arrays üêò"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#postgresql-arrays-">PostgreSQL Arrays üêò</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="many-to-many" title="Many-To-Many"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#many-to-many">Many-To-Many</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="postgresql-way" title="PostgreSQL Way"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#postgresql-way">PostgreSQL Way</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="changing-the-rules" title="Changing The Rules"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#changing-the-rules">Changing The Rules</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="advanced-scenarios" title="Advanced Scenarios"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#advanced-scenarios">Advanced Scenarios</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="other-usages" title="Other Usages"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#other-usages">Other Usages</a></li><li class="nav-item toc2 right svelte-9zwk14 bookmark-nav" data-id="conclusion" title="Conclusion"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#conclusion">Conclusion</a></li><li class="nav-divider svelte-9zwk14"><hr class="svelte-9zwk14"></li><li class="nav-item toc1 right svelte-9zwk14 bookmark-nav" data-id="comments-section" title="Comments"><a class="nav-link auto-close svelte-9zwk14 bookmark-link" href="#comments-section">Comments</a></li><li><hr class="svelte-9zwk14"><div class="text-muted fs-_7rem mx-2">MORE PostgreSql Articles</div><div class="navbar-nav sidenav"><a class="btn btn-sm text-start sidebar-link" href="/blog/postgresql-temporal-tables/"><span class="svelte-9zwk14">Custom Temporal Tables in PostgreSQL</span></a></div><div class="navbar-nav sidenav"><a class="btn btn-sm text-start sidebar-link" href="/blog/recursion-postgresql/part1-different-type-of-recursion/"><span class="svelte-9zwk14">Recursion with PostgreSQL Part 1 - A Different Type of Recursion</span></a></div><div class="navbar-nav sidenav"><a class="btn btn-sm text-start sidebar-link" href="/blog/recursion-postgresql/part2-performances/"><span class="svelte-9zwk14">Recursion with PostgreSQL Part 2 - Performances</span></a></div><div class="navbar-nav sidenav"><a class="btn btn-sm text-start sidebar-link" href="/blog/recursion-postgresql/part3-cycle-detection/"><span class="svelte-9zwk14">Recursion with PostgreSQL Part 3 - Cycle Detection</span></a></div><div class="navbar-nav sidenav"><a class="btn btn-sm text-start sidebar-link" href="/blog/recursion-postgresql/part4-right-path/"><span class="svelte-9zwk14">Recursion with PostgreSQL Part 4 - Finding the Right Path</span></a></div><div class="navbar-nav sidenav"><a class="btn btn-sm text-start sidebar-link" href="/blog/postgresql-record-type/"><span class="svelte-9zwk14">Execute Custom Function For Each Record</span></a></div></li></ul></div></div></main><script>!function(){var i=document.querySelector("nav.navbar"),f=document.getElementsByTagName("main")[0],L=f.getElementsByClassName("sidebar")[0],w=f.getElementsByClassName("content")[0],o=document.querySelectorAll("div.code"),k=i.querySelector(".home");function E(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n])}function T(e,t){for(var n=1;n<arguments.length;n++)e.classList.remove(arguments[n]);E(e,t),e.classList.add(t)}function t(e,t){var n=e.currentTarget;if(!n.classList.contains("bi-check")){for(var i="",o=0;o<n.classList.length;o++)if(n.classList[o].startsWith("bi-")){i=n.classList[o];break}n.classList.remove(i),n.classList.add("spinner-border-sm"),n.classList.add("spinner-border");e=bootstrap.Tooltip.getInstance(n);e&&(e.setContent({".tooltip-inner":"Copying..."}),e.show()),t(n,function(){var e;n.classList.remove(i),n.classList.remove("spinner-border-sm"),n.classList.remove("spinner-border"),n.classList.add("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&(e.setContent({".tooltip-inner":"Copied!"}),e.show()),setTimeout(function(){var e;n.classList.add(i),n.classList.remove("bi-check"),bootstrap&&(e=bootstrap.Tooltip.getInstance(n))&&e.setContent({".tooltip-inner":n.dataset.bsTitle})},2e3)})}}"/"==document.location.pathname&&T(k,"d-none");var e=document.querySelector(".post-share > .copy-url"),n=(e&&e.addEventListener("click",function(e){t(e,function(e,t){navigator.clipboard.writeText(document.location.origin+document.location.pathname),t()})}),document.getElementsByTagName("html")[0]),a=i.querySelector("#theme-btn"),s="theme";function l(e){var t=a.getElementsByTagName("svg");"dark"===e?(t[0].style.display="",t[1].style.display="none",a.getElementsByClassName("check")[0].classList.add("checked")):(t[0].style.display="none",t[1].style.display="",a.getElementsByClassName("check")[0].classList.remove("checked"));for(var n=0;n<o.length;n++){var i=o[n];"dark"===e?(i.children[1].style.display="inherit",i.children[2].style.display="none"):"light"===e&&(i.children[1].style.display="none",i.children[2].style.display="inherit")}window._theme&&window._theme(e)}function r(e){t(e,function(e,t){navigator.clipboard.writeText(e.parentElement.nextSibling.innerText),t()})}function c(e){t(e,function(e,t){var n=localStorage.getItem(s);e="dark"===n?e.parentElement.parentElement.children[1]:e.parentElement.parentElement.children[2],setTimeout(function(){html2canvas(e).then(e=>{e.toBlob(e=>navigator.clipboard.write([new ClipboardItem({"image/png":e})])),t()})},0)})}a.addEventListener("click",()=>{var e="dark"===localStorage.getItem(s)?"light":"dark";localStorage.setItem(s,e),l(n.dataset.bsTheme=e)}),l(localStorage.getItem(s)),a.children[0].classList.remove("hidden");for(var d=0;d<o.length;d++){o[d].getElementsByClassName("copy-code")[0].addEventListener("click",r);var m=o[d].getElementsByClassName("photo-code");m.length&&m[0].addEventListener("click",c)}for(var S=function(){var a,o,s;if(f.children[2]&&"none"!=f.children[2].style.display)return a=f.querySelector(".main-content").querySelectorAll("[id]"),o=void 0,this.initNavs=function(e){s=e.querySelectorAll("li.bookmark-nav");for(var t=0;t<a.length;t++){for(var n=a[t].id,i=null,o=0;o<s.length;o++)if(s[o].dataset.id==n){i=s[o];break}a[t].nav=i}setTimeout(function(){for(var e=0;e<a.length;e++){var t=a[e];if(l(t).visible&&t.nav)return void t.nav.classList.add("active")}},1e3),r()},f.children[1].addEventListener("scroll",r),this;function l(e){var e=e.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight),n=0<e.top&&!(e.bottom<0||0<=e.top-t)||e.top<0&&e.bottom>t,i=!1;return{visible:n,above:i=n?i:e.bottom<t}}function r(){if(s&&s.length){for(var e=0;e<s.length;e++)s[e].classList.remove("active");for(var t=void 0,e=0;e<a.length;e++){const i=a[e];var n=l(i);if(!n.visible&&n.above&&(t=i.nav),n.visible&&i.nav&&!i.nav.classList.contains("active"))return i.nav.classList.add("active"),o&&clearTimeout(o),void(o=setTimeout(function(){i.nav.scrollIntoView({behavior:"smooth"}),o=void 0},250))}t&&!t.classList.contains("active")&&(t.classList.add("active"),o&&clearTimeout(o),o=setTimeout(function(){t.scrollIntoView({behavior:"smooth"}),o=void 0},250))}}}(),h=function(){var l,r=i.querySelector("#nav-btn"),c=480,d="200px",m="0.25fr",h=730,v=535,u=f.children[0].children[0].children[0],g=f.children[2]&&f.children[2].children[0].children[0],t="sidebar-pinned",p=null==localStorage.getItem(t)||"true"==localStorage.getItem(t),y=!1,b=!1;function n(){window._onresize&&window._onresize();var e=window.outerWidth||window.innerWidth,t=e<c,n=t?y?"100%":"0":p?""+d:"0",i=`grid-template-columns: ${n} 1fr`,o=t&&y?"width: 100%":"0"!=n?"":"display: none",a=t&&y?"display: none":"",s=t?y?"sidebar-show":"sidebar-hide":p?"sidebar-show":"sidebar-hide",n="0"==n;f.children[2]&&(m&&h&&v&&(n&&e<v||!n&&e<h?b||(u.innerHTML=l+g.innerHTML,S.initNavs(u),b=!0):b&&(u.innerHTML=l,S.initNavs(g),b=!1)),!m||t||b?(i+=";",f.children[2].style.display="none"):(i+=` ${m};`,f.children[2].style.display="")),T(r,!t&&p||t&&y?"rotate":"rotate-back","rotate","rotate-back"),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),f.style=L?i:"display: grid;",L&&T(L,s,"sidebar-show","sidebar-hide"),L&&(L.firstChild.style=o),w.style=a,t&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),t&&y&&T(k,"d-none")}function e(){var e=window.outerWidth<c;e?y=!y:p=!p,localStorage.setItem(t,p.toString()),n(),p?(r.classList.add("text-shadow"),null==document.querySelector("main .sidebar .accordion > [title='VB-Consulting'] > .collapsed")&&T(k,"d-none")):("/"!=document.location.pathname&&E(k,"d-none"),r.classList.remove("text-shadow")),e&&!y&&"/"!=document.location.pathname&&E(k,"d-none"),e&&y&&T(k,"d-none")}return m&&h&&v&&g&&(l=u.innerHTML,S.initNavs(g)),r.addEventListener("click",e),(window.onresize=n)(),this.closeSidebar=function(){window.outerWidth<c&&y&&e()},this}(),v=document.getElementsByClassName("auto-close"),u=0;u<v.length;u++)v[u].addEventListener("click",function(e){h.closeSidebar()});location.hash&&(e=document.getElementById(location.hash.replace("#","")))&&e.scrollIntoView()}();</script><script src="/bootstrap.bundle.min.js"></script><script>!function(){for(var e=document.querySelectorAll('[data-bs-toggle="tooltip"]'),t=0;t<e.length;t++)new bootstrap.Tooltip(e[t]);var n=document.getElementsByClassName("accordion-item");if(n.length){for(t=0;t<n.length;t++){var o=n[t];o.querySelectorAll("[href='"+document.location.pathname+"']").length&&o.firstChild.click()}var l=document.querySelector("nav.navbar").querySelector(".home"),a=document.getElementsByClassName("accordion");"/"==document.location.pathname&&l.classList.add("d-none");for(t=0;t<n.length;t++){var s=a[t];s&&s.firstChild&&"VB-Consulting"==s.firstChild.title&&(null!=s.firstChild.querySelector(".collapse")&&l.classList.contains("d-none")&&"/"!=document.location.pathname&&l.classList.remove("d-none"),s.addEventListener("show.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none"),l.classList.add("d-none")}),s.addEventListener("hide.bs.collapse",function(){"/"!=document.location.pathname&&l.classList.remove("d-none")}))}}}();</script><script src="/html2canvas.min.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script></body><script async data-id="101435862" src="//static.getclicky.com/js"></script></html>